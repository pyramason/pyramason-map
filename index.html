<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ancient Mystery Sites Map - Pyramason</title>
    <meta name="description" content="Interactive map of 50,000+ ancient pyramids, megaliths, and sacred sites worldwide">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #333; }
        .map-container { position: relative; width: 100%; height: 100vh; }
        #map { width: 100%; height: 100%; }
        .control-panel { position: absolute; top: 15px; left: 15px; background: rgba(255,255,255,0.98); backdrop-filter: blur(10px); padding: 10px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.25); border: 1px solid rgba(212,175,55,0.4); width: 140px; z-index: 1000; }
        .control-panel h2 { font-size: 10px; margin-bottom: 8px; color: #d4af37; font-weight: 700; text-align: center; border-bottom: 1px solid rgba(212,175,55,0.3); padding-bottom: 6px; }
        .filter-group { margin-bottom: 8px; }
        .filter-group-title { font-size: 8px; color: #999; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; margin-bottom: 4px; }
        .checkbox-item { display: flex; align-items: center; margin-bottom: 3px; cursor: pointer; padding: 2px; border-radius: 3px; transition: background 0.2s; }
        .checkbox-item:hover { background: rgba(212,175,55,0.08); }
        .checkbox-item input[type="checkbox"] { margin-right: 4px; cursor: pointer; width: 11px; height: 11px; accent-color: #d4af37; }
        .checkbox-item label { cursor: pointer; user-select: none; flex: 1; font-size: 9px; font-weight: 500; color: #333; }
        .marker-count { color: #d4af37; font-size: 7px; font-weight: 700; padding: 1px 3px; background: rgba(212,175,55,0.12); border-radius: 4px; }
        .top-toolbar { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.98); backdrop-filter: blur(10px); padding: 8px 12px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.25); border: 1px solid rgba(212,175,55,0.4); z-index: 1000; display: flex; gap: 8px; align-items: center; }
        .toolbar-btn { background: white; border: 1px solid #ddd; border-radius: 5px; padding: 7px 12px; cursor: pointer; font-size: 10px; font-weight: 600; color: #333; transition: all 0.2s; display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        .toolbar-btn:hover { background: #f5f5f5; border-color: #d4af37; transform: translateY(-1px); }
        .toolbar-btn.icon-only { padding: 7px 10px; }
        #searchInput { padding: 7px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 11px; width: 200px; outline: none; transition: all 0.2s; }
        #searchInput:focus { border-color: #d4af37; box-shadow: 0 0 0 2px rgba(212,175,55,0.1); }
        .map-controls { position: absolute; top: 15px; right: 60px; background: rgba(255,255,255,0.98); backdrop-filter: blur(10px); padding: 6px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.25); border: 1px solid rgba(212,175,55,0.4); z-index: 1000; display: flex; flex-direction: column; gap: 5px; }
        .control-btn { background: white; border: 1px solid #ddd; border-radius: 4px; padding: 5px 8px; cursor: pointer; font-size: 10px; font-weight: 600; color: #333; transition: all 0.2s; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        .control-btn:hover { background: #f5f5f5; border-color: #d4af37; }
        .control-btn.active { background: #d4af37; color: white; border-color: #d4af37; }
        
        /* Context Menu Styles - IMPROVED */
        .context-menu { 
            position: fixed; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
            border: 1px solid #ddd; 
            padding: 8px 0; 
            z-index: 9999; 
            display: none; 
            min-width: 220px; 
            max-height: 80vh; 
            overflow-y: auto; 
        }
        .context-coords { 
            padding: 8px 14px; 
            font-size: 10px; 
            color: #d4af37; 
            font-weight: 700; 
            background: rgba(212,175,55,0.08); 
            border-bottom: 1px solid #e0e0e0; 
            font-family: 'Courier New', monospace;
            cursor: pointer;
            user-select: all;
        }
        .context-coords:hover {
            background: rgba(212,175,55,0.15);
        }
        .context-menu-item { 
            padding: 8px 14px; 
            cursor: pointer; 
            font-size: 11px; 
            color: #333; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            transition: background 0.2s; 
        }
        .context-menu-item:hover { 
            background: rgba(212,175,55,0.1); 
        }
        .context-menu-divider { 
            height: 1px; 
            background: #e0e0e0; 
            margin: 4px 0; 
        }
        .context-section-label { 
            padding: 6px 14px; 
            font-size: 8px; 
            color: #999; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            font-weight: 700; 
        }
        
        .panel { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.4); width: 450px; max-height: 500px; z-index: 1500; display: none; flex-direction: column; }
        .panel-header { padding: 12px 16px; background: linear-gradient(135deg, #d4af37 0%, #c19a2b 100%); color: white; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .panel-header h3 { font-size: 14px; font-weight: 700; }
        .close-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 3px; transition: background 0.2s; }
        .close-btn:hover { background: rgba(255,255,255,0.2); }
        .panel-content { padding: 16px; overflow-y: auto; max-height: 430px; }
        .tool-section { margin-bottom: 20px; }
        .tool-section h4 { font-size: 12px; color: #d4af37; margin-bottom: 10px; border-bottom: 1px solid #e0e0e0; padding-bottom: 6px; }
        .tool-item { padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; background: white; }
        .tool-item:hover { background: rgba(212,175,55,0.05); border-color: #d4af37; }
        .tool-item h5 { font-size: 11px; color: #333; margin-bottom: 4px; }
        .tool-item p { font-size: 9px; color: #666; margin: 0; }
        .tool-result { margin-top: 12px; padding: 12px; background: rgba(212,175,55,0.05); border-radius: 6px; border: 1px solid rgba(212,175,55,0.2); }
        .tool-result h5 { font-size: 11px; color: #d4af37; margin-bottom: 8px; }
        .tool-result-item { font-size: 10px; color: #333; padding: 4px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .favorite-item { padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .favorite-item:hover { background: rgba(212,175,55,0.05); border-color: #d4af37; transform: translateX(2px); }
        .favorite-item h4 { font-size: 12px; color: #d4af37; margin-bottom: 4px; }
        .favorite-item p { font-size: 10px; color: #666; margin: 0; }
        .no-content { text-align: center; padding: 40px 20px; color: #999; }
        .stats-bar { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.98); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.25); border: 1px solid rgba(212,175,55,0.4); z-index: 1000; display: flex; gap: 20px; }
        .stat-item { text-align: center; }
        .stat-number { font-size: 18px; font-weight: 700; color: #d4af37; }
        .stat-label { font-size: 8px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-top: 2px; }
        .custom-info { max-width: 320px; padding: 5px; }
        .custom-info h3 { margin: 0 0 8px 0; color: #d4af37; font-size: 15px; font-weight: 700; }
        .custom-info p { margin: 4px 0; font-size: 12px; line-height: 1.5; color: #333; }
        .category-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 6px; font-weight: 700; }
        .badge-ancient { background: #4FC3F7; color: #000; }
        .badge-megalith { background: #BA68C8; color: #fff; }
        .info-actions { display: flex; gap: 6px; margin-top: 10px; padding-top: 8px; border-top: 1px solid #e0e0e0; flex-wrap: wrap; }
        .info-btn { flex: 1; min-width: 80px; background: #d4af37; color: white; border: none; border-radius: 4px; padding: 6px 8px; font-size: 9px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 3px; }
        .info-btn:hover { background: #c19a2b; transform: translateY(-1px); }
        .info-btn.favorite { background: #FF6B6B; }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.97); padding: 25px 40px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); z-index: 2000; text-align: center; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(212,175,55,0.2); border-top-color: #d4af37; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #666; font-weight: 600; font-size: 13px; }
        .context-menu::-webkit-scrollbar, .panel-content::-webkit-scrollbar { width: 4px; }
        .context-menu::-webkit-scrollbar-track, .panel-content::-webkit-scrollbar-track { background: rgba(0,0,0,0.03); }
        .context-menu::-webkit-scrollbar-thumb, .panel-content::-webkit-scrollbar-thumb { background: rgba(212,175,55,0.3); border-radius: 2px; }
    </style>
</head>
<body>
    <div class="map-container">
        <div id="map"></div>
        <div class="control-panel">
            <h2>üó∫Ô∏è Layers</h2>
            <div class="filter-group">
                <div class="filter-group-title">Pyramids</div>
                <div class="checkbox-item"><input type="checkbox" id="filter-pyramids" checked><label for="filter-pyramids">üî∫ All</label><span class="marker-count" id="count-pyramids">0</span></div>
            </div>
            <div class="filter-group">
                <div class="filter-group-title">Megaliths</div>
                <div class="checkbox-item"><input type="checkbox" id="filter-standing-stones"><label for="filter-standing-stones">‚¨¢ Stones</label><span class="marker-count" id="count-standing-stones">0</span></div>
                <div class="checkbox-item"><input type="checkbox" id="filter-burials"><label for="filter-burials">‚ö±Ô∏è Burials</label><span class="marker-count" id="count-burials">0</span></div>
                <div class="checkbox-item"><input type="checkbox" id="filter-rock-art"><label for="filter-rock-art">üé® Art</label><span class="marker-count" id="count-rock-art">0</span></div>
                <div class="checkbox-item"><input type="checkbox" id="filter-settlements"><label for="filter-settlements">üèõÔ∏è Settl.</label><span class="marker-count" id="count-settlements">0</span></div>
            </div>
        </div>
        <div class="top-toolbar">
            <input type="text" id="searchInput" placeholder="üîç Search places..."/>
            <button class="toolbar-btn icon-only" onclick="searchPlace()" title="Search"><span>üîç</span></button>
            <button class="toolbar-btn" onclick="toggleTools()"><span>üìê</span><span>Tools</span></button>
            <button class="toolbar-btn" onclick="toggleFavorites()"><span>‚ù§Ô∏è</span><span>Favorites (<span id="fav-count">0</span>)</span></button>
            <button class="toolbar-btn" onclick="resetMapView()"><span>üè†</span><span>Reset</span></button>
        </div>
        <div class="map-controls">
            <button class="control-btn" onclick="toggleMapType()"><span>üõ∞Ô∏è</span><span id="map-type-label">Satellite</span></button>
            <button class="control-btn active" id="btn-labels" onclick="toggleLabels()"><span>üè∑Ô∏è</span><span>Labels</span></button>
            <button class="control-btn" onclick="toggleTerrain()"><span>üèîÔ∏è</span><span>Terrain</span></button>
        </div>
        
        <!-- IMPROVED CONTEXT MENU -->
        <div class="context-menu" id="contextMenu">
            <div class="context-coords" id="contextCoords" title="Click to copy coordinates">Lat: 0.0000, Lng: 0.0000</div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item" onclick="copyCoordinates()"><span>üìã</span><span>Copy Coordinates</span></div>
            <div class="context-menu-item" onclick="openStreetViewHere()"><span>üëÅÔ∏è</span><span>Street View Here</span></div>
            <div class="context-menu-divider"></div>
            <div class="context-section-label">üìè Measurements</div>
            <div class="context-menu-item" onclick="startMeasureDistance()"><span>üìè</span><span>Measure Distance</span></div>
            <div class="context-menu-item" onclick="startMeasureArea()"><span>‚ñ≠</span><span>Measure Area</span></div>
            <div class="context-menu-item" onclick="startMeasureAngle()"><span>üìê</span><span>Measure Angle</span></div>
            <div class="context-menu-item" onclick="startBearing()"><span>üß≠</span><span>Bearing/Azimuth</span></div>
            <div class="context-menu-divider"></div>
            <div class="context-section-label">‚úèÔ∏è Drawing Tools</div>
            <div class="context-menu-item" onclick="startDrawingLine()"><span>‚îÅ</span><span>Draw Line</span></div>
            <div class="context-menu-item" onclick="drawCircleHere()"><span>‚≠ï</span><span>Draw Circle</span></div>
            <div class="context-menu-item" onclick="startPolygonHere()"><span>‚¨°</span><span>Draw Polygon</span></div>
            <div class="context-menu-item" onclick="addMarkerHere()"><span>üìç</span><span>Add Marker</span></div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item" onclick="clearAll()"><span>üóëÔ∏è</span><span>Clear All Drawings</span></div>
        </div>
        
        <div class="panel" id="toolsPanel">
            <div class="panel-header"><h3>üî¨ Sacred Geometry & Analysis</h3><button class="close-btn" onclick="toggleTools()">√ó</button></div>
            <div class="panel-content">
                <div class="tool-section">
                    <h4>‚öõÔ∏è Sacred Geometry Detection</h4>
                    <div class="tool-item" onclick="detectEquilateralTriangles()"><h5>‚ñ≥ Equilateral Triangles</h5><p>Find groups of 3 sites forming perfect triangles</p></div>
                    <div class="tool-item" onclick="detectGoldenRatio()"><h5>œÜ Golden Ratio (1.618)</h5><p>Identify site pairs with golden ratio distances</p></div>
                    <div class="tool-item" onclick="detectCircularPatterns()"><h5>‚≠ï Circular Patterns</h5><p>Find sites arranged in circular formations (4+ sites)</p></div>
                    <div class="tool-item" onclick="detectAlignments()"><h5>‚îÅ Linear Alignments</h5><p>Find 3+ sites in perfect alignment</p></div>
                    <div class="tool-item" onclick="detectPythagorean()"><h5>‚ñ≤ Pythagorean Triangles</h5><p>Find triangles with integer ratios (3:4:5, etc.)</p></div>
                </div>
                <div id="toolResults" class="tool-result" style="display:none;"><h5>üìä Results</h5><div id="toolResultsContent"></div></div>
            </div>
        </div>
        <div class="panel" id="favoritesPanel" style="width:400px;">
            <div class="panel-header"><h3>‚ù§Ô∏è Favorite Sites</h3><button class="close-btn" onclick="toggleFavorites()">√ó</button></div>
            <div class="panel-content" id="favoritesContent"><div class="no-content"><div style="font-size:40px;margin-bottom:10px;">ü§ç</div><p>No favorites yet.<br>Click ‚ù§Ô∏è on any site to save it.</p></div></div>
        </div>
        <div class="stats-bar">
            <div class="stat-item"><div class="stat-number" id="total-count">0</div><div class="stat-label">Total</div></div>
            <div class="stat-item"><div class="stat-number" id="visible-count">0</div><div class="stat-label">Visible</div></div>
            <div class="stat-item"><div class="stat-number" id="loaded-count">0</div><div class="stat-label">Loaded</div></div>
        </div>
        <div class="loading" id="loading"><div class="loading-spinner"></div><div class="loading-text">Initializing map...</div></div>
    </div>
    <script>
const CONFIG = {
    GOOGLE_MAPS_API_KEY: 'AIzaSyB16lIKUClrBSHvAJZLq584GG4vZUaa3HQ',
    PYRAMIDS_DATA_URL: 'https://cdn.shopify.com/s/files/1/0853/8701/8573/files/pyramids_data.json?v=1762027215',
    MEGALITHS_STANDING_STONES_URL: 'https://cdn.shopify.com/s/files/1/0853/8701/8573/files/megalithic_sites_standing_stones_and_circles.json?v=1762347327',
    MEGALITHS_BURIALS_URL: 'https://cdn.shopify.com/s/files/1/0853/8701/8573/files/megalithic_sites_burials_and_tombs.json?v=1762348072',
    MEGALITHS_ROCK_ART_URL: 'https://cdn.shopify.com/s/files/1/0853/8701/8573/files/megalithic_sites_rock_art_and_carvings.json?v=1762347285',
    MEGALITHS_SETTLEMENTS_URL: 'https://cdn.shopify.com/s/files/1/0853/8701/8573/files/megalithic_sites_settlements_and_other.json?v=1762347305',
    DEFAULT_VIEW: { lat: 29.9792, lng: 31.1342, zoom: 3 }
};

let map, infoWindow, geocoder, markerCluster, contextMenuLatLng;
let markers = [], drawings = [], measurementPoints = [];
let pyramidData = [], megalithData = { 'standing-stones': [], 'burials': [], 'rock-art': [], 'settlements': [] };
let megalithsLoaded = { 'standing-stones': false, 'burials': false, 'rock-art': false, 'settlements': false };
let favorites = [], currentMapType = 'roadmap', labelsEnabled = true, measurementMode = null;

window.initMap = async function() {
    try {
        map = new google.maps.Map(document.getElementById('map'), {
            center: CONFIG.DEFAULT_VIEW,
            zoom: CONFIG.DEFAULT_VIEW.zoom,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            mapTypeControl: false,
            streetViewControl: true,
            streetViewControlOptions: { position: google.maps.ControlPosition.RIGHT_TOP },
            fullscreenControl: true,
            zoomControl: true,
            scaleControl: true
        });
        
        infoWindow = new google.maps.InfoWindow();
        geocoder = new google.maps.Geocoder();
        
        setupContextMenu();
        setupMeasurementListeners();
        loadFavorites();
        
        document.getElementById('searchInput').addEventListener('keypress', e => e.key === 'Enter' && searchPlace());
        
        await loadPyramids();
    } catch (err) {
        showError('Map Failed', err.message);
    }
};

// IMPROVED CONTEXT MENU SETUP
function setupContextMenu() {
    const menu = document.getElementById('contextMenu');
    
    // Right-click listener
    map.addListener('rightclick', (e) => {
        e.stop(); // Prevent default context menu
        
        contextMenuLatLng = e.latLng;
        
        // Update coordinates display
        document.getElementById('contextCoords').textContent = 
            `Lat: ${e.latLng.lat().toFixed(5)}, Lng: ${e.latLng.lng().toFixed(5)}`;
        
        // Position menu using screen coordinates
        menu.style.left = e.domEvent.pageX + 'px';
        menu.style.top = e.domEvent.pageY + 'px';
        menu.style.display = 'block';
    });
    
    // Close menu on left click
    map.addListener('click', () => {
        menu.style.display = 'none';
    });
    
    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
        if (!menu.contains(e.target)) {
            menu.style.display = 'none';
        }
    });
    
    // Prevent menu from closing when clicking inside
    menu.addEventListener('click', (e) => {
        e.stopPropagation();
    });
    
    // Make coordinates clickable to copy
    document.getElementById('contextCoords').addEventListener('click', copyCoordinates);
}

// COORDINATE COPY FUNCTION
function copyCoordinates() {
    if (!contextMenuLatLng) return;
    
    const coords = `${contextMenuLatLng.lat().toFixed(5)}, ${contextMenuLatLng.lng().toFixed(5)}`;
    
    navigator.clipboard.writeText(coords).then(() => {
        // Visual feedback
        const coordsDiv = document.getElementById('contextCoords');
        const originalText = coordsDiv.textContent;
        coordsDiv.textContent = '‚úì Copied!';
        coordsDiv.style.background = 'rgba(76, 175, 80, 0.2)';
        
        setTimeout(() => {
            coordsDiv.textContent = originalText;
            coordsDiv.style.background = 'rgba(212,175,55,0.08)';
        }, 1000);
    }).catch(() => {
        alert(`Coordinates: ${coords}`);
    });
}

function openStreetViewHere() {
    document.getElementById('contextMenu').style.display = 'none';
    map.getStreetView().setPosition(contextMenuLatLng);
    map.getStreetView().setVisible(true);
}

function addMarkerHere() {
    document.getElementById('contextMenu').style.display = 'none';
    const name = prompt('Marker name:', 'Custom Location');
    if (!name) return;
    
    const marker = new google.maps.Marker({
        position: contextMenuLatLng,
        map,
        title: name,
        draggable: true,
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#FF6B6B',
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 2
        }
    });
    
    marker.addListener('click', () => {
        infoWindow.setContent(`<div class="custom-info"><h3>üìç ${name}</h3><p>Custom marker</p><p><strong>Coordinates:</strong> ${marker.getPosition().lat().toFixed(5)}, ${marker.getPosition().lng().toFixed(5)}</p></div>`);
        infoWindow.open(map, marker);
    });
    
    drawings.push(marker);
}

// MEASUREMENT FUNCTIONS
function startMeasureDistance() {
    document.getElementById('contextMenu').style.display = 'none';
    measurementMode = 'distance';
    measurementPoints = [];
    alert('üìè Click 2 points on the map to measure distance');
}

function startMeasureArea() {
    document.getElementById('contextMenu').style.display = 'none';
    measurementMode = 'area';
    measurementPoints = [];
    alert('‚ñ≠ Click points to form a polygon. Double-click to finish and calculate area.');
}

function startMeasureAngle() {
    document.getElementById('contextMenu').style.display = 'none';
    measurementMode = 'angle';
    measurementPoints = [];
    alert('üìê Click 3 points. The middle point will be the vertex of the angle.');
}

function startBearing() {
    document.getElementById('contextMenu').style.display = 'none';
    measurementMode = 'bearing';
    measurementPoints = [];
    alert('üß≠ Click 2 points to calculate bearing/azimuth from first to second point.');
}

// DRAWING FUNCTIONS
function startDrawingLine() {
    document.getElementById('contextMenu').style.display = 'none';
    measurementMode = 'line';
    measurementPoints = [];
    alert('‚îÅ Click 2 points to draw a line');
}

function drawCircleHere() {
    document.getElementById('contextMenu').style.display = 'none';
    const radius = prompt('Enter radius in kilometers:', '50');
    if (!radius || isNaN(radius)) return;
    
    const circle = new google.maps.Circle({
        center: contextMenuLatLng,
        radius: parseFloat(radius) * 1000, // Convert to meters
        fillColor: '#d4af37',
        fillOpacity: 0.2,
        strokeColor: '#d4af37',
        strokeWeight: 2,
        editable: true,
        draggable: true,
        map
    });
    
    drawings.push(circle);
}

function startPolygonHere() {
    document.getElementById('contextMenu').style.display = 'none';
    measurementMode = 'polygon';
    measurementPoints = [contextMenuLatLng];
    alert('‚¨° Click additional points. Double-click to finish polygon.');
}

function clearAll() {
    document.getElementById('contextMenu').style.display = 'none';
    
    if (drawings.length === 0) {
        alert('No drawings to clear!');
        return;
    }
    
    const confirmed = confirm(`üóëÔ∏è Clear ${drawings.length} drawing(s) and measurement(s)?`);
    if (!confirmed) return;
    
    drawings.forEach(d => d.setMap(null));
    drawings = [];
    measurementPoints = [];
    measurementMode = null;
    
    alert('‚úì All drawings cleared!');
}

// MEASUREMENT LISTENERS
function setupMeasurementListeners() {
    map.addListener('click', (e) => {
        if (!measurementMode) return;
        
        measurementPoints.push(e.latLng);
        
        // Add visual marker
        const marker = new google.maps.Marker({
            position: e.latLng,
            map,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 5,
                fillColor: '#d4af37',
                fillOpacity: 1,
                strokeColor: '#fff',
                strokeWeight: 2
            }
        });
        drawings.push(marker);
        
        // Handle different measurement modes
        if (measurementMode === 'distance' && measurementPoints.length === 2) {
            const dist = google.maps.geometry.spherical.computeDistanceBetween(
                measurementPoints[0], measurementPoints[1]
            );
            const line = new google.maps.Polyline({
                path: measurementPoints,
                strokeColor: '#d4af37',
                strokeWeight: 3,
                map
            });
            drawings.push(line);
            alert(`üìè Distance: ${(dist / 1000).toFixed(2)} km (${(dist / 1609.34).toFixed(2)} mi)`);
            measurementMode = null;
            measurementPoints = [];
        } 
        else if (measurementMode === 'line' && measurementPoints.length === 2) {
            const line = new google.maps.Polyline({
                path: measurementPoints,
                strokeColor: '#d4af37',
                strokeWeight: 3,
                map,
                editable: true
            });
            drawings.push(line);
            measurementMode = null;
            measurementPoints = [];
        }
        else if (measurementMode === 'angle' && measurementPoints.length === 3) {
            const b1 = google.maps.geometry.spherical.computeHeading(measurementPoints[1], measurementPoints[0]);
            const b2 = google.maps.geometry.spherical.computeHeading(measurementPoints[1], measurementPoints[2]);
            let angle = Math.abs(b2 - b1);
            if (angle > 180) angle = 360 - angle;
            
            // Draw lines
            const line1 = new google.maps.Polyline({
                path: [measurementPoints[1], measurementPoints[0]],
                strokeColor: '#d4af37',
                strokeWeight: 2,
                map
            });
            const line2 = new google.maps.Polyline({
                path: [measurementPoints[1], measurementPoints[2]],
                strokeColor: '#d4af37',
                strokeWeight: 2,
                map
            });
            drawings.push(line1, line2);
            
            alert(`üìê Angle: ${angle.toFixed(2)}¬∞`);
            measurementMode = null;
            measurementPoints = [];
        }
        else if (measurementMode === 'bearing' && measurementPoints.length === 2) {
            const bearing = google.maps.geometry.spherical.computeHeading(measurementPoints[0], measurementPoints[1]);
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(((bearing + 360) % 360) / 45) % 8;
            
            const line = new google.maps.Polyline({
                path: measurementPoints,
                strokeColor: '#4FC3F7',
                strokeWeight: 3,
                map
            });
            drawings.push(line);
            
            alert(`üß≠ Bearing: ${bearing.toFixed(2)}¬∞ (${directions[index]})\n\nFrom: ${measurementPoints[0].lat().toFixed(5)}, ${measurementPoints[0].lng().toFixed(5)}\nTo: ${measurementPoints[1].lat().toFixed(5)}, ${measurementPoints[1].lng().toFixed(5)}`);
            measurementMode = null;
            measurementPoints = [];
        }
    });
    
    // Handle double-click for polygon/area completion
    map.addListener('dblclick', (e) => {
        if (measurementMode === 'area' && measurementPoints.length >= 3) {
            const polygon = new google.maps.Polygon({
                paths: measurementPoints,
                fillColor: '#d4af37',
                fillOpacity: 0.2,
                strokeColor: '#d4af37',
                strokeWeight: 2,
                map,
                editable: true
            });
            
            const area = google.maps.geometry.spherical.computeArea(polygon.getPath());
            alert(`‚ñ≠ Area: ${(area / 1000000).toFixed(2)} km¬≤ (${(area / 2589988.11).toFixed(2)} mi¬≤)`);
            
            drawings.push(polygon);
            measurementMode = null;
            measurementPoints = [];
        }
        else if (measurementMode === 'polygon' && measurementPoints.length >= 3) {
            const polygon = new google.maps.Polygon({
                paths: measurementPoints,
                fillColor: '#d4af37',
                fillOpacity: 0.2,
                strokeColor: '#d4af37',
                strokeWeight: 2,
                map,
                editable: true
            });
            
            drawings.push(polygon);
            measurementMode = null;
            measurementPoints = [];
        }
    });
}

// REST OF THE ORIGINAL FUNCTIONS (Favorites, Tools, Search, etc.)
function loadFavorites() {
    try {
        favorites = JSON.parse(localStorage.getItem('pyramason_favorites') || '[]');
        updateFavCount();
    } catch (e) {
        favorites = [];
    }
}

function saveFavorites() {
    try {
        localStorage.setItem('pyramason_favorites', JSON.stringify(favorites));
        updateFavCount();
    } catch (e) {}
}

function updateFavCount() {
    document.getElementById('fav-count').textContent = favorites.length;
}

function toggleFavorite(site) {
    const key = `${site.lat}_${site.lng}`;
    const idx = favorites.findIndex(f => f.key === key);
    if (idx > -1) {
        favorites.splice(idx, 1);
        return false;
    } else {
        favorites.push({
            key,
            name: site.name,
            lat: site.lat,
            lng: site.lng,
            country: site.country,
            type: site.mainType
        });
        return true;
    }
}

function isFavorite(site) {
    return favorites.some(f => f.key === `${site.lat}_${site.lng}`);
}

function toggleFavorites() {
    const panel = document.getElementById('favoritesPanel');
    const isOpen = panel.style.display === 'flex';
    panel.style.display = isOpen ? 'none' : 'flex';
    
    if (!isOpen) {
        const content = document.getElementById('favoritesContent');
        if (favorites.length === 0) {
            content.innerHTML = '<div class="no-content"><div style="font-size:40px;margin-bottom:10px;">ü§ç</div><p>No favorites yet.<br>Click ‚ù§Ô∏è on any site to save it.</p></div>';
        } else {
            content.innerHTML = favorites.map(f => 
                `<div class="favorite-item" onclick="goToFavorite(${f.lat},${f.lng})">
                    <h4>${f.name}</h4>
                    <p>${f.country || 'Unknown'} ‚Ä¢ ${f.type || ''}</p>
                    <p style="font-size:9px;color:#999;margin-top:3px;">${f.lat.toFixed(4)}, ${f.lng.toFixed(4)}</p>
                </div>`
            ).join('');
        }
    }
}

function goToFavorite(lat, lng) {
    map.setCenter({ lat, lng });
    map.setZoom(15);
    toggleFavorites();
    
    const marker = markers.find(m => 
        Math.abs(m.getPosition().lat() - lat) < 0.0001 && 
        Math.abs(m.getPosition().lng() - lng) < 0.0001
    );
    if (marker) google.maps.event.trigger(marker, 'click');
}

function toggleTools() {
    const panel = document.getElementById('toolsPanel');
    panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
}

function searchPlace() {
    const query = document.getElementById('searchInput').value.trim();
    if (!query) return alert('Enter a place name');
    
    geocoder.geocode({ address: query }, (results, status) => {
        if (status === 'OK') {
            map.setCenter(results[0].geometry.location);
            map.setZoom(12);
            
            const marker = new google.maps.Marker({
                map,
                position: results[0].geometry.location,
                animation: google.maps.Animation.DROP
            });
            
            infoWindow.setContent(`<div class="custom-info"><h3>üìç ${results[0].formatted_address}</h3></div>`);
            infoWindow.open(map, marker);
            
            setTimeout(() => marker.setMap(null), 5000);
        } else {
            alert('Location not found');
        }
    });
}

function resetMapView() {
    map.setCenter(CONFIG.DEFAULT_VIEW);
    map.setZoom(CONFIG.DEFAULT_VIEW.zoom);
    map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
    currentMapType = 'roadmap';
    document.getElementById('map-type-label').textContent = 'Satellite';
}

async function loadPyramids() {
    try {
        document.getElementById('loading').querySelector('.loading-text').textContent = 'Loading pyramids...';
        const response = await fetch(CONFIG.PYRAMIDS_DATA_URL);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const raw = await response.json();
        let data = Array.isArray(raw) ? raw : (raw.pyramids || raw.sites || raw.data || Object.values(raw).find(v => Array.isArray(v)) || []);
        
        pyramidData = data.filter(s => s && s.lat != null && s.lng != null);
        console.log(`‚úÖ ${pyramidData.length} pyramids loaded`);
        
        createPyramidMarkers();
        updateCounts();
        setupEventListeners();
        
        document.getElementById('loading').style.display = 'none';
    } catch (err) {
        showError('Load Failed', err.message);
    }
}

async function loadMegaliths(category) {
    if (megalithsLoaded[category]) {
        applyFilters();
        return;
    }
    
    try {
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('loading').querySelector('.loading-text').textContent = `Loading ${category}...`;
        
        const urls = {
            'standing-stones': CONFIG.MEGALITHS_STANDING_STONES_URL,
            'burials': CONFIG.MEGALITHS_BURIALS_URL,
            'rock-art': CONFIG.MEGALITHS_ROCK_ART_URL,
            'settlements': CONFIG.MEGALITHS_SETTLEMENTS_URL
        };
        
        const response = await fetch(urls[category]);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const raw = await response.json();
        let data = (raw.sites && Array.isArray(raw.sites)) ? raw.sites : (Array.isArray(raw) ? raw : []);
        
        megalithData[category] = data.filter(s => s && s.lat != null && s.lng != null);
        console.log(`‚úÖ ${megalithData[category].length} ${category} loaded`);
        
        createMegalithMarkers(category);
        megalithsLoaded[category] = true;
        updateCounts();
        applyFilters();
        
        document.getElementById('loading').style.display = 'none';
    } catch (err) {
        alert(`Failed: ${err.message}`);
        document.getElementById(`filter-${category}`).checked = false;
        document.getElementById('loading').style.display = 'none';
    }
}

function createPyramidMarkers() {
    pyramidData.forEach(site => {
        try {
            const lat = parseFloat(site.lat);
            const lng = parseFloat(site.lng);
            if (isNaN(lat) || isNaN(lng)) return;
            
            const marker = new google.maps.Marker({
                position: { lat, lng },
                map,
                title: site.name || 'Unknown',
                icon: {
                    path: 'M 0,-10 L 8,10 L -8,10 Z',
                    fillColor: '#4FC3F7',
                    fillOpacity: 0.85,
                    strokeColor: '#fff',
                    strokeWeight: 1.5,
                    scale: 1,
                    anchor: new google.maps.Point(0, 5)
                }
            });
            
            marker.siteData = { ...site, mainType: 'pyramid' };
            marker.addListener('click', () => showInfoWindow(marker));
            markers.push(marker);
        } catch (e) {}
    });
    
    initCluster();
}

function createMegalithMarkers(category) {
    const colors = {
        'standing-stones': '#BA68C8',
        'burials': '#9C27B0',
        'rock-art': '#E91E63',
        'settlements': '#673AB7'
    };
    
    megalithData[category].forEach(site => {
        try {
            const lat = parseFloat(site.lat);
            const lng = parseFloat(site.lng);
            if (isNaN(lat) || isNaN(lng)) return;
            
            const marker = new google.maps.Marker({
                position: { lat, lng },
                map: null,
                title: site.name || 'Unknown',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 5,
                    fillColor: colors[category],
                    fillOpacity: 0.8,
                    strokeColor: '#fff',
                    strokeWeight: 1.5
                }
            });
            
            marker.siteData = { ...site, mainType: 'megalith', megalithCategory: category };
            marker.addListener('click', () => showInfoWindow(marker));
            markers.push(marker);
        } catch (e) {}
    });
    
    initCluster();
}

function initCluster() {
    if (markerCluster) markerCluster.clearMarkers();
    
    const visibleMarkers = markers.filter(m => m.getMap() !== null);
    
    markerCluster = new markerClusterer.MarkerClusterer({
        map,
        markers: visibleMarkers,
        algorithm: new markerClusterer.SuperClusterAlgorithm({ radius: 100 }),
        renderer: {
            render: ({ count, position }) => new google.maps.Marker({
                position,
                icon: {
                    url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50"><circle cx="25" cy="25" r="20" fill="#d4af37" opacity="0.7"/><circle cx="25" cy="25" r="15" fill="#d4af37"/><text x="25" y="30" font-size="12" fill="white" font-weight="bold" text-anchor="middle">${count}</text></svg>`)}`,
                    scaledSize: new google.maps.Size(50, 50)
                },
                zIndex: Number(google.maps.Marker.MAX_ZINDEX) + count
            })
        }
    });
}

function showInfoWindow(marker) {
    const site = marker.siteData;
    const favorite = isFavorite(site);
    
    let content = `<div class="custom-info"><h3>${site.name || 'Unknown'}</h3>`;
    
    if (site.description) {
        content += `<p>${String(site.description).replace(/<[^>]*>/g, '').substring(0, 200)}...</p>`;
    }
    
    content += `<p><strong>Coordinates:</strong> ${parseFloat(site.lat).toFixed(4)}, ${parseFloat(site.lng).toFixed(4)}</p>`;
    
    if (site.country) content += `<p><strong>Location:</strong> ${site.country}</p>`;
    if (site.site_type) content += `<p><strong>Type:</strong> ${site.site_type.replace(/_/g, ' ')}</p>`;
    
    content += `<span class="category-badge badge-${site.mainType === 'pyramid' ? 'ancient' : 'megalith'}">${site.mainType === 'pyramid' ? 'Pyramid' : 'Megalithic'}</span>`;
    
    content += `<div class="info-actions">
        <button class="info-btn" onclick="map.setCenter({lat:${site.lat},lng:${site.lng}});map.setZoom(15);">üîç Zoom</button>
        <button class="info-btn" onclick="map.getStreetView().setPosition({lat:${site.lat},lng:${site.lng}});map.getStreetView().setVisible(true);">üëÅÔ∏è View</button>
        <button class="info-btn favorite" onclick='toggleFavoriteSite(${JSON.stringify(site).replace(/'/g, "&apos;")})'>${favorite ? '‚ù§Ô∏è Saved' : 'ü§ç Save'}</button>
    </div></div>`;
    
    infoWindow.setContent(content);
    infoWindow.open(map, marker);
}

function toggleFavoriteSite(site) {
    toggleFavorite(site);
    saveFavorites();
    
    const marker = markers.find(m => m.siteData.lat === site.lat && m.siteData.lng === site.lng);
    if (marker) showInfoWindow(marker);
}

// GEOMETRY DETECTION FUNCTIONS
function detectEquilateralTriangles() {
    const visibleMarkers = markers.filter(m => m.getMap() !== null);
    const results = [];
    const tolerance = 0.05;
    
    for (let i = 0; i < visibleMarkers.length; i++) {
        for (let j = i + 1; j < visibleMarkers.length; j++) {
            for (let k = j + 1; k < visibleMarkers.length; k++) {
                const a = visibleMarkers[i].getPosition();
                const b = visibleMarkers[j].getPosition();
                const c = visibleMarkers[k].getPosition();
                
                const d1 = google.maps.geometry.spherical.computeDistanceBetween(a, b);
                const d2 = google.maps.geometry.spherical.computeDistanceBetween(b, c);
                const d3 = google.maps.geometry.spherical.computeDistanceBetween(c, a);
                
                const avg = (d1 + d2 + d3) / 3;
                const maxDiff = Math.max(Math.abs(d1 - avg), Math.abs(d2 - avg), Math.abs(d3 - avg));
                
                if (maxDiff / avg < tolerance) {
                    results.push({
                        sites: [visibleMarkers[i].siteData.name, visibleMarkers[j].siteData.name, visibleMarkers[k].siteData.name].join(' ‚Üí '),
                        side: (avg / 1000).toFixed(2) + ' km',
                        accuracy: ((1 - maxDiff / avg) * 100).toFixed(1) + '%'
                    });
                    
                    const triangle = new google.maps.Polygon({
                        paths: [a, b, c],
                        strokeColor: '#00FF00',
                        strokeWeight: 2,
                        fillColor: '#00FF00',
                        fillOpacity: 0.1,
                        map
                    });
                    drawings.push(triangle);
                    
                    if (results.length >= 10) break;
                }
            }
            if (results.length >= 10) break;
        }
        if (results.length >= 10) break;
    }
    
    displayResults('Equilateral Triangles', results);
}

function detectGoldenRatio() {
    const phi = 1.618033988749;
    const tolerance = 0.05;
    const results = [];
    const visibleMarkers = markers.filter(m => m.getMap() !== null);
    
    for (let i = 0; i < visibleMarkers.length; i++) {
        for (let j = i + 1; j < visibleMarkers.length; j++) {
            for (let k = j + 1; k < visibleMarkers.length; k++) {
                const a = visibleMarkers[i].getPosition();
                const b = visibleMarkers[j].getPosition();
                const c = visibleMarkers[k].getPosition();
                
                const d1 = google.maps.geometry.spherical.computeDistanceBetween(a, b);
                const d2 = google.maps.geometry.spherical.computeDistanceBetween(b, c);
                const ratio = d2 / d1;
                
                if (Math.abs(ratio - phi) / phi < tolerance) {
                    results.push({
                        sites: [visibleMarkers[i].siteData.name, visibleMarkers[j].siteData.name, visibleMarkers[k].siteData.name].join(' ‚Üí '),
                        dist1: (d1 / 1000).toFixed(2) + ' km',
                        dist2: (d2 / 1000).toFixed(2) + ' km',
                        ratio: ratio.toFixed(4),
                        accuracy: ((1 - Math.abs(ratio - phi) / phi) * 100).toFixed(1) + '%'
                    });
                    
                    const line = new google.maps.Polyline({
                        path: [a, b, c],
                        strokeColor: '#FFD700',
                        strokeWeight: 3,
                        map
                    });
                    drawings.push(line);
                    
                    if (results.length >= 10) break;
                }
            }
            if (results.length >= 10) break;
        }
        if (results.length >= 10) break;
    }
    
    displayResults('Golden Ratio Patterns', results);
}

function detectCircularPatterns() {
    const visibleMarkers = markers.filter(m => m.getMap() !== null);
    const results = [];
    const tolerance = 0.1;
    
    for (let i = 0; i < visibleMarkers.length && results.length < 10; i++) {
        const center = visibleMarkers[i].getPosition();
        const nearby = visibleMarkers
            .map((m, idx) => idx === i ? null : {
                marker: m,
                dist: google.maps.geometry.spherical.computeDistanceBetween(center, m.getPosition())
            })
            .filter(x => x)
            .sort((a, b) => a.dist - b.dist);
        
        let currentGroup = [nearby[0]];
        for (let j = 1; j < nearby.length; j++) {
            if (Math.abs(nearby[j].dist - currentGroup[0].dist) / currentGroup[0].dist < tolerance) {
                currentGroup.push(nearby[j]);
            } else if (currentGroup.length >= 4) {
                results.push({
                    center: visibleMarkers[i].siteData.name,
                    radius: (currentGroup[0].dist / 1000).toFixed(2) + ' km',
                    sites: currentGroup.length,
                    members: currentGroup.map(c => c.marker.siteData.name).slice(0, 5).join(', ') + (currentGroup.length > 5 ? '...' : '')
                });
                
                const circle = new google.maps.Circle({
                    center,
                    radius: currentGroup[0].dist,
                    strokeColor: '#FF00FF',
                    strokeWeight: 2,
                    fillColor: '#FF00FF',
                    fillOpacity: 0.1,
                    map
                });
                drawings.push(circle);
                break;
            } else {
                currentGroup = [nearby[j]];
            }
        }
    }
    
    displayResults('Circular Patterns', results);
}

function detectAlignments() {
    const visibleMarkers = markers.filter(m => m.getMap() !== null);
    const results = [];
    const tolerance = 1;
    
    for (let i = 0; i < visibleMarkers.length && results.length < 10; i++) {
        for (let j = i + 1; j < visibleMarkers.length && results.length < 10; j++) {
            const a = visibleMarkers[i].getPosition();
            const b = visibleMarkers[j].getPosition();
            const bearing1 = google.maps.geometry.spherical.computeHeading(a, b);
            const aligned = [visibleMarkers[i], visibleMarkers[j]];
            
            for (let k = 0; k < visibleMarkers.length; k++) {
                if (k === i || k === j) continue;
                const c = visibleMarkers[k].getPosition();
                const bearing2 = google.maps.geometry.spherical.computeHeading(a, c);
                const diff = Math.abs(bearing1 - bearing2);
                if (diff < tolerance || diff > (360 - tolerance)) {
                    aligned.push(visibleMarkers[k]);
                }
            }
            
            if (aligned.length >= 3) {
                results.push({
                    sites: aligned.length,
                    names: aligned.map(m => m.siteData.name).join(' ‚Üí '),
                    bearing: bearing1.toFixed(2) + '¬∞'
                });
                
                const line = new google.maps.Polyline({
                    path: aligned.map(m => m.getPosition()),
                    strokeColor: '#00FFFF',
                    strokeWeight: 3,
                    map
                });
                drawings.push(line);
            }
        }
    }
    
    displayResults('Linear Alignments', results);
}

function detectPythagorean() {
    const visibleMarkers = markers.filter(m => m.getMap() !== null);
    const results = [];
    const ratios = [[3, 4, 5], [5, 12, 13], [8, 15, 17]];
    
    for (let i = 0; i < visibleMarkers.length && results.length < 10; i++) {
        for (let j = i + 1; j < visibleMarkers.length && results.length < 10; j++) {
            for (let k = j + 1; k < visibleMarkers.length && results.length < 10; k++) {
                const a = visibleMarkers[i].getPosition();
                const b = visibleMarkers[j].getPosition();
                const c = visibleMarkers[k].getPosition();
                
                const distances = [
                    google.maps.geometry.spherical.computeDistanceBetween(a, b),
                    google.maps.geometry.spherical.computeDistanceBetween(b, c),
                    google.maps.geometry.spherical.computeDistanceBetween(c, a)
                ].sort((a, b) => a - b);
                
                ratios.forEach(ratio => {
                    const scale = distances[0] / ratio[0];
                    const expected = ratio.map(r => r * scale);
                    
                    if (expected.every((exp, idx) => Math.abs(distances[idx] - exp) / exp < 0.05)) {
                        results.push({
                            sites: [visibleMarkers[i].siteData.name, visibleMarkers[j].siteData.name, visibleMarkers[k].siteData.name].join(' ‚Üí '),
                            ratio: ratio.join(':'),
                            sides: distances.map(d => (d / 1000).toFixed(2) + ' km').join(', ')
                        });
                        
                        const triangle = new google.maps.Polygon({
                            paths: [a, b, c],
                            strokeColor: '#FFA500',
                            strokeWeight: 2,
                            fillColor: '#FFA500',
                            fillOpacity: 0.1,
                            map
                        });
                        drawings.push(triangle);
                    }
                });
            }
        }
    }
    
    displayResults('Pythagorean Triangles', results);
}

function displayResults(title, results) {
    const resultsDiv = document.getElementById('toolResults');
    const content = document.getElementById('toolResultsContent');
    
    if (results.length === 0) {
        content.innerHTML = '<p style="color:#999;font-size:10px;">No patterns found in visible sites. Try zooming out or enabling more layers.</p>';
    } else {
        let html = `<p style="font-size:10px;margin-bottom:8px;">Found ${results.length} pattern(s):</p>`;
        results.slice(0, 10).forEach((result, idx) => {
            html += `<div class="tool-result-item"><strong style="color:#d4af37;">Pattern ${idx + 1}:</strong><br>`;
            Object.entries(result).forEach(([key, value]) => {
                html += `<span style="color:#666;">${key}:</span> ${value}<br>`;
            });
            html += `</div>`;
        });
        if (results.length > 10) {
            html += '<p style="font-size:9px;color:#999;margin-top:8px;">Showing first 10 results</p>';
        }
        content.innerHTML = html;
    }
    
    resultsDiv.style.display = 'block';
}

function toggleMapType() {
    if (currentMapType === 'roadmap') {
        map.setMapTypeId(google.maps.MapTypeId.HYBRID);
        currentMapType = 'hybrid';
        document.getElementById('map-type-label').textContent = 'Map';
    } else {
        map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
        currentMapType = 'roadmap';
        document.getElementById('map-type-label').textContent = 'Satellite';
    }
}

function toggleLabels() {
    labelsEnabled = !labelsEnabled;
    map.setOptions({
        styles: [{
            featureType: 'all',
            elementType: 'labels',
            stylers: [{ visibility: labelsEnabled ? 'on' : 'off' }]
        }]
    });
    document.getElementById('btn-labels').classList.toggle('active');
}

function toggleTerrain() {
    map.setMapTypeId(
        map.getMapTypeId() === google.maps.MapTypeId.TERRAIN ? 
        google.maps.MapTypeId.ROADMAP : 
        google.maps.MapTypeId.TERRAIN
    );
}

function updateCounts() {
    document.getElementById('count-pyramids').textContent = pyramidData.length;
    let total = pyramidData.length;
    
    Object.keys(megalithData).forEach(category => {
        const count = megalithData[category].length;
        document.getElementById(`count-${category}`).textContent = count;
        if (megalithsLoaded[category]) total += count;
    });
    
    document.getElementById('total-count').textContent = total;
    document.getElementById('loaded-count').textContent = total;
    updateVisibleCount();
}

function updateVisibleCount() {
    document.getElementById('visible-count').textContent = markers.filter(m => m.getMap() !== null).length;
}

function applyFilters() {
    const filters = {
        pyramids: document.getElementById('filter-pyramids').checked,
        standingStones: document.getElementById('filter-standing-stones').checked,
        burials: document.getElementById('filter-burials').checked,
        rockArt: document.getElementById('filter-rock-art').checked,
        settlements: document.getElementById('filter-settlements').checked
    };
    
    markers.forEach(marker => {
        const site = marker.siteData;
        let show = false;
        
        if (site.mainType === 'pyramid' && filters.pyramids) {
            show = true;
        } else if (site.mainType === 'megalith') {
            if (site.megalithCategory === 'standing-stones' && filters.standingStones) show = true;
            if (site.megalithCategory === 'burials' && filters.burials) show = true;
            if (site.megalithCategory === 'rock-art' && filters.rockArt) show = true;
            if (site.megalithCategory === 'settlements' && filters.settlements) show = true;
        }
        
        marker.setMap(show ? map : null);
    });
    
    initCluster();
    updateVisibleCount();
}

function setupEventListeners() {
    document.getElementById('filter-pyramids').addEventListener('change', applyFilters);
    
    ['standing-stones', 'burials', 'rock-art', 'settlements'].forEach(category => {
        document.getElementById(`filter-${category}`).addEventListener('change', function() {
            if (this.checked && !megalithsLoaded[category]) {
                loadMegaliths(category);
            } else {
                applyFilters();
            }
        });
    });
}

function showError(title, message) {
    document.getElementById('loading').innerHTML = `<div style="color:#FF6B6B;padding:20px;"><h3>‚ö†Ô∏è ${title}</h3><p style="margin-top:10px;font-size:12px;">${message}</p></div>`;
}

// Initialize Google Maps
(function() {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&callback=initMap&libraries=geometry&v=weekly`;
    script.async = true;
    script.defer = true;
    script.onerror = () => showError('Load Failed', 'Check API key');
    document.head.appendChild(script);
    
    const clusterScript = document.createElement('script');
    clusterScript.src = 'https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js';
    clusterScript.async = true;
    document.head.appendChild(clusterScript);
})();
    </script>
</body>
</html>
