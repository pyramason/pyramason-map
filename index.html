<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyramason - Ultimate Ancient Sites Research Platform</title>
    <meta name="description" content="Professional research-grade platform for 50,000+ ancient pyramids, megaliths, temples, and sacred sites worldwide with advanced analysis tools">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary-purple: #6A1B9A;
            --dark-purple: #4A148C;
            --light-purple: #9C27B0;
            --accent-gold: #FFD700;
            --dark-gold: #D4AF37;
            --cyan: #00BCD4;
            --light-cyan: #4FC3F7;
            --cosmic-bg: #0a0a1a;
            --panel-bg: rgba(10, 10, 26, 0.98);
            --glass-bg: rgba(106, 27, 154, 0.15);
            --border-color: rgba(255, 215, 0, 0.3);
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #f44336;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--cosmic-bg);
            color: #fff;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Map */
        #map { 
            width: 100vw; 
            height: 100vh; 
            background: var(--cosmic-bg);
        }
        
        /* Loading Spinner */
        .loading-spinner {
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            width: 80px; 
            height: 80px;
            z-index: 10001; 
            display: none;
        }
        .loading-spinner.active { display: block; }
        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid rgba(255, 215, 0, 0.1);
            border-top: 4px solid var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .spinner-ring:nth-child(2) {
            border-top-color: var(--cyan);
            animation-duration: 1.5s;
        }
        .spinner-ring:nth-child(3) {
            border-top-color: var(--light-purple);
            animation-duration: 2s;
        }
        
        /* Registration Modal */
        .registration-modal {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a0033 25%, #2d1b4e 50%, #1a0033 75%, #0a0a1a 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            z-index: 10000; 
            display: none; 
            align-items: center; 
            justify-content: center;
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .registration-content {
            background: var(--panel-bg); 
            border: 3px solid var(--accent-gold);
            border-radius: 20px; 
            padding: 40px; 
            max-width: 520px; 
            width: 90%;
            box-shadow: 0 20px 60px rgba(255, 215, 0, 0.4), 0 0 100px rgba(106, 27, 154, 0.3);
            animation: slideUp 0.6s ease, glow 3s ease-in-out infinite;
            backdrop-filter: blur(20px);
            position: relative;
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 20px 60px rgba(255, 215, 0, 0.4), 0 0 100px rgba(106, 27, 154, 0.3); }
            50% { box-shadow: 0 20px 80px rgba(255, 215, 0, 0.6), 0 0 120px rgba(106, 27, 154, 0.5); }
        }
        .registration-content::before {
            content: '';
            position: absolute;
            top: -2px; right: -2px; bottom: -2px; left: -2px;
            background: linear-gradient(45deg, var(--accent-gold), var(--light-purple), var(--cyan));
            border-radius: 20px;
            z-index: -1;
            opacity: 0.5;
            filter: blur(10px);
        }
        .registration-logo { 
            text-align: center; 
            margin-bottom: 25px; 
        }
        .pyramason-logo { 
            width: 90px; 
            height: 90px; 
            display: inline-block;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.6));
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .registration-title {
            font-size: 36px; 
            text-align: center; 
            color: var(--accent-gold);
            margin-bottom: 10px; 
            font-weight: 700; 
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.7);
            letter-spacing: 3px;
        }
        .registration-subtitle {
            text-align: center; 
            color: var(--light-cyan); 
            margin-bottom: 30px; 
            font-size: 14px;
            letter-spacing: 1px;
        }
        .registration-features {
            margin: 25px 0; 
            padding: 20px; 
            background: var(--glass-bg);
            border-radius: 12px; 
            border: 1px solid var(--border-color);
        }
        .feature-item {
            display: flex; 
            align-items: center; 
            gap: 12px;
            padding: 10px 0; 
            color: rgba(255, 255, 255, 0.95);
            font-size: 14px;
            transition: all 0.3s;
        }
        .feature-item:hover {
            padding-left: 5px;
            color: var(--accent-gold);
        }
        .feature-item::before { 
            content: '✨'; 
            font-size: 20px;
            animation: sparkle 2s ease-in-out infinite;
        }
        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }
        .registration-form { 
            display: flex; 
            flex-direction: column; 
            gap: 18px; 
        }
        .form-group { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        .form-group label { 
            color: var(--accent-gold); 
            font-size: 14px; 
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .form-group input {
            padding: 14px 18px; 
            border: 2px solid var(--border-color);
            background: rgba(255, 255, 255, 0.03); 
            color: #fff;
            border-radius: 10px; 
            font-size: 15px; 
            transition: all 0.3s;
            font-family: inherit;
        }
        .form-group input:focus {
            outline: none; 
            border-color: var(--accent-gold);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
        }
        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        .registration-btn {
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--dark-gold) 100%);
            color: var(--dark-purple); 
            padding: 16px; 
            border: none;
            border-radius: 10px; 
            font-size: 16px; 
            font-weight: 700;
            cursor: pointer; 
            transition: all 0.3s; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
        }
        .registration-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .registration-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .registration-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
        }
        .guest-btn {
            background: transparent; 
            color: rgba(255, 255, 255, 0.7);
            padding: 14px; 
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px; 
            cursor: pointer; 
            transition: all 0.3s;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 14px;
        }
        .guest-btn:hover { 
            border-color: rgba(255, 255, 255, 0.5); 
            background: rgba(255, 255, 255, 0.05);
            color: #fff; 
            transform: translateY(-2px);
        }
        
        /* Compact Sidebar */
        .sidebar {
            position: fixed; 
            left: 0; 
            top: 0; 
            width: 70px; 
            height: 100vh;
            background: var(--panel-bg); 
            backdrop-filter: blur(15px);
            border-right: 2px solid var(--border-color); 
            z-index: 1000;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px 0;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
        }
        .sidebar-logo {
            margin-bottom: 30px;
        }
        .sidebar-logo svg {
            width: 45px;
            height: 45px;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
        }
        .sidebar-divider {
            width: 40px;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--border-color), transparent);
            margin: 15px 0;
        }
        .sidebar-btn {
            width: 50px; 
            height: 50px; 
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid var(--border-color);
            border-radius: 12px; 
            color: #fff; 
            cursor: pointer;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 24px; 
            transition: all 0.3s;
            position: relative;
        }
        .sidebar-btn::after {
            content: attr(title);
            position: absolute;
            left: 100%;
            margin-left: 15px;
            padding: 8px 15px;
            background: var(--panel-bg);
            border: 2px solid var(--accent-gold);
            border-radius: 8px;
            white-space: nowrap;
            font-size: 13px;
            font-weight: 600;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 10001;
        }
        .sidebar-btn:hover::after {
            opacity: 1;
            margin-left: 20px;
        }
        .sidebar-btn:hover, .sidebar-btn.active {
            background: rgba(255, 215, 0, 0.2); 
            border-color: var(--accent-gold);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        .sidebar-btn.active {
            background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
            color: var(--dark-purple);
        }
        
        /* Enhanced Search Bar */
        .search-bar {
            position: fixed; 
            top: 25px; 
            left: 50%; 
            transform: translateX(-50%);
            z-index: 900; 
            background: var(--panel-bg); 
            padding: 12px 25px;
            border-radius: 50px; 
            border: 2px solid var(--accent-gold);
            backdrop-filter: blur(15px); 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: flex; 
            align-items: center; 
            gap: 12px;
            transition: all 0.3s;
        }
        .search-bar:hover {
            box-shadow: 0 12px 50px rgba(255, 215, 0, 0.3);
        }
        .search-icon {
            font-size: 22px;
            color: var(--accent-gold);
        }
        .search-input {
            background: transparent; 
            border: none; 
            color: #fff;
            font-size: 15px; 
            width: 450px; 
            outline: none;
            font-family: inherit;
        }
        .search-input::placeholder { 
            color: rgba(255, 255, 255, 0.5); 
        }
        .search-btn {
            background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
            color: var(--dark-purple); 
            border: none; 
            padding: 10px 24px;
            border-radius: 25px; 
            cursor: pointer; 
            font-weight: 700; 
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 13px;
        }
        .search-btn:hover { 
            transform: scale(1.05); 
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
        }
        .autocomplete-results {
            position: absolute; 
            top: 110%; 
            left: 0; 
            right: 0;
            background: var(--panel-bg);
            border: 2px solid var(--border-color); 
            border-radius: 15px;
            max-height: 350px; 
            overflow-y: auto; 
            display: none;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.7);
        }
        .autocomplete-item {
            padding: 15px 25px; 
            cursor: pointer; 
            transition: all 0.3s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        .autocomplete-item:hover { 
            background: rgba(255, 215, 0, 0.15); 
            padding-left: 30px;
        }
        .autocomplete-icon {
            font-size: 20px;
        }
        .autocomplete-text {
            flex: 1;
        }
        .autocomplete-name {
            font-weight: 600;
            color: var(--accent-gold);
            margin-bottom: 3px;
        }
        .autocomplete-details {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* Compact Map Controls */
        .map-controls {
            position: fixed; 
            top: 25px; 
            right: 25px; 
            z-index: 900;
            display: flex; 
            gap: 10px; 
            background: var(--panel-bg);
            padding: 10px; 
            border-radius: 30px; 
            border: 2px solid var(--border-color);
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        .control-btn {
            width: 45px; 
            height: 45px; 
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color); 
            color: #fff;
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 20px; 
            cursor: pointer; 
            transition: all 0.3s;
            position: relative;
        }
        .control-btn:hover { 
            background: rgba(255, 215, 0, 0.2); 
            transform: scale(1.15); 
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        .control-btn.active {
            background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
            color: var(--dark-purple);
        }
        
        /* UNIFIED ANALYSIS PANEL */
        .unified-panel {
            position: fixed; 
            right: -500px; 
            top: 0; 
            width: 500px; 
            height: 100vh;
            background: var(--panel-bg); 
            border-left: 2px solid var(--accent-gold);
            backdrop-filter: blur(20px); 
            z-index: 800; 
            transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex; 
            flex-direction: column; 
            box-shadow: -6px 0 30px rgba(0, 0, 0, 0.7);
        }
        .unified-panel.active { 
            right: 0; 
        }
        .panel-header {
            padding: 25px 30px; 
            border-bottom: 2px solid var(--border-color);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            background: linear-gradient(135deg, rgba(106, 27, 154, 0.2), rgba(0, 0, 0, 0.2));
        }
        .panel-title {
            color: var(--accent-gold); 
            font-size: 22px; 
            font-weight: 700;
            display: flex; 
            align-items: center; 
            gap: 12px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        .close-panel {
            background: rgba(255, 0, 0, 0.1); 
            border: 2px solid rgba(255, 0, 0, 0.3); 
            color: #ff5555;
            font-size: 30px; 
            cursor: pointer; 
            transition: all 0.3s;
            width: 45px; 
            height: 45px; 
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-weight: 300;
        }
        .close-panel:hover {
            background: rgba(255, 0, 0, 0.3); 
            border-color: #ff0000;
            color: #ff0000; 
            transform: rotate(90deg);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.4);
        }
        
        /* Tabs System */
        .panel-tabs {
            display: flex; 
            border-bottom: 2px solid var(--border-color);
            background: rgba(0, 0, 0, 0.2); 
            overflow-x: auto;
            scrollbar-width: thin;
        }
        .panel-tabs::-webkit-scrollbar {
            height: 4px;
        }
        .panel-tabs::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        .panel-tabs::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 2px;
        }
        .panel-tab {
            padding: 16px 24px; 
            cursor: pointer; 
            transition: all 0.3s;
            border-bottom: 3px solid transparent; 
            white-space: nowrap;
            font-size: 13px; 
            font-weight: 700; 
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }
        .panel-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: var(--accent-gold);
            transition: all 0.3s;
            transform: translateX(-50%);
        }
        .panel-tab:hover { 
            background: rgba(255, 215, 0, 0.08); 
            color: rgba(255, 255, 255, 0.9); 
        }
        .panel-tab.active {
            color: var(--accent-gold);
            background: rgba(255, 215, 0, 0.1);
        }
        .panel-tab.active::after {
            width: 100%;
        }
        .tab-content {
            flex: 1; 
            overflow-y: auto; 
            padding: 25px; 
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .tab-content.active { 
            display: block; 
        }
        
        /* Filter Groups */
        .filter-group {
            margin-bottom: 30px; 
            padding: 20px; 
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px; 
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }
        .filter-group:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 215, 0, 0.5);
        }
        .filter-title {
            color: var(--accent-gold); 
            font-size: 15px; 
            font-weight: 700;
            margin-bottom: 15px; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: linear-gradient(180deg, var(--accent-gold), var(--dark-gold));
            border-radius: 2px;
        }
        .filter-option {
            display: flex; 
            align-items: center; 
            gap: 12px;
            padding: 10px; 
            cursor: pointer; 
            transition: all 0.3s;
            border-radius: 8px;
            margin: 5px 0;
        }
        .filter-option:hover {
            background: rgba(255, 215, 0, 0.1);
            padding-left: 15px;
        }
        .filter-checkbox {
            width: 22px; 
            height: 22px; 
            border: 2px solid var(--border-color);
            border-radius: 6px; 
            position: relative; 
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .filter-checkbox.checked {
            background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        .filter-checkbox.checked::after {
            content: '✓'; 
            position: absolute; 
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%); 
            color: var(--dark-purple);
            font-weight: 900; 
            font-size: 16px;
        }
        .filter-label { 
            font-size: 14px; 
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }
        
        /* Action Buttons */
        .action-btn {
            width: 100%; 
            padding: 14px 18px; 
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid var(--border-color);
            border-radius: 10px; 
            color: #fff; 
            cursor: pointer;
            transition: all 0.3s; 
            display: flex; 
            align-items: center; 
            gap: 15px;
            font-size: 14px; 
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }
        .action-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            transition: width 0.4s;
        }
        .action-btn:hover::before {
            width: 100%;
        }
        .action-btn:hover {
            background: rgba(255, 215, 0, 0.15); 
            border-color: var(--accent-gold);
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.2);
        }
        .action-btn.primary {
            background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
            color: var(--dark-purple); 
            font-weight: 700;
            border: none;
        }
        .action-btn.primary:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }
        .btn-icon { 
            font-size: 22px; 
            width: 28px; 
            text-align: center;
            flex-shrink: 0;
        }
        
        /* Info Box */
        .info-box {
            margin: 20px 0; 
            padding: 18px 20px; 
            background: var(--glass-bg);
            border-radius: 12px; 
            border-left: 4px solid var(--accent-gold);
            box-shadow: 0 5px 20px rgba(106, 27, 154, 0.2);
        }
        .info-box-title {
            color: var(--light-cyan); 
            font-size: 15px; 
            font-weight: 700; 
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .info-box-text {
            font-size: 13px; 
            line-height: 1.7; 
            color: rgba(255, 255, 255, 0.85);
        }
        
        /* Results Display */
        .results-container {
            margin: 20px 0; 
            padding: 18px; 
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px; 
            border: 1px solid var(--border-color);
            max-height: 400px;
            overflow-y: auto;
        }
        .result-item {
            padding: 15px; 
            margin: 10px 0; 
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px; 
            border-left: 3px solid var(--cyan);
            cursor: pointer; 
            transition: all 0.3s;
        }
        .result-item:hover {
            background: rgba(0, 188, 212, 0.15); 
            transform: translateX(8px);
            border-left-width: 5px;
            box-shadow: 0 5px 20px rgba(0, 188, 212, 0.2);
        }
        .result-name { 
            color: var(--accent-gold); 
            font-weight: 700; 
            margin-bottom: 8px;
            font-size: 15px;
        }
        .result-details { 
            font-size: 13px; 
            color: rgba(255, 255, 255, 0.75);
            line-height: 1.6;
        }
        
        /* Slider Controls */
        .slider-container { 
            margin: 20px 0; 
        }
        .slider-label {
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 12px;
            color: var(--light-cyan); 
            font-size: 14px; 
            font-weight: 700;
        }
        .slider {
            width: 100%; 
            height: 8px; 
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.15));
            border-radius: 10px; 
            outline: none; 
            -webkit-appearance: none;
            position: relative;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none; 
            width: 22px; 
            height: 22px;
            background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
            border-radius: 50%; 
            cursor: pointer; 
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6), 0 3px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
        }
        .slider::-moz-range-thumb {
            width: 22px; 
            height: 22px;
            background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
            border-radius: 50%; 
            cursor: pointer; 
            border: none;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }
        .slider-marks {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0, 0, 0, 0.85); 
            backdrop-filter: blur(8px);
            z-index: 9999; 
            display: none; 
            align-items: center; 
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        .modal-overlay.active { 
            display: flex; 
        }
        .modal-content {
            background: var(--panel-bg); 
            border: 3px solid var(--accent-gold);
            border-radius: 20px; 
            padding: 35px; 
            max-width: 650px; 
            width: 90%;
            max-height: 85vh; 
            overflow-y: auto; 
            animation: slideUp 0.4s ease;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.8), 0 0 50px rgba(255, 215, 0, 0.2);
            position: relative;
        }
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--accent-gold), var(--light-purple), var(--cyan));
            border-radius: 20px 20px 0 0;
        }
        .modal-header {
            display: flex; 
            align-items: center; 
            gap: 18px; 
            margin-bottom: 25px;
            padding-bottom: 20px; 
            border-bottom: 2px solid var(--border-color);
        }
        .modal-icon { 
            font-size: 48px;
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.6));
        }
        .modal-title { 
            color: var(--accent-gold); 
            font-size: 26px; 
            font-weight: 700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }
        .modal-body { 
            color: rgba(255, 255, 255, 0.95); 
            line-height: 1.8; 
            margin-bottom: 25px;
            font-size: 15px;
        }
        .modal-actions { 
            display: flex; 
            gap: 12px; 
            justify-content: flex-end; 
        }
        .modal-btn {
            padding: 12px 35px; 
            border-radius: 10px; 
            border: none;
            cursor: pointer; 
            font-weight: 700; 
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 14px;
        }
        .modal-btn-primary {
            background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
            color: var(--dark-purple);
        }
        .modal-btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
        }
        .modal-btn-secondary {
            background: transparent; 
            border: 2px solid rgba(255, 255, 255, 0.3); 
            color: #fff;
        }
        .modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        /* Context Menu */
        .context-menu {
            position: fixed; 
            background: var(--panel-bg); 
            border: 2px solid var(--accent-gold);
            border-radius: 12px; 
            padding: 8px 0; 
            min-width: 240px; 
            z-index: 10000;
            display: none; 
            backdrop-filter: blur(20px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8), 0 0 30px rgba(255, 215, 0, 0.2);
        }
        .context-menu-item {
            padding: 12px 25px; 
            cursor: pointer; 
            transition: all 0.3s;
            display: flex; 
            align-items: center; 
            gap: 15px; 
            font-size: 14px;
            font-weight: 500;
            position: relative;
        }
        .context-menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--accent-gold);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .context-menu-item:hover::before {
            opacity: 1;
        }
        .context-menu-item:hover { 
            background: rgba(255, 215, 0, 0.15);
            padding-left: 30px;
        }
        .context-menu-icon { 
            font-size: 18px; 
            width: 24px;
            text-align: center;
        }
        .context-menu-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-color), transparent);
            margin: 5px 0;
        }
        
        /* Stats Badge */
        .stats-badge {
            position: fixed; 
            bottom: 25px; 
            left: 90px; 
            z-index: 900;
            background: var(--panel-bg); 
            padding: 14px 25px;
            border-radius: 25px; 
            border: 2px solid var(--border-color);
            backdrop-filter: blur(15px); 
            font-size: 14px; 
            font-weight: 700;
            color: var(--light-cyan);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
        }
        .stats-badge:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0, 188, 212, 0.3);
        }
        .stats-icon {
            font-size: 20px;
        }
        
        /* Measurement Display */
        .measurement-display {
            position: fixed; 
            top: 100px; 
            right: 25px; 
            z-index: 900;
            background: var(--panel-bg); 
            padding: 18px 25px;
            border-radius: 15px; 
            border: 2px solid var(--accent-gold);
            backdrop-filter: blur(15px); 
            display: none; 
            min-width: 220px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
        }
        .measurement-display.active { 
            display: block;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { 
                opacity: 0; 
                transform: translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        .measurement-title {
            color: var(--accent-gold); 
            font-size: 13px; 
            font-weight: 700; 
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .measurement-value {
            color: var(--light-cyan); 
            font-size: 24px; 
            font-weight: 700;
            text-shadow: 0 0 15px rgba(79, 195, 247, 0.5);
        }
        .measurement-subtitle {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
        }
        
        /* Natal Chart Wheel */
        .natal-chart-wheel {
            width: 350px;
            height: 350px;
            margin: 25px auto;
            position: relative;
            border: 3px solid var(--accent-gold);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(26, 0, 51, 0.95) 0%, rgba(74, 20, 140, 0.95) 100%);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3), inset 0 0 50px rgba(106, 27, 154, 0.3);
        }
        .zodiac-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 90%;
            height: 90%;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
        }
        .zodiac-sign-marker {
            position: absolute;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--accent-gold);
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            transform: translate(-50%, -50%);
        }
        .planet-marker {
            position: absolute;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid var(--accent-gold);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.3s;
        }
        .planet-marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
        }
        .planet-info-card {
            background: rgba(10, 10, 26, 0.95);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid var(--cyan);
            transition: all 0.3s;
        }
        .planet-info-card:hover {
            background: rgba(0, 188, 212, 0.1);
            border-left-width: 6px;
        }
        .planet-name {
            color: var(--accent-gold);
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .planet-details {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.6;
        }
        
        /* Geometry Visualization */
        .geometry-pattern {
            background: rgba(255, 255, 255, 0.02);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin: 15px 0;
        }
        .pattern-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .pattern-type {
            color: var(--accent-gold);
            font-weight: 700;
            font-size: 16px;
        }
        .pattern-score {
            background: linear-gradient(135deg, var(--success), #66BB6A);
            color: #fff;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }
        .pattern-sites {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.7;
        }
        .pattern-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        .metric-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        .metric-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--light-cyan);
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold), var(--light-purple), var(--cyan));
            border-radius: 10px;
            transition: width 0.5s ease;
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(40px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--accent-gold), var(--dark-gold));
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--dark-gold), var(--accent-gold));
        }
        
        /* Tooltip */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: var(--panel-bg);
            border: 2px solid var(--accent-gold);
            border-radius: 8px;
            white-space: nowrap;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 10001;
        }
        [data-tooltip]:hover::after {
            opacity: 1;
            bottom: calc(100% + 10px);
        }
        
        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-premium {
            background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
            color: var(--dark-purple);
        }
        .badge-pro {
            background: linear-gradient(135deg, var(--light-purple), var(--primary-purple));
            color: #fff;
        }
        .badge-new {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            color: #fff;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .unified-panel {
                width: 450px;
            }
            .search-input {
                width: 300px;
            }
        }
        
        @media (max-width: 768px) {
            .unified-panel { 
                width: 100%; 
                right: -100%; 
            }
            .search-bar {
                width: 90%;
                left: 5%;
                transform: none;
                flex-wrap: wrap;
            }
            .search-input { 
                width: 100%;
                margin-bottom: 10px;
            }
            .map-controls { 
                flex-wrap: wrap;
                max-width: 200px;
            }
            .stats-badge {
                left: 10px;
                bottom: 10px;
                font-size: 12px;
                padding: 10px 15px;
            }
            .sidebar {
                width: 60px;
            }
        }
        
        @media (max-width: 480px) {
            .modal-content {
                padding: 25px;
                max-width: 95%;
            }
            .natal-chart-wheel {
                width: 280px;
                height: 280px;
            }
        }

/* ===== PYRAMASON UI IMPROVEMENTS ADD-ON ===== */
/* ============================================================================
   PYRAMASON UI IMPROVEMENTS ADD-ON
   Add this CSS to your existing index.html in the <style> section
   ============================================================================ */

/* COMPACT HEADER WITH LOGO */
.compact-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: rgba(26, 26, 26, 0.95);
    backdrop-filter: blur(15px);
    border-bottom: 2px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    z-index: 950;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
}

.logo-container {
    display: flex;
    align-items: center;
    gap: 12px;
}

.pyramason-logo {
    height: 45px;
    width: auto;
    filter: drop-shadow(0 2px 8px rgba(255, 215, 0, 0.4));
    transition: transform 0.3s ease;
}

.pyramason-logo:hover {
    transform: scale(1.05);
}

.site-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--accent-gold);
    letter-spacing: 1px;
    text-shadow: 0 2px 10px rgba(255, 215, 0, 0.5);
}

/* COMPACT SEARCH BAR - TOP LEFT */
.search-container-compact {
    position: fixed;
    top: 70px;
    left: 80px; /* After sidebar */
    z-index: 900;
    width: 320px;
    max-width: calc(100vw - 100px);
}

.search-box-compact {
    display: flex;
    background: rgba(26, 26, 26, 0.95);
    border: 2px solid var(--border-color);
    border-radius: 25px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
}

.search-input-compact {
    flex: 1;
    padding: 12px 18px;
    border: none;
    background: transparent;
    color: white;
    font-size: 14px;
    outline: none;
}

.search-input-compact::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.search-button-compact {
    padding: 12px 20px;
    background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
    border: none;
    color: var(--dark-purple);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.search-button-compact:hover {
    background: linear-gradient(135deg, var(--dark-gold), var(--accent-gold));
}

/* COMPACT SIDE PANEL - 350PX WIDTH */
.sidebar-compact {
    position: fixed;
    left: 0;
    top: 0;
    width: 70px;
    height: 100vh;
    background: rgba(26, 26, 26, 0.95);
    backdrop-filter: blur(15px);
    border-right: 2px solid var(--border-color);
    z-index: 900;
    transition: width 0.3s ease;
}

.sidebar-compact.expanded {
    width: 350px;
}

.panel-content-compact {
    display: none;
    padding: 20px;
    margin-top: 80px;
    overflow-y: auto;
    height: calc(100vh - 80px);
}

.sidebar-compact.expanded .panel-content-compact {
    display: block;
}

/* ENSURE SIDEBAR DOESN'T COVER MAP */
#map {
    margin-left: 70px;
    width: calc(100vw - 70px);
}

.sidebar-compact.expanded ~ #map {
    margin-left: 350px;
    width: calc(100vw - 350px);
}

/* MOBILE RESPONSIVE */
@media (max-width: 768px) {
    .compact-header {
        height: 55px;
        padding: 0 10px;
    }
    
    .pyramason-logo {
        height: 38px;
    }
    
    .site-title {
        font-size: 16px;
        display: none;
    }
    
    .search-container-compact {
        width: calc(100vw - 80px);
        top: 65px;
        left: 10px;
    }
    
    .sidebar-compact {
        width: 60px;
    }
    
    .sidebar-compact.expanded {
        width: 100%;
    }
    
    #map {
        margin-left: 60px;
        width: calc(100vw - 60px);
    }
    
    .sidebar-compact.expanded ~ #map {
        margin-left: 0;
        width: 100vw;
        display: none; /* Hide map when panel is open on mobile */
    }
}

/* HIDE ORIGINAL SEARCH IF IT EXISTS */
.search-bar-container {
    display: none !important;
}

/* ADJUST MAP CONTROLS POSITION */
.map-controls-bottom {
    position: fixed;
    bottom: 20px;
    left: 90px;
    z-index: 850;
}

@media (max-width: 768px) {
    .map-controls-bottom {
        left: 70px;
        bottom: 15px;
    }
}

/* COMPACT FILTER PANEL */
.filter-panel-compact {
    background: rgba(26, 26, 26, 0.95);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 15px;
    margin: 10px 0;
}

.filter-title-compact {
    font-size: 14px;
    font-weight: 600;
    color: var(--accent-gold);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* ENSURE LABELS WORK PROPERLY */
.map-labels-toggle {
    cursor: pointer;
    user-select: none;
}

/* PEGMAN/STREET VIEW POSITIONING */
.gm-svpc {
    position: fixed !important;
    right: 10px !important;
    bottom: 100px !important;
}

/* STATISTICS DISPLAY */
.stats-display-compact {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(26, 26, 26, 0.95);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 12px 18px;
    backdrop-filter: blur(15px);
    z-index: 850;
    font-size: 13px;
}

.stats-row-compact {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    margin: 4px 0;
}

.stats-label-compact {
    color: rgba(255, 255, 255, 0.7);
}

.stats-value-compact {
    color: var(--accent-gold);
    font-weight: 600;
}

/* LAYER TOGGLE MENU - COMPACT */
.layer-menu-compact {
    position: fixed;
    bottom: 80px;
    left: 80px;
    width: 280px;
    max-height: calc(100vh - 200px);
    background: rgba(26, 26, 26, 0.95);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 15px;
    z-index: 900;
    display: none;
    backdrop-filter: blur(15px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
    overflow-y: auto;
}

.layer-menu-compact.active {
    display: block;
}

.layer-item-compact {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    margin: 5px 0;
    background: rgba(255, 215, 0, 0.05);
    border: 1px solid rgba(255, 215, 0, 0.15);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.layer-item-compact:hover {
    background: rgba(255, 215, 0, 0.15);
    border-color: var(--border-color);
}

.layer-item-compact.active {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
    border-color: var(--accent-gold);
}

/* IMPROVED TOOLTIPS */
.tooltip-compact {
    position: absolute;
    background: rgba(26, 26, 26, 0.98);
    border: 2px solid var(--accent-gold);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
    color: white;
    pointer-events: none;
    z-index: 10000;
    white-space: nowrap;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
}

/* FEATURE CARDS IN PANEL */
.feature-card-compact {
    background: rgba(255, 215, 0, 0.08);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 15px;
    margin: 10px 0;
    cursor: pointer;
    transition: all 0.3s;
}

.feature-card-compact:hover {
    background: rgba(255, 215, 0, 0.15);
    border-color: var(--accent-gold);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 215, 0, 0.2);
}

.feature-icon-compact {
    font-size: 28px;
    margin-bottom: 10px;
}

.feature-title-compact {
    font-size: 16px;
    font-weight: 600;
    color: var(--accent-gold);
    margin-bottom: 6px;
}

.feature-description-compact {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.7);
    line-height: 1.5;
}

/* ANIMATION IMPROVEMENTS */
@keyframes slideInFromLeft {
    from {
        transform: translateX(-100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.animate-slide-in {
    animation: slideInFromLeft 0.4s ease-out;
}

/* SCROLLBAR STYLING */
.sidebar-compact::-webkit-scrollbar,
.panel-content-compact::-webkit-scrollbar,
.layer-menu-compact::-webkit-scrollbar {
    width: 8px;
}

.sidebar-compact::-webkit-scrollbar-track,
.panel-content-compact::-webkit-scrollbar-track,
.layer-menu-compact::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
}

.sidebar-compact::-webkit-scrollbar-thumb,
.panel-content-compact::-webkit-scrollbar-thumb,
.layer-menu-compact::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 4px;
}

.sidebar-compact::-webkit-scrollbar-thumb:hover,
.panel-content-compact::-webkit-scrollbar-thumb:hover,
.layer-menu-compact::-webkit-scrollbar-thumb:hover {
    background: var(--accent-gold);
}

/* ENSURE NO ELEMENTS OVERLAP */
.tab-container {
    margin-top: 20px;
}

.filter-group {
    margin-bottom: 20px;
}

/* BUTTON IMPROVEMENTS */
.action-btn-compact {
    padding: 10px 16px;
    background: rgba(255, 215, 0, 0.08);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
    width: 100%;
    margin: 5px 0;
}

.action-btn-compact:hover {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
    border-color: var(--accent-gold);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
}

.action-btn-compact.active {
    background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
    border-color: var(--accent-gold);
    color: var(--dark-purple);
}

/* MODAL IMPROVEMENTS */
.modal-overlay-compact {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
}

.modal-overlay-compact.active {
    display: flex;
}

.modal-content-compact {
    background: rgba(26, 26, 26, 0.98);
    border: 2px solid var(--accent-gold);
    border-radius: 16px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    position: relative;
}

/* INFO WINDOWS */
.gm-style-iw {
    background: rgba(26, 26, 26, 0.98) !important;
    border: 2px solid var(--accent-gold) !important;
    border-radius: 12px !important;
}

.gm-style-iw-c {
    background: rgba(26, 26, 26, 0.98) !important;
}

.gm-style-iw-d {
    overflow: hidden !important;
}

/* LOADING OVERLAY IMPROVEMENT */
.loading-overlay-compact {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(10, 10, 26, 0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(10px);
}

.loading-overlay-compact.active {
    display: flex;
}

/* COMPACT TOGGLE SWITCH */
.toggle-switch-compact {
    position: relative;
    width: 42px;
    height: 22px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 11px;
    cursor: pointer;
    transition: background 0.3s;
}

.toggle-switch-compact.active {
    background: var(--success);
}

.toggle-slider-compact {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 18px;
    height: 18px;
    background: white;
    border-radius: 50%;
    transition: transform 0.3s;
}

.toggle-switch-compact.active .toggle-slider-compact {
    transform: translateX(20px);
}

/* PRINT STYLES */
@media print {
    .compact-header,
    .sidebar-compact,
    .search-container-compact,
    .layer-menu-compact,
    .map-controls-bottom,
    .stats-display-compact {
        display: none !important;
    }
    
    #map {
        margin-left: 0 !important;
        width: 100% !important;
    }
}

/* ACCESSIBILITY IMPROVEMENTS */
.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

/* FOCUS STYLES */
button:focus,
input:focus,
.action-btn-compact:focus {
    outline: 2px solid var(--accent-gold);
    outline-offset: 2px;
}

/* HIGH CONTRAST MODE SUPPORT */
@media (prefers-contrast: high) {
    .compact-header,
    .sidebar-compact,
    .search-container-compact {
        border-width: 3px;
    }
}

/* REDUCED MOTION SUPPORT */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

    </style>
</head>
<body>
    <!-- Registration Modal -->
    <div class="registration-modal" id="registrationModal">
        <div class="registration-content">
            <div class="registration-logo">
                <svg class="pyramason-logo" viewBox="0 0 200 200">
                    <defs>
                        <linearGradient id="pyramidGold" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#D4AF37;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="pyramidPurple" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#9C27B0;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#6A1B9A;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <polygon points="100,40 40,160 160,160" fill="url(#pyramidGold)" stroke="#4A148C" stroke-width="3"/>
                    <polygon points="100,40 40,160 100,140" fill="url(#pyramidPurple)" opacity="0.8"/>
                    <polygon points="100,40 160,160 100,140" fill="url(#pyramidPurple)" opacity="0.6"/>
                    <circle cx="100" cy="90" r="22" fill="#FFD700" stroke="#4A148C" stroke-width="2.5"/>
                    <circle cx="100" cy="90" r="14" fill="#4A148C"/>
                    <circle cx="100" cy="90" r="7" fill="#00BCD4">
                        <animate attributeName="r" values="7;9;7" dur="2s" repeatCount="indefinite"/>
                    </circle>
                </svg>
            </div>
            
            <h1 class="registration-title">PYRAMASON</h1>
            <p class="registration-subtitle">Ultimate Ancient Mysteries Research Platform</p>
            
            <div class="registration-features">
                <div class="feature-item">50,000+ Ancient Sites Worldwide</div>
                <div class="feature-item">Advanced Sacred Geometry Analysis</div>
                <div class="feature-item">Real-Time Astronomical Calculations</div>
                <div class="feature-item">Ley Lines Detection & Statistics</div>
                <div class="feature-item">Site Clustering & Pattern Recognition</div>
                <div class="feature-item">Community Research & Collections</div>
                <div class="feature-item">Complete Data Export Tools</div>
                <div class="feature-item">Acoustic & Magnetic Analysis</div>
            </div>
            
            <form class="registration-form" onsubmit="handleRegistration(event)">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="regEmail" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="regUsername" placeholder="Choose a username" required minlength="3">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="regPassword" placeholder="Create a password" required minlength="6">
                </div>
                <button type="submit" class="registration-btn">
                    <span style="position: relative; z-index: 1;">Create Account</span>
                </button>
                <button type="button" class="guest-btn" onclick="continueAsGuest()">Continue as Guest</button>
                <div style="margin-top: 10px; text-align: center; font-size: 11px; color: rgba(255,255,255,0.5);">
                    By creating an account, you agree to our Terms of Service
                </div>
            </form>
        </div>
    </div>
    
    <!-- Map -->
    <div id="map"></div>
    
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
    </div>
    
    <!-- Compact Sidebar -->
    <div class="sidebar">
        <div class="sidebar-logo">
            <svg viewBox="0 0 200 200">
                <defs>
                    <linearGradient id="miniGold" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#D4AF37;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <polygon points="100,40 40,160 160,160" fill="url(#miniGold)" stroke="#4A148C" stroke-width="3"/>
                <circle cx="100" cy="90" r="20" fill="#FFD700"/>
                <circle cx="100" cy="90" r="12" fill="#4A148C"/>
                <circle cx="100" cy="90" r="6" fill="#00BCD4"/>
            </svg>
        </div>
        
        <div class="sidebar-divider"></div>
        
        <button class="sidebar-btn" onclick="toggleUnifiedPanel()" title="Analysis Panel">📊</button>
        <button class="sidebar-btn" onclick="showHelp()" title="Help & Tutorial">❓</button>
        <button class="sidebar-btn active" id="layerToggle" onclick="quickToggleLayers()" title="Toggle Layers">🗺️</button>
        <button class="sidebar-btn" onclick="showCollections()" title="My Collections">⭐</button>
        
        <div class="sidebar-divider"></div>
        
        <button class="sidebar-btn" onclick="exportData()" title="Export Data">💾</button>
        <button class="sidebar-btn" onclick="clearAllDrawings()" title="Clear Map">🧹</button>
        <button class="sidebar-btn" onclick="resetMapView()" title="Reset View">🔄</button>
    </div>
    
<!-- Compact Search Bar -->
<div class="search-container-compact">
    <div class="search-box-compact">
        <input type="text" 
               class="search-input-compact" 
               id="searchInput" 
               placeholder="Search ancient sites..." 
               onkeypress="if(event.key==='Enter')searchSites()">
        <button class="search-button-compact" onclick="searchSites()">🔍</button>
    </div>
</div>
    
    <!-- Compact Map Controls -->
    <div class="map-controls">
        <button class="control-btn" id="satelliteBtn" onclick="toggleMapType()" title="Satellite View">🛰️</button>
        class="action-btn" onclick="toggleMapLabels(!labelsVisible); labelsVisible = !labelsVisible;">
    <span class="btn-icon">🏷️</span>
    <span id="labelsText">Show Labels</span>
        <button class="control-btn" id="3dBtn" onclick="toggle3D()" title="3D Terrain">🏔️</button>
        <button class="control-btn" id="locationBtn" onclick="goToMyLocation()" title="My Location">📍</button>
    </div>
    
    <!-- Stats Badge -->
    <div class="stats-badge" id="statsBadge">
        <span class="stats-icon">📍</span>
        <span>Loading sites...</span>
    </div>
    
    <!-- Measurement Display -->
    <div class="measurement-display" id="measurementDisplay">
        <div class="measurement-title">📏 Distance</div>
        <div class="measurement-value" id="measurementValue">0.00</div>
        <div class="measurement-subtitle">kilometers</div>
    </div>
    
    <!-- UNIFIED ANALYSIS PANEL -->
    <div class="unified-panel" id="unifiedPanel">
        <div class="panel-header">
            <div class="panel-title">
                <span>📊</span>
                <span>Analysis & Research Tools</span>
            </div>
            <button class="close-panel" onclick="toggleUnifiedPanel()">×</button>
        </div>
        
        <div class="panel-tabs">
            <div class="panel-tab active" onclick="switchTab('layers')">🗺️ Layers</div>
            <div class="panel-tab" onclick="switchTab('filters')">🔍 Filters</div>
            <div class="panel-tab" onclick="switchTab('geometry')">📐 Geometry</div>
            <div class="panel-tab" onclick="switchTab('astronomy')">🌟 Astronomy</div>
            <div class="panel-tab" onclick="switchTab('analysis')">📊 Analysis</div>
            <div class="panel-tab" onclick="switchTab('data')">💾 Data</div>
            <div class="panel-tab" onclick="switchTab('community')">👥 Community</div>
        </div>
        
        <!-- LAYERS TAB -->
        <div class="tab-content active" id="tab-layers">
            <div class="info-box">
                <div class="info-box-title">🗺️ Site Layers Control</div>
                <div class="info-box-text">
                    Toggle different types of ancient sites on the map. Each layer can be controlled independently.
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Primary Site Types</div>
                <div class="filter-option" onclick="toggleFilter('pyramids', this)">
                    <div class="filter-checkbox checked"></div>
                    <div class="filter-label">🔺 Pyramids (Global)</div>
                </div>
                <div class="filter-option" onclick="toggleFilter('megaliths', this)">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">🗿 All Megalithic Structures</div>
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Megalithic Subtypes</div>
                <div class="filter-option" onclick="toggleFilter('megalithsBurials', this)" style="padding-left: 15px;">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">⬛ Burial Chambers & Tombs</div>
                </div>
                <div class="filter-option" onclick="toggleFilter('megalithsStones', this)" style="padding-left: 15px;">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">▲ Standing Stones & Circles</div>
                </div>
                <div class="filter-option" onclick="toggleFilter('megalithsRockArt', this)" style="padding-left: 15px;">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">⭕ Rock Art & Carvings</div>
                </div>
                <div class="filter-option" onclick="toggleFilter('megalithsSettlements', this)" style="padding-left: 15px;">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">🏠 Ancient Settlements</div>
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Quick Layer Actions</div>
                <button class="action-btn" onclick="showAllLayers()">
                    <span class="btn-icon">👁️</span>
                    <span>Show All Layers</span>
                </button>
                <button class="action-btn" onclick="hideAllLayers()">
                    <span class="btn-icon">🙈</span>
                    <span>Hide All Layers</span>
                </button>
                <button class="action-btn" onclick="toggleMegalithsOnly()">
                    <span class="btn-icon">🗿</span>
                    <span>Megaliths Only</span>
                </button>
                <button class="action-btn" onclick="togglePyramidsOnly()">
                    <span class="btn-icon">🔺</span>
                    <span>Pyramids Only</span>
                </button>
            </div>
        </div>
        
        <!-- FILTERS TAB -->
        <div class="tab-content" id="tab-filters">
            <div class="info-box">
                <div class="info-box-title">🔍 Advanced Filtering</div>
                <div class="info-box-text">
                    Filter sites by historical period, purpose, civilization, and geographic features.
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Historical Timeline</div>
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Time Period</span>
                        <span id="timelineValue" style="color: var(--accent-gold);">All Eras</span>
                    </div>
                    <input type="range" class="slider" id="timelineSlider" 
                           min="-10000" max="2025" value="2025" step="50"
                           oninput="updateTimeline(this.value)">
                    <div class="slider-marks">
                        <span>10,000 BCE</span>
                        <span>5000 BCE</span>
                        <span>0 CE</span>
                        <span>1000 CE</span>
                        <span>Present</span>
                    </div>
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Quick Period Selection</div>
                <button class="action-btn" onclick="setPeriod(-10000, -3000)">
                    <span class="btn-icon">🌅</span>
                    <span>Prehistoric Era (10,000-3000 BCE)</span>
                </button>
                <button class="action-btn" onclick="setPeriod(-3000, -1000)">
                    <span class="btn-icon">🏺</span>
                    <span>Bronze Age (3000-1000 BCE)</span>
                </button>
                <button class="action-btn" onclick="setPeriod(-1000, 500)">
                    <span class="btn-icon">⚔️</span>
                    <span>Classical Era (1000 BCE-500 CE)</span>
                </button>
                <button class="action-btn" onclick="setPeriod(500, 1500)">
                    <span class="btn-icon">🏰</span>
                    <span>Medieval Period (500-1500 CE)</span>
                </button>
                <button class="action-btn" onclick="setPeriod(-10000, 2025)">
                    <span class="btn-icon">🌍</span>
                    <span>All Time Periods</span>
                </button>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Site Purpose & Function</div>
                <div class="filter-option" onclick="togglePurposeFilter('burial', this)">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">⚰️ Burial / Tomb / Cemetery</div>
                </div>
                <div class="filter-option" onclick="togglePurposeFilter('temple', this)">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">⛪ Temple / Religious / Sacred</div>
                </div>
                <div class="filter-option" onclick="togglePurposeFilter('observatory', this)">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">🔭 Observatory / Astronomical</div>
                </div>
                <div class="filter-option" onclick="togglePurposeFilter('settlement', this)">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">🏘️ Settlement / City / Village</div>
                </div>
                <div class="filter-option" onclick="togglePurposeFilter('fortress', this)">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">🛡️ Fortress / Defensive Structure</div>
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Civilization & Culture</div>
                <div class="filter-option" onclick="toggleCivilizationFilter('egyptian', this)">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">🇪🇬 Ancient Egyptian</div>
                </div>
                <div class="filter-option" onclick="toggleCivilizationFilter('mayan', this)">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">🏛️ Mayan / Mesoamerican</div>
                </div>
                <div class="filter-option" onclick="toggleCivilizationFilter('celtic', this)">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">🍀 Celtic / Druidic</div>
                </div>
                <div class="filter-option" onclick="toggleCivilizationFilter('chinese', this)">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">🏯 Ancient Chinese</div>
                </div>
                <div class="filter-option" onclick="toggleCivilizationFilter('incan', this)">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">🏔️ Incan / Andean</div>
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Geographic Features</div>
                <div class="filter-option" onclick="toggleGeographicFilter('water', this)">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">💧 Near Water (Rivers/Lakes)</div>
                </div>
                <div class="filter-option" onclick="toggleGeographicFilter('mountain', this)">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">⛰️ Mountain / Highland Sites</div>
                </div>
                <div class="filter-option" onclick="toggleGeographicFilter('desert', this)">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">🏜️ Desert / Arid Regions</div>
                </div>
                <div class="filter-option" onclick="toggleGeographicFilter('coastal', this)">
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">🌊 Coastal / Maritime</div>
                </div>
            </div>
            
            <button class="action-btn primary" onclick="applyFilters()">
                <span class="btn-icon">✓</span>
                <span>Apply All Filters</span>
            </button>
            <button class="action-btn" onclick="clearFilters()">
                <span class="btn-icon">🔄</span>
                <span>Reset All Filters</span>
            </button>
        </div>
        
        <!-- GEOMETRY TAB -->
        <div class="tab-content" id="tab-geometry">
            <div class="info-box">
                <div class="info-box-title">📐 Sacred Geometry Analysis</div>
                <div class="info-box-text">
                    Detect mathematical patterns, proportions, and geometric relationships between ancient sites using advanced algorithms.
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Pattern Detection</div>
                <button class="action-btn primary" onclick="detectGoldenRatio()">
                    <span class="btn-icon">φ</span>
                    <span>Golden Ratio (φ = 1.618)</span>
                </button>
                <button class="action-btn" onclick="detectFibonacciSpiral()">
                    <span class="btn-icon">🌀</span>
                    <span>Fibonacci Spiral Patterns</span>
                </button>
                <button class="action-btn" onclick="detectEquilateralTriangles()">
                    <span class="btn-icon">△</span>
                    <span>Equilateral Triangles</span>
                </button>
                <button class="action-btn" onclick="detectPythagoreanTriangles()">
                    <span class="btn-icon">∟</span>
                    <span>Pythagorean Triangles (3-4-5)</span>
                </button>
                <button class="action-btn" onclick="detectPerfectSquares()">
                    <span class="btn-icon">⬛</span>
                    <span>Perfect Squares & Rectangles</span>
                </button>
                <button class="action-btn" onclick="detectCircularFormations()">
                    <span class="btn-icon">⭕</span>
                    <span>Circular Formations</span>
                </button>
                <button class="action-btn" onclick="detectLinearAlignments()">
                    <span class="btn-icon">—</span>
                    <span>Linear Alignments</span>
                </button>
                <button class="action-btn" onclick="detectVesicaPiscis()">
                    <span class="btn-icon">∞</span>
                    <span>Vesica Piscis</span>
                </button>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Advanced Analysis</div>
                <button class="action-btn primary" onclick="detectAllGeometricPatterns()">
                    <span class="btn-icon">🔍</span>
                    <span>Detect All Patterns (Comprehensive)</span>
                </button>
                <button class="action-btn" onclick="showGeometricNetwork()">
                    <span class="btn-icon">🕸️</span>
                    <span>Show Geometric Network</span>
                </button>
                <button class="action-btn" onclick="calculateSacredProportions()">
                    <span class="btn-icon">📏</span>
                    <span>Sacred Proportions Analysis</span>
                </button>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Ley Lines Detection</div>
                <button class="action-btn primary" onclick="autoDetectLeyLines()">
                    <span class="btn-icon">〰️</span>
                    <span>Auto-Detect Ley Lines</span>
                </button>
                <button class="action-btn" onclick="showEarthEnergyGrid()">
                    <span class="btn-icon">🌐</span>
                    <span>Earth Energy Grid (Platonic Solids)</span>
                </button>
                <button class="action-btn" onclick="findNearestLeyLine()">
                    <span class="btn-icon">📍</span>
                    <span>Find Nearest Ley Line</span>
                </button>
                
                <div class="slider-container" style="margin-top: 20px;">
                    <div class="slider-label">
                        <span>Alignment Tolerance</span>
                        <span id="leyLineThreshold" style="color: var(--accent-gold);">3.0°</span>
                    </div>
                    <input type="range" class="slider" min="0.5" max="10" value="3" step="0.5"
                           oninput="updateLeyLineThreshold(this.value)">
                    <div class="slider-marks">
                        <span>Strict (0.5°)</span>
                        <span>Moderate</span>
                        <span>Loose (10°)</span>
                    </div>
                </div>
            </div>
            
            <div id="geometryResults" class="results-container" style="display: none;">
                <div class="filter-title">🎯 Detection Results</div>
                <div id="geometryResultsList"></div>
            </div>
            
            <div class="info-box" style="margin-top: 20px;">
                <div class="info-box-title">ℹ️ Analysis Notes</div>
                <div class="info-box-text">
                    Geometric patterns are detected using the Haversine formula for accurate Earth-surface distances. 
                    Results include statistical probability scores and margin of error calculations.
                </div>
            </div>
        </div>
        
        <!-- Continue in next message due to length... -->
    
        <!-- ASTRONOMY TAB -->
        <div class="tab-content" id="tab-astronomy">
            <div class="info-box">
                <div class="info-box-title">🌟 Astronomical Analysis</div>
                <div class="info-box-text">
                    Calculate solar and lunar alignments, star positions, and celestial events with precision astronomy algorithms.
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Solar Analysis</div>
                <button class="action-btn primary" onclick="calculateCurrentSunPosition()">
                    <span class="btn-icon">☀️</span>
                    <span>Current Sun Position</span>
                </button>
                <button class="action-btn" onclick="calculateSunrise()">
                    <span class="btn-icon">🌅</span>
                    <span>Sunrise Direction & Time</span>
                </button>
                <button class="action-btn" onclick="calculateSunset()">
                    <span class="btn-icon">🌄</span>
                    <span>Sunset Direction & Time</span>
                </button>
                <button class="action-btn" onclick="calculateSolsticeAlignments()">
                    <span class="btn-icon">🌞</span>
                    <span>Solstice Alignments (Summer/Winter)</span>
                </button>
                <button class="action-btn" onclick="calculateEquinoxAlignments()">
                    <span class="btn-icon">⚖️</span>
                    <span>Equinox Alignments (Spring/Autumn)</span>
                </button>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Lunar Analysis</div>
                <button class="action-btn" onclick="showCurrentMoonPhase()">
                    <span class="btn-icon">🌙</span>
                    <span>Current Moon Phase</span>
                </button>
                <button class="action-btn" onclick="calculateMoonrise()">
                    <span class="btn-icon">🌛</span>
                    <span>Moonrise Direction & Time</span>
                </button>
                <button class="action-btn" onclick="calculateLunarStandstills()">
                    <span class="btn-icon">🌕</span>
                    <span>Lunar Standstills (18.6 yr cycle)</span>
                </button>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Stellar & Planetary</div>
                <button class="action-btn primary" onclick="showLiveNatalChart()">
                    <span class="btn-icon">♈</span>
                    <span>Live Natal Chart (Current Sky)</span>
                </button>
                <button class="action-btn" onclick="showStarPositions()">
                    <span class="btn-icon">✨</span>
                    <span>Current Star Positions</span>
                </button>
                <button class="action-btn" onclick="calculatePrecession()">
                    <span class="btn-icon">🔄</span>
                    <span>Precession Calculator (Historical Sky)</span>
                </button>
                <button class="action-btn" onclick="showPlanetaryAlignments()">
                    <span class="btn-icon">🪐</span>
                    <span>Planetary Alignments</span>
                </button>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Site Orientation Analysis</div>
                <button class="action-btn" onclick="analyzeSiteOrientations()">
                    <span class="btn-icon">🧭</span>
                    <span>Analyze All Site Orientations</span>
                </button>
                <button class="action-btn" onclick="findCardinalAlignments()">
                    <span class="btn-icon">🧲</span>
                    <span>Cardinal Direction Alignments</span>
                </button>
            </div>
            
            <div id="astronomyResults" class="results-container" style="display: none;">
                <div class="filter-title">🌟 Astronomy Results</div>
                <div id="astronomyResultsList"></div>
            </div>
            
            <div class="info-box" style="margin-top: 20px;">
                <div class="info-box-title">📚 Experimental Feature</div>
                <div class="info-box-text">
                    Natal chart and astronomical calculations are for research into ancient astronomy and archaeoastronomy. 
                    Algorithms use Julian day conversions and VSOP87 planetary theory.
                </div>
            </div>
        </div>
        
        <!-- ANALYSIS TAB -->
        <div class="tab-content" id="tab-analysis">
            <div class="info-box">
                <div class="info-box-title">📊 Advanced Pattern Analysis</div>
                <div class="info-box-text">
                    Comprehensive statistical analysis of site distributions, patterns, and correlations.
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Spatial Analysis</div>
                <button class="action-btn primary" onclick="performClusterAnalysis()">
                    <span class="btn-icon">📍</span>
                    <span>Site Clustering Analysis</span>
                </button>
                <button class="action-btn" onclick="densityHeatmap()">
                    <span class="btn-icon">🔥</span>
                    <span>Density Heatmap</span>
                </button>
                <button class="action-btn" onclick="proximityAnalysis()">
                    <span class="btn-icon">📏</span>
                    <span>Proximity Analysis (Nearest Neighbors)</span>
                </button>
                <button class="action-btn" onclick="distributionAnalysis()">
                    <span class="btn-icon">📈</span>
                    <span>Distribution Patterns</span>
                </button>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Environmental Correlations</div>
                <button class="action-btn" onclick="waterProximityAnalysis()">
                    <span class="btn-icon">💧</span>
                    <span>Water Source Proximity</span>
                </button>
                <button class="action-btn" onclick="elevationAnalysis()">
                    <span class="btn-icon">⛰️</span>
                    <span>Elevation Profile Analysis</span>
                </button>
                <button class="action-btn" onclick="topographyAnalysis()">
                    <span class="btn-icon">🗻</span>
                    <span>Topography Correlation</span>
                </button>
                <button class="action-btn" onclick="geologicalAnalysis()">
                    <span class="btn-icon">🪨</span>
                    <span>Geological Features</span>
                </button>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Construction Analysis</div>
                <button class="action-btn" onclick="materialAnalysis()">
                    <span class="btn-icon">🏗️</span>
                    <span>Construction Materials</span>
                </button>
                <button class="action-btn" onclick="orientationStatistics()">
                    <span class="btn-icon">🧭</span>
                    <span>Orientation Statistics</span>
                </button>
                <button class="action-btn" onclick="sizeDistribution()">
                    <span class="btn-icon">📊</span>
                    <span>Size Distribution Analysis</span>
                </button>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Specialized Analysis</div>
                <button class="action-btn" onclick="acousticAnalysis()">
                    <span class="btn-icon">🎵</span>
                    <span>Acoustic Phenomena Sites</span>
                </button>
                <button class="action-btn" onclick="magneticAnomalies()">
                    <span class="btn-icon">🧲</span>
                    <span>Magnetic Anomaly Analysis</span>
                </button>
                <button class="action-btn" onclick="resonanceAnalysis()">
                    <span class="btn-icon">〰️</span>
                    <span>Resonance & Frequency Analysis</span>
                </button>
                <button class="action-btn" onclick="undergroundFeatures()">
                    <span class="btn-icon">⬇️</span>
                    <span>Underground Structure Detection</span>
                </button>
            </div>
            
            <div id="analysisResults" class="results-container" style="display: none;">
                <div class="filter-title">📊 Analysis Results</div>
                <div id="analysisResultsList"></div>
            </div>

<!-- Advanced Analysis Buttons -->
<div class="filter-group">
    <div class="filter-title">Advanced Analysis Tools</div>
    
    <button class="action-btn" onclick="activateFrequencyAnalysis(map.getCenter().lat(), map.getCenter().lng())">
        <span class="btn-icon">🎵</span>
        <span>Frequency Analysis (333Hz)</span>
    </button>
    
    <button class="action-btn" onclick="activateTetrahedronGrid()">
        <span class="btn-icon">🔷</span>
        <span>Tetrahedron Grid (19.5°)</span>
    </button>
    
    <button class="action-btn" onclick="activatePlatonicGrid()">
        <span class="btn-icon">🌐</span>
        <span>Platonic Solids Grid</span>
    </button>
    
    <button class="action-btn" onclick="findGoldenRatioPatterns()">
        <span class="btn-icon">🔺</span>
        <span>Golden Ratio Patterns</span>
    </button>
    
    <button class="action-btn" onclick="clearAllOverlays()">
        <span class="btn-icon">🧹</span>
        <span>Clear All Overlays</span>
    </button>
</div>

        </div>
        
        <!-- DATA TAB -->
        <div class="tab-content" id="tab-data">
            <div class="info-box">
                <div class="info-box-title">💾 Data Management & Export</div>
                <div class="info-box-text">
                    Export site data, generate reports, and manage your research collections.
                </div>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Export Options</div>
                <button class="action-btn primary" onclick="exportVisibleSitesCSV()">
                    <span class="btn-icon">📊</span>
                    <span>Export to CSV (Spreadsheet)</span>
                </button>
                <button class="action-btn" onclick="exportVisibleSitesJSON()">
                    <span class="btn-icon">💾</span>
                    <span>Export to JSON (Database)</span>
                </button>
                <button class="action-btn" onclick="exportToKML()">
                    <span class="btn-icon">🌍</span>
                    <span>Export to KML (Google Earth)</span>
                </button>
                <button class="action-btn" onclick="exportToGeoJSON()">
                    <span class="btn-icon">🗺️</span>
                    <span>Export to GeoJSON (GIS)</span>
                </button>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Reports & Documentation</div>
                <button class="action-btn primary" onclick="generateAnalysisReport()">
                    <span class="btn-icon">📄</span>
                    <span>Generate Analysis Report (PDF)</span>
                </button>
                <button class="action-btn" onclick="generateSiteCatalog()">
                    <span class="btn-icon">📚</span>
                    <span>Site Catalog with Details</span>
                </button>
                <button class="action-btn" onclick="exportResearchNotes()">
                    <span class="btn-icon">📝</span>
                    <span>Export Research Notes</span>
                </button>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">My Collections</div>
                <button class="action-btn" onclick="viewMyCollections()">
                    <span class="btn-icon">⭐</span>
                    <span>View Saved Sites</span>
                </button>
                <button class="action-btn" onclick="createNewCollection()">
                    <span class="btn-icon">➕</span>
                    <span>Create New Collection</span>
                </button>
                <button class="action-btn" onclick="exportCollections()">
                    <span class="btn-icon">💾</span>
                    <span>Export All Collections</span>
                </button>
                <button class="action-btn" onclick="shareCollection()">
                    <span class="btn-icon">🔗</span>
                    <span>Share Collection Link</span>
                </button>
            </div>
            
            <div class="info-box">
                <div class="info-box-title">📊 Current View Statistics</div>
                <div id="viewStats" style="margin-top: 10px; font-size: 14px; line-height: 1.8;">
                    <strong style="color: var(--accent-gold);">Total Sites:</strong> <span id="statTotal">0</span><br>
                    <strong style="color: var(--light-cyan);">Visible:</strong> <span id="statVisible">0</span><br>
                    <strong style="color: var(--accent-gold);">Pyramids:</strong> <span id="statPyramids">0</span><br>
                    <strong style="color: var(--light-cyan);">Megaliths:</strong> <span id="statMegaliths">0</span><br>
                    <strong style="color: var(--accent-gold);">Zoom Level:</strong> <span id="statZoom">3</span><br>
                    <strong style="color: var(--light-cyan);">Map Center:</strong> <span id="statCenter">29.98°N, 31.13°E</span>
                </div>
            </div>
        </div>
        
        <!-- COMMUNITY TAB -->
        <div class="tab-content" id="tab-community">
            <div class="info-box">
                <div class="info-box-title">🔒 Advanced Community Features</div>
                <div class="info-box-text">
                    Sign up for a free account to access annotations, collections, hypothesis sharing, and collaborative research tools.
                </div>
            </div>
            
            <div class="filter-group" id="communityGuestView">
                <div class="filter-title">Join the Community</div>
                <button class="action-btn primary" onclick="showRegistration()">
                    <span class="btn-icon">✨</span>
                    <span>Create Free Account</span>
                </button>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,215,0,0.05); border-radius: 10px; border: 1px solid var(--border-color);">
                    <div style="font-weight: 700; color: var(--accent-gold); margin-bottom: 12px; font-size: 14px;">
                        🌟 Member Benefits
                    </div>
                    <div style="font-size: 13px; color: rgba(255,255,255,0.85); line-height: 1.8;">
                        ✓ Save unlimited sites to collections<br>
                        ✓ Add annotations and research notes<br>
                        ✓ Share hypotheses with community<br>
                        ✓ Join discussion forums<br>
                        ✓ Submit new site discoveries<br>
                        ✓ Collaborative research projects<br>
                        ✓ Earn badges and recognition<br>
                        ✓ API access for data integration<br>
                        ✓ Priority support
                    </div>
                </div>
            </div>
            
            <div class="filter-group" id="communityMemberView" style="display: none;">
                <div class="filter-title">My Activity</div>
                <button class="action-btn" onclick="viewMyAnnotations()">
                    <span class="btn-icon">📝</span>
                    <span>My Annotations & Notes</span>
                </button>
                <button class="action-btn" onclick="viewMyHypotheses()">
                    <span class="btn-icon">💡</span>
                    <span>My Research Hypotheses</span>
                </button>
                <button class="action-btn" onclick="viewMyContributions()">
                    <span class="btn-icon">🏆</span>
                    <span>My Contributions & Badges</span>
                </button>
                <button class="action-btn" onclick="viewMyProfile()">
                    <span class="btn-icon">👤</span>
                    <span>My Profile & Settings</span>
                </button>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Community Discovery</div>
                <button class="action-btn" onclick="viewRecentDiscoveries()">
                    <span class="btn-icon">🆕</span>
                    <span>Recent Site Discoveries</span>
                </button>
                <button class="action-btn" onclick="viewTrendingSites()">
                    <span class="btn-icon">🔥</span>
                    <span>Trending Sites This Week</span>
                </button>
                <button class="action-btn" onclick="viewFeaturedResearch()">
                    <span class="btn-icon">🌟</span>
                    <span>Featured Research Papers</span>
                </button>
                <button class="action-btn" onclick="viewLeaderboard()">
                    <span class="btn-icon">🏆</span>
                    <span>Community Leaderboard</span>
                </button>
            </div>
            
            <div class="filter-group">
                <div class="filter-title">Collaboration</div>
                <button class="action-btn" onclick="findResearchPartners()">
                    <span class="btn-icon">🤝</span>
                    <span>Find Research Partners</span>
                </button>
                <button class="action-btn" onclick="joinResearchProject()">
                    <span class="btn-icon">🔬</span>
                    <span>Join Research Project</span>
                </button>
                <button class="action-btn" onclick="viewDiscussionForums()">
                    <span class="btn-icon">💬</span>
                    <span>Discussion Forums</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="copyCoordinates()">
            <span class="context-menu-icon">📋</span>
            <span>Copy Coordinates</span>
        </div>
        <div class="context-menu-item" onclick="measureFromHere()">
            <span class="context-menu-icon">📏</span>
            <span>Measure From Here</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="findAntipode()">
            <span class="context-menu-icon">🌍</span>
            <span>Find Antipode Point</span>
        </div>
        <div class="context-menu-item" onclick="detectNearbyGeometry()">
            <span class="context-menu-icon">📐</span>
            <span>Detect Nearby Geometry</span>
        </div>
        <div class="context-menu-item" onclick="findNearbyLeyLines()">
            <span class="context-menu-icon">〰️</span>
            <span>Find Ley Lines</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="calculateAstronomyHere()">
            <span class="context-menu-icon">⭐</span>
            <span>Astronomical Analysis</span>
        </div>
        <div class="context-menu-item" onclick="addCustomMarker()">
            <span class="context-menu-icon">📍</span>
            <span>Add Custom Marker</span>
        </div>
        <div class="context-menu-item" onclick="saveThisLocation()">
            <span class="context-menu-icon">💾</span>
            <span>Save to Collection</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="streetViewHere()">
            <span class="context-menu-icon">👁️</span>
            <span>Open Street View</span>
        </div>
        <div class="context-menu-item" onclick="get3DElevation()">
            <span class="context-menu-icon">🏔️</span>
            <span>Get Elevation Data</span>
        </div>
    </div>
    
    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-icon" id="modalIcon">✨</div>
                <div class="modal-title" id="modalTitle">Modal Title</div>
            </div>
            <div class="modal-body" id="modalBody">Modal content</div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-primary" id="modalPrimaryBtn" onclick="closeModal()">OK</button>
                <button class="modal-btn modal-btn-secondary" id="modalSecondaryBtn" onclick="closeModal()" style="display:none;">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================================================
        // CONFIGURATION & GLOBAL STATE
        // ============================================================================
        
        const CONFIG = {
            GOOGLE_MAPS_API_KEY: 'AIzaSyB16lIKUClrBSHvAJZLq584GG4vZUaa3HQ',
            SUPABASE_URL: 'https://hrfmssliipurbyxivanc.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhyZm1zc2xpaXB1cmJ5eGl2YW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzgxNTIsImV4cCI6MjA3ODAxNDE1Mn0.DB9vrjGYYtkCgnSm25sn1y_7Yr3YJTkuayWlp1_s4io',
            DEFAULT_CENTER: { lat: 29.9792, lng: 31.1342 }, // Great Pyramid of Giza
            DEFAULT_ZOOM: 3,
            PYRAMID_DATABASE_URL: 'https://cdn.shopify.com/s/files/1/0853/8701/8573/files/pyramids_data.json?v=1762027215',
            MEGALITH_DATABASES: {
                burials: 'https://cdn.shopify.com/s/files/1/0853/8701/8573/files/megalithic_sites_burials_and_tombs.json?v=1762348072',
                stones: 'https://cdn.shopify.com/s/files/1/0853/8701/8573/files/megalithic_sites_standing_stones_and_circles.json?v=1762347327',
                rockart: 'https://cdn.shopify.com/s/files/1/0853/8701/8573/files/megalithic_sites_rock_art_and_carvings.json?v=1762347285',
                settlements: 'https://cdn.shopify.com/s/files/1/0853/8701/8573/files/megalithic_sites_settlements_and_other.json?v=1762347305'
            }
        };
        
        // Global State
        let map, markerClusterer;
        let markers = [], drawings = [], overlays = [];
        let allSites = [], pyramidSites = [], megalithSites = [];
        let filteredSites = [];
        let currentUser = null;
        let contextMenuLatLng = null;
        let measurementMode = null;
        let measurementPoints = [];
        let measurementMarkers = [];
        
        // Layer visibility
        let layersVisible = {
            pyramids: true,
            megaliths: false,
            megalithsBurials: false,
            megalithsStones: false,
            megalithsRockArt: false,
            megalithsSettlements: false
        };
        
        // Filter states
        let activeFilters = {
            timeline: 2025,
            purposes: new Set(),
            civilizations: new Set(),
            geographic: new Set()
        };
        
        let userReady = false;
        let mapsLoaded = false;
        let currentMapType = 'roadmap';
        let is3DEnabled = false;
        let labelsEnabled = false;
        let labelsVisible = false;

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        function checkRegistration() {
            const userData = localStorage.getItem('pyramason_user');
            if (userData) {
                try {
                    currentUser = JSON.parse(userData);
                    document.getElementById('registrationModal').style.display = 'none';
                    document.getElementById('communityGuestView').style.display = 'none';
                    document.getElementById('communityMemberView').style.display = 'block';
                    userReady = true;
                    if (mapsLoaded) initMap();
                } catch(e) {
                    console.error('Error parsing user data:', e);
                    localStorage.removeItem('pyramason_user');
                    document.getElementById('registrationModal').style.display = 'flex';
                }
            } else {
                document.getElementById('registrationModal').style.display = 'flex';
            }
        }
        
        function handleRegistration(event) {
            event.preventDefault();
            const email = document.getElementById('regEmail').value;
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            
            if (!email || !username || !password) {
                showModal('⚠️', 'Missing Information', 'Please fill in all fields.');
                return;
            }
            
            const userData = {
                email: email,
                username: username,
                registeredAt: new Date().toISOString(),
                subscription: 'free',
                points: 0,
                level: 'Seeker',
                collections: [],
                annotations: [],
                badges: ['🎓 New Member']
            };
            
            try {
                localStorage.setItem('pyramason_user', JSON.stringify(userData));
                currentUser = userData;
                document.getElementById('registrationModal').style.display = 'none';
                document.getElementById('communityGuestView').style.display = 'none';
                document.getElementById('communityMemberView').style.display = 'block';
                userReady = true;
                
                showModal('✨', `Welcome, ${username}!`, 
                    `Your account has been created successfully! You now have access to all advanced features including:<br><br>
                    • Unlimited site collections<br>
                    • Research annotations<br>
                    • Community features<br>
                    • Data export tools<br>
                    • And much more!<br><br>
                    Happy exploring! 🔍`);
                
                if (mapsLoaded) initMap();
            } catch(e) {
                console.error('Error saving user data:', e);
                showModal('❌', 'Error', 'Failed to create account. Please try again.');
            }
        }
        
        function continueAsGuest() {
            currentUser = { guest: true };
            document.getElementById('registrationModal').style.display = 'none';
            userReady = true;
            
            showModal('👋', 'Guest Mode', 
                'You\'re using Pyramason in guest mode. Some features like collections and annotations are limited.<br><br>' +
                'Create a free account anytime to unlock all features!');
            
            if (mapsLoaded) initMap();
        }
        
        function initMap() {
            mapsLoaded = true;
            if (!userReady) {
                console.log('Maps loaded, waiting for user...');
                return;
            }
            
            console.log('🗺️ Initializing Pyramason map...');
            
            // Initialize Google Map
            map = new google.maps.Map(document.getElementById('map'), {
                center: CONFIG.DEFAULT_CENTER,
                zoom: CONFIG.DEFAULT_ZOOM,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                styles: [
                    { featureType: 'all', elementType: 'labels', stylers: [{ visibility: 'off' }] },
                    { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0a1128' }] },
                    { featureType: 'landscape', elementType: 'geometry', stylers: [{ color: '#1a1a2e' }] },
                    { featureType: 'administrative.country', elementType: 'geometry.stroke', 
                      stylers: [{ color: '#6A1B9A' }, { weight: 0.5 }] }
                ],
                streetViewControl: true,
                mapTypeControl: false,
                fullscreenControl: false,
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.LEFT_BOTTOM
                }
            });
            
            // Event listeners
            map.addListener('rightclick', e => showContextMenu(e));
            map.addListener('click', () => {
                hideContextMenu();
                if (measurementMode) handleMeasurementClick(event);
            });
            map.addListener('zoom_changed', updateMapStats);
            map.addListener('center_changed', updateMapStats);
            
            // Load site data
            loadAllSites();
            
            console.log('✅ Map initialized successfully!');
        }
        
    // Initialize advanced features
    if (typeof PyramasonAdvanced !== 'undefined') {
        PyramasonAdvanced.initialize(map);
        console.log('✅ Advanced features initialized');
    }

// Frequency Analysis
function activateFrequencyAnalysis(siteLat, siteLng) {
    const freq = PyramasonAdvanced.calculateSiteFrequency(siteLat, siteLng);
    const html = PyramasonAdvanced.displayFrequencyAnalysis({ lat: siteLat, lng: siteLng });
    showModal('🎵 Frequency Analysis', '', html);
}

// Tetrahedron Grid
function activateTetrahedronGrid() {
    const result = PyramasonAdvanced.activateTetrahedronGrid(map);
    showModal('🔷 Tetrahedron Grid', '', result.message);
}

// Platonic Solids
function activatePlatonicGrid() {
    const result = PyramasonAdvanced.activatePlatonicGrid(map);
    showModal('🌐 Platonic Solids', '', result.message);
}

// Golden Ratio Patterns
function findGoldenRatioPatterns() {
    const visibleSites = getVisibleSites(); // Your existing function
    const patterns = PyramasonAdvanced.findGoldenRatioPatterns(visibleSites, map);
    
    let html = `<h3>Found ${patterns.length} Golden Ratio Patterns</h3>`;
    patterns.forEach((p, i) => {
        html += `<div style="margin: 10px 0; padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px;">
            <strong>Pattern ${i + 1}:</strong><br>
            Ratio: ${p.ratio.toFixed(4)} (φ = 1.618)<br>
            Confidence: ${p.confidence.toFixed(1)}%<br>
            Sites: ${p.sites.map(s => s.name).join(' → ')}
        </div>`;
    });
    
    showModal('🔺 Golden Ratio Patterns', '', html);
}

// Clear All Overlays
function clearAllOverlays() {
    if (typeof PyramasonAdvanced !== 'undefined') {
        PyramasonAdvanced.clearAllOverlays();
    }

}

        // Make initMap global for Google Maps callback
        window.initMap = initMap;
        
        // ============================================================================
        // DATA LOADING
        // ============================================================================
        
        async function loadAllSites() {
            showLoading(true);
            console.log('📊 Loading site databases...');
            
            try {
                // Load pyramids first (priority data)
                const pyramidResponse = await fetch(CONFIG.PYRAMID_DATABASE_URL);
                if (!pyramidResponse.ok) throw new Error(`HTTP ${pyramidResponse.status}`);
                
                const pyramidData = await pyramidResponse.json();
                
                // Handle different JSON structures
                pyramidSites = Array.isArray(pyramidData) ? pyramidData :
                              pyramidData.pyramids || pyramidData.data || pyramidData.sites || [];
                
                console.log(`✅ Loaded ${pyramidSites.length} pyramids`);
                
                // Add to allSites
                allSites = pyramidSites.map(site => ({ ...site, type: 'pyramid' }));
                filteredSites = [...allSites];
                
                // Create initial markers
                createMarkers();
                updateStats();
                
                showLoading(false);
                
                showModal('🎉', 'Sites Loaded!', 
                    `Successfully loaded ${pyramidSites.length.toLocaleString()} pyramids!<br><br>
                    <small>Loading megalithic sites in background...</small>`);
                
                // Load megaliths in background
                loadMegalithsInBackground();
                
            } catch (error) {
                console.error('❌ Error loading pyramids:', error);
                showLoading(false);
                
                // Use sample data as fallback
                console.log('📝 Using sample data...');
                allSites = generateSampleData();
                filteredSites = [...allSites];
                createMarkers();
                updateStats();
                
                showModal('⚠️', 'Using Sample Data', 
                    `Could not load full database. Displaying ${allSites.length} sample sites for demonstration.<br><br>
                    <small>Error: ${error.message}</small>`);
            }
        }
        
        async function loadMegalithsInBackground() {
            console.log('🔄 Loading megalithic sites in background...');
            
            megalithSites = [];
            const categories = Object.entries(CONFIG.MEGALITH_DATABASES);
            
            for (const [category, url] of categories) {
                try {
                    console.log(`   Loading ${category}...`);
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    const sites = Array.isArray(data) ? data : data.sites || data.data || [];
                    
                    // Add category info
                    const categorizedSites = sites.map(site => ({
                        ...site,
                        type: 'megalith',
                        subtype: category
                    }));
                    
                    megalithSites = megalithSites.concat(categorizedSites);
                    console.log(`   ✅ ${category}: ${sites.length} sites (Total: ${megalithSites.length})`);
                    
                    // Update allSites
                    allSites = [
                        ...pyramidSites.map(s => ({ ...s, type: 'pyramid' })),
                        ...megalithSites
                    ];
                    
                    // Only update markers if megalith layers are visible
                    if (layersVisible.megaliths || 
                        layersVisible[`megaliths${category.charAt(0).toUpperCase()}${category.slice(1)}`]) {
                        filteredSites = filterSites(allSites);
                        createMarkers();
                    }
                    
                    updateStats();
                    
                } catch (error) {
                    console.warn(`   ⚠️ Failed to load ${category}:`, error.message);
                }
            }
            
            console.log(`🎉 All sites loaded! Total: ${allSites.length} (${pyramidSites.length} pyramids, ${megalithSites.length} megaliths)`);
        }
        
        function generateSampleData() {
            return [
                { name: 'Great Pyramid of Giza', lat: 29.9792, lng: 31.1342, type: 'pyramid', era: 'Ancient Egypt', country: 'Egypt', 
                  description: 'The largest of the three pyramids on the Giza plateau' },
                { name: 'Pyramid of Khafre', lat: 29.9753, lng: 31.1309, type: 'pyramid', era: 'Ancient Egypt', country: 'Egypt',
                  description: 'Second largest pyramid at Giza' },
                { name: 'Pyramid of Menkaure', lat: 29.9722, lng: 31.1281, type: 'pyramid', era: 'Ancient Egypt', country: 'Egypt',
                  description: 'Smallest of the three main Giza pyramids' },
                { name: 'Stonehenge', lat: 51.1789, lng: -1.8262, type: 'megalith', subtype: 'stones', era: 'Neolithic', country: 'UK',
                  description: 'Prehistoric monument consisting of standing stones' },
                { name: 'Pyramid of the Sun', lat: 19.6925, lng: -98.8438, type: 'pyramid', era: 'Pre-Columbian', country: 'Mexico',
                  description: 'Third largest pyramid in the world, Teotihuacan' },
                { name: 'Angkor Wat', lat: 13.4125, lng: 103.8670, type: 'temple', era: 'Khmer Empire', country: 'Cambodia',
                  description: 'Largest religious monument in the world' },
                { name: 'Machu Picchu', lat: -13.1631, lng: -72.5450, type: 'temple', era: 'Inca', country: 'Peru',
                  description: '15th-century Inca citadel in the Andes' },
                { name: 'Borobudur', lat: -7.6079, lng: 110.2038, type: 'temple', era: 'Medieval', country: 'Indonesia',
                  description: '9th-century Mahayana Buddhist temple' },
                { name: 'Newgrange', lat: 53.6947, lng: -6.4750, type: 'megalith', subtype: 'burials', era: 'Neolithic', country: 'Ireland',
                  description: 'Prehistoric passage tomb aligned with winter solstice' },
                { name: 'Göbekli Tepe', lat: 37.2232, lng: 38.9225, type: 'megalith', subtype: 'stones', era: 'Pre-Pottery Neolithic', country: 'Turkey',
                  description: 'Oldest known temple complex, dating to 9600 BCE' }
            ];
        }

// Continue with more functions...
        
        // ============================================================================
        // MARKER MANAGEMENT
        // ============================================================================
        
        function createMarkers() {
            console.log('🎨 Creating markers...');
            
            // Clear existing markers
            if (markerClusterer) {
                try {
                    markerClusterer.clearMarkers();
                } catch (e) {
                    console.warn('Error clearing clusterer:', e);
                }
                markerClusterer = null;
            }
            
            markers.forEach(marker => {
                try {
                    marker.setMap(null);
                } catch (e) {
                    // Ignore errors
                }
            });
            markers = [];
            
            const markersToCluster = [];
            let createdCount = 0;
            
            // Create markers for each filtered site
            filteredSites.forEach(site => {
                if (!shouldShowSite(site)) return;
                
                const lat = parseFloat(site.latitude || site.lat);
                const lng = parseFloat(site.longitude || site.lng);
                
                if (!lat || !lng || isNaN(lat) || isNaN(lng)) return;
                if (lat < -90 || lat > 90 || lng < -180 || lng > 180) return;
                
                const icon = getMarkerIcon(site);
                
                const marker = new google.maps.Marker({
                    position: { lat, lng },
                    map: map,
                    title: site.name || site.title || 'Unknown Site',
                    icon: icon,
                    optimized: true
                });
                
                marker.addListener('click', () => showSiteInfo(site, lat, lng));
                
                markers.push(marker);
                markersToCluster.push(marker);
                createdCount++;
            });
            
            console.log(`✅ Created ${createdCount} markers`);
            
            // Initialize marker clustering
            if (typeof markerClusterer !== 'undefined' && window.markerClusterer && markersToCluster.length > 0) {
                try {
                    markerClusterer = new markerClusterer.MarkerClusterer({ 
                        map, 
                        markers: markersToCluster,
                        algorithm: new markerClusterer.SuperClusterAlgorithm({ radius: 100 })
                    });
                    console.log('✅ Marker clustering enabled');
                } catch (error) {
                    console.warn('Clustering failed:', error);
                }
            }
            
            updateStats();
        }
        
        function getMarkerIcon(site) {
            if (site.type === 'pyramid') {
                return {
                    path: 'M 0,-12 L -10,12 L 10,12 Z', // Triangle
                    scale: 1.3,
                    fillColor: '#FFD700',
                    fillOpacity: 0.95,
                    strokeColor: '#fff',
                    strokeWeight: 2.5
                };
            } else if (site.type === 'megalith') {
                const colors = {
                    burials: '#8B4513',
                    stones: '#808080',
                    rockart: '#FF6B6B',
                    settlements: '#4ECDC4'
                };
                
                return {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 5.5,
                    fillColor: colors[site.subtype] || '#9C27B0',
                    fillOpacity: 0.9,
                    strokeColor: '#fff',
                    strokeWeight: 2
                };
            }
            
            // Default icon
            return {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 6,
                fillColor: '#00BCD4',
                fillOpacity: 0.9,
                strokeColor: '#fff',
                strokeWeight: 2
            };
        }
        
        function shouldShowSite(site) {
            // Check layer visibility
            if (site.type === 'pyramid' && !layersVisible.pyramids) return false;
            
            if (site.type === 'megalith') {
                if (!layersVisible.megaliths) {
                    const subtypeKey = 'megaliths' + (site.subtype ? site.subtype.charAt(0).toUpperCase() + site.subtype.slice(1) : '');
                    if (!layersVisible[subtypeKey]) return false;
                }
            }
            
            return true;
        }
        
        function showSiteInfo(site, lat, lng) {
            const name = site.name || site.title || 'Unknown Site';
            const description = site.description || site.info || 'No description available';
            const type = site.type === 'pyramid' ? '🔺 Pyramid' : 
                        site.type === 'megalith' ? '🗿 Megalithic Structure' : '🏛️ Ancient Site';
            const era = site.era || site.period || site.age || 'Unknown Era';
            const country = site.country || site.location || 'Unknown Location';
            
            const content = `
                <div style="max-width: 450px;">
                    <h3 style="color: var(--accent-gold); margin-bottom: 12px; font-size: 20px;">${name}</h3>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 18px;">
                        <span style="background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold)); 
                                     color: var(--dark-purple); padding: 6px 15px; border-radius: 20px; 
                                     font-size: 13px; font-weight: 700;">${type}</span>
                        <span style="color: var(--light-cyan); font-size: 14px;">${era}</span>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 18px; border-radius: 12px; 
                                margin-bottom: 18px; border-left: 4px solid var(--accent-gold);">
                        <p style="margin-bottom: 12px;"><strong style="color: var(--light-cyan);">Location:</strong> ${country}</p>
                        <p style="margin-bottom: 12px;"><strong style="color: var(--light-cyan);">Coordinates:</strong> ${lat.toFixed(5)}°, ${lng.toFixed(5)}°</p>
                        <p><strong style="color: var(--light-cyan);">Era:</strong> ${era}</p>
                    </div>
                    
                    <p style="line-height: 1.7; margin-bottom: 20px; color: rgba(255,255,255,0.9);">${description}</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <button class="action-btn primary" style="margin: 0;" onclick="saveToCollection('${name.replace(/'/g, "\\'")}', ${lat}, ${lng})">
                            <span class="btn-icon">💾</span>
                            <span>Save</span>
                        </button>
                        <button class="action-btn" style="margin: 0;" onclick="shareLocation(${lat}, ${lng})">
                            <span class="btn-icon">🔗</span>
                            <span>Share</span>
                        </button>
                        <button class="action-btn" style="margin: 0;" onclick="measureTo(${lat}, ${lng})">
                            <span class="btn-icon">📏</span>
                            <span>Measure</span>
                        </button>
                        <button class="action-btn" style="margin: 0;" onclick="analyzeThis(${lat}, ${lng})">
                            <span class="btn-icon">📊</span>
                            <span>Analyze</span>
                        </button>
                    </div>
                </div>
            `;
            
            showModal('📍', name, content);
        }
        
        // ============================================================================
        // FILTERS & LAYERS
        // ============================================================================
        
        function toggleFilter(filterName, element) {
            layersVisible[filterName] = !layersVisible[filterName];
            
            const checkbox = element.querySelector('.filter-checkbox');
            checkbox.classList.toggle('checked');
            
            // If toggling main megaliths, toggle all subtypes
            if (filterName === 'megaliths') {
                const newState = layersVisible[filterName];
                ['megalithsBurials', 'megalithsStones', 'megalithsRockArt', 'megalithsSettlements'].forEach(sub => {
                    layersVisible[sub] = newState;
                    const subEl = document.querySelector(`[onclick*="${sub}"]`);
                    if (subEl) {
                        const subCheckbox = subEl.querySelector('.filter-checkbox');
                        if (subCheckbox) {
                            if (newState) {
                                subCheckbox.classList.add('checked');
                            } else {
                                subCheckbox.classList.remove('checked');
                            }
                        }
                    }
                });
            }
            
            filteredSites = filterSites(allSites);
            createMarkers();
        }
        
        function togglePurposeFilter(purpose, element) {
            const checkbox = element.querySelector('.filter-checkbox');
            checkbox.classList.toggle('checked');
            
            if (activeFilters.purposes.has(purpose)) {
                activeFilters.purposes.delete(purpose);
            } else {
                activeFilters.purposes.add(purpose);
            }
        }
        
        function toggleCivilizationFilter(civ, element) {
            const checkbox = element.querySelector('.filter-checkbox');
            checkbox.classList.toggle('checked');
            
            if (activeFilters.civilizations.has(civ)) {
                activeFilters.civilizations.delete(civ);
            } else {
                activeFilters.civilizations.add(civ);
            }
        }
        
        function toggleGeographicFilter(geo, element) {
            const checkbox = element.querySelector('.filter-checkbox');
            checkbox.classList.toggle('checked');
            
            if (activeFilters.geographic.has(geo)) {
                activeFilters.geographic.delete(geo);
            } else {
                activeFilters.geographic.add(geo);
            }
        }
        
        function filterSites(sites) {
            return sites.filter(site => {
                // Timeline filter
                if (activeFilters.timeline < 2025) {
                    const era = (site.era || '').toLowerCase();
                    const year = activeFilters.timeline;
                    
                    if (year < -5000 && !era.match(/prehistoric|paleolithic|neolithic/)) return false;
                    if (year >= -5000 && year < -3000 && !era.match(/neolithic|bronze/)) return false;
                    if (year >= -3000 && year < -1000 && !era.match(/bronze|iron/)) return false;
                    if (year >= -1000 && year < 0 && !era.match(/iron|classical|ancient/)) return false;
                    if (year >= 0 && year < 500 && !era.match(/classical|roman/)) return false;
                    if (year >= 500 && year < 1500 && !era.match(/medieval|middle/)) return false;
                }
                
                // Purpose filter
                if (activeFilters.purposes.size > 0) {
                    const desc = (site.description || '').toLowerCase();
                    const name = (site.name || '').toLowerCase();
                    const combined = desc + ' ' + name;
                    
                    let matches = false;
                    activeFilters.purposes.forEach(purpose => {
                        if (purpose === 'burial' && combined.match(/burial|tomb|cemetery|grave/)) matches = true;
                        if (purpose === 'temple' && combined.match(/temple|religious|sacred|shrine/)) matches = true;
                        if (purpose === 'observatory' && combined.match(/observatory|astronomical|calendar/)) matches = true;
                        if (purpose === 'settlement' && combined.match(/settlement|city|village|dwelling/)) matches = true;
                        if (purpose === 'fortress' && combined.match(/fortress|fort|defensive|castle/)) matches = true;
                    });
                    
                    if (!matches) return false;
                }
                
                // Civilization filter
                if (activeFilters.civilizations.size > 0) {
                    const desc = (site.description || '').toLowerCase();
                    const country = (site.country || '').toLowerCase();
                    const era = (site.era || '').toLowerCase();
                    const combined = desc + ' ' + country + ' ' + era;
                    
                    let matches = false;
                    activeFilters.civilizations.forEach(civ => {
                        if (civ === 'egyptian' && combined.match(/egypt|pharaoh|dynasty/)) matches = true;
                        if (civ === 'mayan' && combined.match(/maya|mayan|mesoamerican|aztec/)) matches = true;
                        if (civ === 'celtic' && combined.match(/celtic|druid|gaul/)) matches = true;
                        if (civ === 'chinese' && combined.match(/china|chinese|han|tang/)) matches = true;
                        if (civ === 'incan' && combined.match(/inca|incan|andean|peru/)) matches = true;
                    });
                    
                    if (!matches) return false;
                }
                
                return true;
            });
        }
        
        function applyFilters() {
            filteredSites = filterSites(allSites);
            createMarkers();
            showModal('✓', 'Filters Applied', 
                `Filters have been applied. Now showing ${markers.length.toLocaleString()} of ${allSites.length.toLocaleString()} sites.`);
        }
        
        function clearFilters() {
            activeFilters.purposes.clear();
            activeFilters.civilizations.clear();
            activeFilters.geographic.clear();
            
            document.querySelectorAll('#tab-filters .filter-checkbox.checked').forEach(cb => {
                if (!cb.closest('[onclick*="Layer"]')) {
                    cb.classList.remove('checked');
                }
            });
            
            document.getElementById('timelineSlider').value = 2025;
            updateTimeline(2025);
            
            filteredSites = filterSites(allSites);
            createMarkers();
        }
        
        function showAllLayers() {
            Object.keys(layersVisible).forEach(k => layersVisible[k] = true);
            document.querySelectorAll('#tab-layers .filter-checkbox').forEach(cb => cb.classList.add('checked'));
            filteredSites = filterSites(allSites);
            createMarkers();
        }
        
        function hideAllLayers() {
            Object.keys(layersVisible).forEach(k => layersVisible[k] = false);
            document.querySelectorAll('#tab-layers .filter-checkbox').forEach(cb => cb.classList.remove('checked'));
            markers.forEach(m => m.setMap(null));
            markers = [];
            updateStats();
        }
        
        function toggleMegalithsOnly() {
            layersVisible.pyramids = false;
            layersVisible.megaliths = true;
            layersVisible.megalithsBurials = true;
            layersVisible.megalithsStones = true;
            layersVisible.megalithsRockArt = true;
            layersVisible.megalithsSettlements = true;
            filteredSites = filterSites(allSites);
            createMarkers();
        }
        
        function togglePyramidsOnly() {
            layersVisible.pyramids = true;
            layersVisible.megaliths = false;
            layersVisible.megalithsBurials = false;
            layersVisible.megalithsStones = false;
            layersVisible.megalithsRockArt = false;
            layersVisible.megalithsSettlements = false;
            filteredSites = filterSites(allSites);
            createMarkers();
        }
        
        function updateTimeline(value) {
            const year = parseInt(value);
            activeFilters.timeline = year;
            
            let text = year === 2025 ? 'All Eras' : 
                      year < 0 ? `${Math.abs(year).toLocaleString()} BCE` : 
                      `${year.toLocaleString()} CE`;
            
            document.getElementById('timelineValue').textContent = text;
        }
        
        function setPeriod(start, end) {
            document.getElementById('timelineSlider').value = end;
            updateTimeline(end);
            applyFilters();
        }
        
        // ============================================================================
        // UI CONTROLS
        // ============================================================================
        
        function toggleUnifiedPanel() {
            document.getElementById('unifiedPanel').classList.toggle('active');
        }
        
        function switchTab(tabName) {
            // Remove active from all tabs and contents
            document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Add active to clicked tab
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }
        
        function quickToggleLayers() {
            const allOn = Object.values(layersVisible).every(v => v);
            if (allOn) {
                hideAllLayers();
                document.getElementById('layerToggle').classList.remove('active');
            } else {
                showAllLayers();
                document.getElementById('layerToggle').classList.add('active');
            }
        }
        
        function showHelp() {
            const helpContent = `
                <div style="max-width: 600px;">
                    <h4 style="color: var(--accent-gold); margin-bottom: 15px; font-size: 18px;">🎓 Quick Start Guide</h4>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <h5 style="color: var(--light-cyan); margin-bottom: 10px;">📍 Navigation</h5>
                        <p style="font-size: 14px; line-height: 1.6; color: rgba(255,255,255,0.85);">
                            • Click and drag to move the map<br>
                            • Scroll to zoom in/out<br>
                            • Click markers to see site details<br>
                            • Right-click for context menu
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <h5 style="color: var(--light-cyan); margin-bottom: 10px;">🗺️ Layers & Filters</h5>
                        <p style="font-size: 14px; line-height: 1.6; color: rgba(255,255,255,0.85);">
                            • Toggle site types in Layers tab<br>
                            • Filter by time period, purpose, civilization<br>
                            • Use Quick Actions for common filters
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <h5 style="color: var(--light-cyan); margin-bottom: 10px;">📐 Analysis Tools</h5>
                        <p style="font-size: 14px; line-height: 1.6; color: rgba(255,255,255,0.85);">
                            • <strong>Geometry:</strong> Detect sacred patterns and ley lines<br>
                            • <strong>Astronomy:</strong> Calculate celestial alignments<br>
                            • <strong>Analysis:</strong> Cluster analysis and correlations<br>
                            • <strong>Measurement:</strong> Use 📏 button to measure distances
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <h5 style="color: var(--light-cyan); margin-bottom: 10px;">💾 Data Export</h5>
                        <p style="font-size: 14px; line-height: 1.6; color: rgba(255,255,255,0.85);">
                            • Export visible sites to CSV/JSON<br>
                            • Generate analysis reports<br>
                            • Save sites to collections (account required)
                        </p>
                    </div>
                    
                    <div style="padding: 15px; background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(106,27,154,0.1)); 
                                border-radius: 10px; border: 1px solid var(--border-color);">
                        <h5 style="color: var(--accent-gold); margin-bottom: 10px;">💡 Pro Tips</h5>
                        <p style="font-size: 13px; line-height: 1.6; color: rgba(255,255,255,0.85);">
                            • Create a free account to unlock all features<br>
                            • Use search bar for quick site lookup<br>
                            • Combine filters for precise research<br>
                            • Right-click anywhere for quick actions
                        </p>
                    </div>
                </div>
            `;
            
            showModal('❓', 'Help & Tutorial', helpContent);
        }
        
        function showCollections() {
            viewMyCollections();
        }
        
        function exportData() {
            document.getElementById('unifiedPanel').classList.add('active');
            setTimeout(() => {
                document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('[onclick*="data"]').classList.add('active');
                document.getElementById('tab-data').classList.add('active');
            }, 100);
        }
        
        // ============================================================================
        // STATISTICS
        // ============================================================================
        
        function updateStats() {
            const visible = markers.length;
            const total = allSites.length;
            const pyramidCount = pyramidSites.length;
            const megalithCount = megalithSites.length;
            
            // Update badge
            const badge = document.getElementById('statsBadge');
            if (badge) {
                badge.innerHTML = `
                    <span class="stats-icon">📍</span>
                    <span>Showing ${visible.toLocaleString()} of ${total.toLocaleString()} sites</span>
                `;
            }
            
            // Update data tab stats
            const statTotal = document.getElementById('statTotal');
            const statVisible = document.getElementById('statVisible');
            const statPyramids = document.getElementById('statPyramids');
            const statMegaliths = document.getElementById('statMegaliths');
            const statZoom = document.getElementById('statZoom');
            const statCenter = document.getElementById('statCenter');
            
            if (statTotal) statTotal.textContent = total.toLocaleString();
            if (statVisible) statVisible.textContent = visible.toLocaleString();
            if (statPyramids) statPyramids.textContent = pyramidCount.toLocaleString();
            if (statMegaliths) statMegaliths.textContent = megalithCount.toLocaleString();
            
            if (map) {
                if (statZoom) statZoom.textContent = map.getZoom();
                if (statCenter) {
                    const center = map.getCenter();
                    const lat = center.lat().toFixed(2);
                    const lng = center.lng().toFixed(2);
                    const latDir = lat >= 0 ? 'N' : 'S';
                    const lngDir = lng >= 0 ? 'E' : 'W';
                    statCenter.textContent = `${Math.abs(lat)}°${latDir}, ${Math.abs(lng)}°${lngDir}`;
                }
            }
        }
        
        function updateMapStats() {
            if (map) {
                const statZoom = document.getElementById('statZoom');
                const statCenter = document.getElementById('statCenter');
                
                if (statZoom) statZoom.textContent = map.getZoom();
                if (statCenter) {
                    const center = map.getCenter();
                    const lat = center.lat().toFixed(2);
                    const lng = center.lng().toFixed(2);
                    const latDir = lat >= 0 ? 'N' : 'S';
                    const lngDir = lng >= 0 ? 'E' : 'W';
                    statCenter.textContent = `${Math.abs(lat)}°${latDir}, ${Math.abs(lng)}°${lngDir}`;
                }
            }
        }
        
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.add('active');
            } else {
                spinner.classList.remove('active');
            }
        }
        
        function showModal(icon, title, message, primaryText = 'OK', secondaryText = null, onPrimary = null, onSecondary = null) {
            document.getElementById('modalIcon').textContent = icon;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = message;
            document.getElementById('modalPrimaryBtn').textContent = primaryText;
            
            const secondaryBtn = document.getElementById('modalSecondaryBtn');
            if (secondaryText) {
                secondaryBtn.textContent = secondaryText;
                secondaryBtn.style.display = 'inline-block';
                secondaryBtn.onclick = () => {
                    closeModal();
                    if (onSecondary) onSecondary();
                };
            } else {
                secondaryBtn.style.display = 'none';
            }
            
            document.getElementById('modalPrimaryBtn').onclick = () => {
                closeModal();
                if (onPrimary) onPrimary();
            };
            
            document.getElementById('modalOverlay').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }
        
        // Continue in next update with geometry, astronomy, and analysis functions...
        
        // ============================================================================
        // SACRED GEOMETRY DETECTION
        // ============================================================================
        
        function detectGoldenRatio() {
            showLoading(true);
            console.log('🔍 Detecting golden ratio patterns...');
            
            const PHI = 1.618033988749895;
            const tolerance = 0.05; // 5% tolerance
            const sites = getVisibleSites().slice(0, 150); // Limit for performance
            const detections = [];
            
            // Check all combinations of 3 sites
            for (let i = 0; i < sites.length; i++) {
                for (let j = i + 1; j < sites.length; j++) {
                    for (let k = j + 1; k < sites.length; k++) {
                        const d12 = haversineDistance(sites[i].lat, sites[i].lng, sites[j].lat, sites[j].lng);
                        const d23 = haversineDistance(sites[j].lat, sites[j].lng, sites[k].lat, sites[k].lng);
                        const d31 = haversineDistance(sites[k].lat, sites[k].lng, sites[i].lat, sites[i].lng);
                        
                        const sides = [d12, d23, d31].sort((a, b) => a - b);
                        const ratio = sides[2] / sides[1];
                        const error = Math.abs(ratio - PHI) / PHI;
                        
                        if (error < tolerance) {
                            const confidence = (1 - error) * 100;
                            detections.push({
                                sites: [sites[i], sites[j], sites[k]],
                                sides: sides,
                                ratio: ratio,
                                confidence: confidence,
                                error: error
                            });
                        }
                    }
                }
            }
            
            showLoading(false);
            
            if (detections.length > 0) {
                // Sort by confidence
                detections.sort((a, b) => b.confidence - a.confidence);
                
                // Draw best match
                const best = detections[0];
                drawTriangle(best.sites, '#FFD700');
                
                // Show results
                showGeometryResults('Golden Ratio', detections.slice(0, 10));
                
                showModal('φ', 'Golden Ratio Detected!', 
                    `Found ${detections.length} golden ratio formations!<br><br>
                    <strong>Best Match:</strong><br>
                    ${best.sites.map(s => s.name).join(' ↔ ')}<br><br>
                    <strong>Ratio:</strong> ${best.ratio.toFixed(4)} (φ = 1.618)<br>
                    <strong>Confidence:</strong> ${best.confidence.toFixed(1)}%<br>
                    <strong>Side Lengths:</strong> ${best.sides.map(s => s.toFixed(1) + ' km').join(', ')}`);
            } else {
                showModal('φ', 'No Golden Ratios Found', 
                    'No golden ratio formations detected in the visible area. Try zooming out or moving to a region with more sites.');
            }
        }
        
        function detectEquilateralTriangles() {
            showLoading(true);
            console.log('🔍 Detecting equilateral triangles...');
            
            const tolerance = 0.05;
            const sites = getVisibleSites().slice(0, 150);
            const detections = [];
            
            for (let i = 0; i < sites.length; i++) {
                for (let j = i + 1; j < sites.length; j++) {
                    for (let k = j + 1; k < sites.length; k++) {
                        const d12 = haversineDistance(sites[i].lat, sites[i].lng, sites[j].lat, sites[j].lng);
                        const d23 = haversineDistance(sites[j].lat, sites[j].lng, sites[k].lat, sites[k].lng);
                        const d31 = haversineDistance(sites[k].lat, sites[k].lng, sites[i].lat, sites[i].lng);
                        
                        const avgDist = (d12 + d23 + d31) / 3;
                        const maxDiff = Math.max(
                            Math.abs(d12 - avgDist),
                            Math.abs(d23 - avgDist),
                            Math.abs(d31 - avgDist)
                        );
                        
                        if (maxDiff / avgDist < tolerance) {
                            const confidence = (1 - maxDiff / avgDist) * 100;
                            detections.push({
                                sites: [sites[i], sites[j], sites[k]],
                                avgDist: avgDist,
                                confidence: confidence
                            });
                        }
                    }
                }
            }
            
            showLoading(false);
            
            if (detections.length > 0) {
                detections.sort((a, b) => b.confidence - a.confidence);
                const best = detections[0];
                drawTriangle(best.sites, '#00BCD4');
                showGeometryResults('Equilateral Triangles', detections.slice(0, 10));
                
                showModal('△', 'Equilateral Triangles Found!', 
                    `Found ${detections.length} equilateral formations!<br><br>
                    <strong>Perfect Triangle:</strong><br>
                    ${best.sites.map(s => s.name).join(' ↔ ')}<br><br>
                    <strong>Side Length:</strong> ${best.avgDist.toFixed(2)} km<br>
                    <strong>Confidence:</strong> ${best.confidence.toFixed(1)}%`);
            } else {
                showModal('△', 'No Equilateral Triangles', 
                    'No equilateral triangles detected in the visible area.');
            }
        }
        
        function detectPythagoreanTriangles() {
            showLoading(true);
            const sites = getVisibleSites().slice(0, 100);
            const detections = [];
            
            for (let i = 0; i < sites.length; i++) {
                for (let j = i + 1; j < sites.length; j++) {
                    for (let k = j + 1; k < sites.length; k++) {
                        const d12 = haversineDistance(sites[i].lat, sites[i].lng, sites[j].lat, sites[j].lng);
                        const d23 = haversineDistance(sites[j].lat, sites[j].lng, sites[k].lat, sites[k].lng);
                        const d31 = haversineDistance(sites[k].lat, sites[k].lng, sites[i].lat, sites[i].lng);
                        
                        const sides = [d12, d23, d31].sort((a, b) => a - b);
                        const ratio1 = sides[0] / sides[2];
                        const ratio2 = sides[1] / sides[2];
                        
                        // Check for 3-4-5 ratio
                        if (Math.abs(ratio1 - 0.6) < 0.05 && Math.abs(ratio2 - 0.8) < 0.05) {
                            detections.push({
                                sites: [sites[i], sites[j], sites[k]],
                                sides: sides
                            });
                        }
                    }
                }
            }
            
            showLoading(false);
            
            if (detections.length > 0) {
                drawTriangle(detections[0].sites, '#FF6B6B');
                showModal('∟', 'Pythagorean Triangles!', 
                    `Found ${detections.length} Pythagorean triangle formations (3-4-5 ratio)!`);
            } else {
                showModal('∟', 'No Pythagorean Triangles', 
                    'No Pythagorean triangles detected. These are relatively rare in geographic distributions.');
            }
        }
        
        function detectCircularFormations() {
            showLoading(true);
            const sites = getVisibleSites();
            const detections = [];
            
            // Find groups of sites equidistant from a center point
            for (let i = 0; i < sites.length && i < 50; i++) {
                const center = sites[i];
                const distances = [];
                
                sites.forEach(site => {
                    if (site !== center) {
                        distances.push({
                            site: site,
                            distance: haversineDistance(center.lat, center.lng, site.lat, site.lng)
                        });
                    }
                });
                
                // Group by similar distances
                const groups = {};
                distances.forEach(d => {
                    const key = Math.round(d.distance / 10) * 10; // Round to nearest 10km
                    if (!groups[key]) groups[key] = [];
                    groups[key].push(d);
                });
                
                // Find groups with 4+ sites
                Object.keys(groups).forEach(key => {
                    if (groups[key].length >= 4) {
                        detections.push({
                            center: center,
                            sites: groups[key].map(d => d.site),
                            radius: parseFloat(key),
                            count: groups[key].length
                        });
                    }
                });
            }
            
            showLoading(false);
            
            if (detections.length > 0) {
                const best = detections.sort((a, b) => b.count - a.count)[0];
                
                // Draw circle
                new google.maps.Circle({
                    center: { lat: best.center.lat, lng: best.center.lng },
                    radius: best.radius * 1000,
                    strokeColor: '#9C27B0',
                    strokeWeight: 3,
                    strokeOpacity: 0.7,
                    fillColor: '#9C27B0',
                    fillOpacity: 0.15,
                    map: map
                });
                
                showModal('⭕', 'Circular Formations!', 
                    `Found ${detections.length} circular formations!<br><br>
                    <strong>Best Formation:</strong><br>
                    Center: ${best.center.name}<br>
                    Radius: ${best.radius.toFixed(1)} km<br>
                    Sites on circle: ${best.count}`);
            } else {
                showModal('⭕', 'No Circular Formations', 'No significant circular formations detected.');
            }
        }
        
        function detectLinearAlignments() {
            showLoading(true);
            const sites = getVisibleSites().slice(0, 100);
            const detections = [];
            const threshold = 5; // degrees
            
            for (let i = 0; i < sites.length; i++) {
                for (let j = i + 1; j < sites.length; j++) {
                    const bearing = calculateBearing(sites[i].lat, sites[i].lng, sites[j].lat, sites[j].lng);
                    const aligned = [sites[i], sites[j]];
                    
                    sites.forEach(site => {
                        if (site !== sites[i] && site !== sites[j]) {
                            const b1 = calculateBearing(sites[i].lat, sites[i].lng, site.lat, site.lng);
                            const diff = Math.abs(bearing - b1);
                            
                            if (diff < threshold || diff > 360 - threshold) {
                                aligned.push(site);
                            }
                        }
                    });
                    
                    if (aligned.length >= 3) {
                        detections.push({
                            sites: aligned,
                            bearing: bearing,
                            count: aligned.length
                        });
                    }
                }
            }
            
            showLoading(false);
            
            if (detections.length > 0) {
                const best = detections.sort((a, b) => b.count - a.count)[0];
                drawPolyline(best.sites.map(s => ({ lat: s.lat, lng: s.lng })), '#FFD700');
                
                showModal('—', 'Linear Alignments!', 
                    `Found ${detections.length} linear alignments!<br><br>
                    <strong>Longest Alignment:</strong><br>
                    ${best.count} sites aligned<br>
                    Bearing: ${best.bearing.toFixed(1)}°`);
            } else {
                showModal('—', 'No Linear Alignments', 'No significant linear alignments detected.');
            }
        }
        
        function detectFibonacciSpiral() {
            showModal('🌀', 'Fibonacci Analysis', 
                'Fibonacci spiral detection analyzes the logarithmic spiral patterns connecting ancient sites. This advanced feature is currently being refined.');
        }
        
        function detectPerfectSquares() {
            showModal('⬛', 'Square Detection', 
                'Perfect square and rectangle detection analyzes four-point formations with right angles.');
        }
        
        function detectVesicaPiscis() {
            showModal('∞', 'Vesica Piscis', 
                'Vesica Piscis detection finds the sacred geometry pattern formed by two intersecting circles.');
        }
        
        function detectAllGeometricPatterns() {
            showLoading(true);
            
            showModal('🔍', 'Comprehensive Analysis', 
                'Running all geometric pattern detections. This may take a moment...',
                'Continue', 'Cancel',
                () => {
                    setTimeout(() => detectGoldenRatio(), 500);
                    setTimeout(() => detectEquilateralTriangles(), 2000);
                    setTimeout(() => detectCircularFormations(), 4000);
                }
            );
        }
        
        function showGeometricNetwork() {
            showModal('🕸️', 'Geometric Network', 
                'Displays all detected geometric relationships as an interactive network visualization.');
        }
        
        function calculateSacredProportions() {
            showModal('📏', 'Sacred Proportions', 
                'Analyzes ratios between sites for common sacred proportions: φ (phi), √2, √3, √5, and π.');
        }
        
        // ============================================================================
        // LEY LINES DETECTION
        // ============================================================================
        
        function autoDetectLeyLines() {
            showLoading(true);
            console.log('〰️ Detecting ley lines...');
            
            const threshold = parseFloat(document.getElementById('leyLineThreshold')?.textContent || '3');
            const sites = getVisibleSites().slice(0, 100);
            const detections = [];
            
            for (let i = 0; i < sites.length; i++) {
                for (let j = i + 1; j < sites.length; j++) {
                    const bearing12 = calculateBearing(sites[i].lat, sites[i].lng, sites[j].lat, sites[j].lng);
                    const aligned = [sites[i], sites[j]];
                    
                    sites.forEach(site => {
                        if (site !== sites[i] && site !== sites[j]) {
                            const bearing13 = calculateBearing(sites[i].lat, sites[i].lng, site.lat, site.lng);
                            const diff = Math.abs(bearing12 - bearing13);
                            
                            if (diff < threshold || diff > 360 - threshold) {
                                aligned.push(site);
                            }
                        }
                    });
                    
                    if (aligned.length >= 3) {
                        detections.push({
                            sites: aligned,
                            bearing: bearing12,
                            count: aligned.length,
                            length: haversineDistance(
                                aligned[0].lat, aligned[0].lng,
                                aligned[aligned.length - 1].lat, aligned[aligned.length - 1].lng
                            )
                        });
                    }
                }
            }
            
            showLoading(false);
            
            if (detections.length > 0) {
                // Remove duplicates
                const unique = [];
                detections.forEach(d => {
                    const exists = unique.find(u => 
                        u.bearing === d.bearing && u.count === d.count
                    );
                    if (!exists) unique.push(d);
                });
                
                // Sort by length
                const sorted = unique.sort((a, b) => b.count - a.count || b.length - a.length);
                const best = sorted[0];
                
                // Draw ley line
                drawPolyline(best.sites.map(s => ({ lat: s.lat, lng: s.lng })), '#00BCD4');
                
                showModal('〰️', 'Ley Lines Detected!', 
                    `Found ${sorted.length} potential ley line alignments!<br><br>
                    <strong>Primary Ley Line:</strong><br>
                    Sites: ${best.count}<br>
                    Length: ${best.length.toFixed(1)} km<br>
                    Bearing: ${best.bearing.toFixed(1)}°<br>
                    Threshold: ${threshold}°<br><br>
                    <small>Sites aligned: ${best.sites.map(s => s.name).join(' → ')}</small>`);
            } else {
                showModal('〰️', 'No Ley Lines', 
                    `No ley line alignments detected with ${threshold}° threshold. Try increasing the tolerance or viewing a different area.`);
            }
        }
        
        function showEarthEnergyGrid() {
            clearDrawings();
            console.log('🌐 Showing Earth energy grid...');
            
            // Icosahedron vertices (12 points)
            const vertices = [
                { lat: 0, lng: 0 }, { lat: 31.7175, lng: -144 }, { lat: 31.7175, lng: -72 },
                { lat: 31.7175, lng: 0 }, { lat: 31.7175, lng: 72 }, { lat: 31.7175, lng: 144 },
                { lat: -31.7175, lng: -144 }, { lat: -31.7175, lng: -72 }, { lat: -31.7175, lng: 0 },
                { lat: -31.7175, lng: 72 }, { lat: -31.7175, lng: 144 },
                { lat: 90, lng: 0 }, { lat: -90, lng: 0 }
            ];
            
            // Draw vertices
            vertices.forEach((vertex, i) => {
                const marker = new google.maps.Marker({
                    position: vertex,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: '#9C27B0',
                        fillOpacity: 0.85,
                        strokeColor: '#FFD700',
                        strokeWeight: 3
                    },
                    title: `Grid Point ${i + 1}`,
                    zIndex: 1000
                });
                
                drawings.push(marker);
            });
            
            // Draw edges
            const edges = [
                [0, 1], [0, 2], [0, 3], [0, 4], [0, 5],
                [1, 2], [2, 3], [3, 4], [4, 5], [5, 1],
                [1, 6], [2, 7], [3, 8], [4, 9], [5, 10],
                [6, 7], [7, 8], [8, 9], [9, 10], [10, 6],
                [6, 12], [7, 12], [8, 12], [9, 12], [10, 12],
                [1, 11], [2, 11], [3, 11], [4, 11], [5, 11]
            ];
            
            edges.forEach(([i, j]) => {
                const line = new google.maps.Polyline({
                    path: [vertices[i], vertices[j]],
                    strokeColor: '#9C27B0',
                    strokeWeight: 2,
                    strokeOpacity: 0.5,
                    geodesic: true,
                    map: map
                });
                
                drawings.push(line);
            });
            
            showModal('🌐', 'Earth Energy Grid', 
                'Icosahedron Earth grid overlay displayed. This represents one theoretical model of Earth\'s energy grid based on Platonic solids.');
        }
        
        function findNearestLeyLine() {
            showModal('📍', 'Nearest Ley Line', 
                'This feature finds the nearest known ley line to your current map center. Click a location on the map and try again.');
        }
        
        function updateLeyLineThreshold(value) {
            document.getElementById('leyLineThreshold').textContent = parseFloat(value).toFixed(1) + '°';
        }
        
        function showGeometryResults(type, detections) {
            const resultsDiv = document.getElementById('geometryResults');
            const listDiv = document.getElementById('geometryResultsList');
            
            if (!detections || detections.length === 0) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            let html = '';
            detections.slice(0, 15).forEach((d, i) => {
                const siteNames = d.sites.map(s => s.name || 'Unknown').join(' → ');
                const confidence = d.confidence ? `${d.confidence.toFixed(1)}%` : '';
                const metrics = d.ratio ? `Ratio: ${d.ratio.toFixed(4)}` :
                               d.avgDist ? `Side: ${d.avgDist.toFixed(2)} km` :
                               d.bearing ? `Bearing: ${d.bearing.toFixed(1)}°` : '';
                
                html += `
                    <div class="geometry-pattern" onclick="focusOnPattern(${i})">
                        <div class="pattern-header">
                            <div class="pattern-type">${type} #${i + 1}</div>
                            ${confidence ? `<div class="pattern-score">${confidence}</div>` : ''}
                        </div>
                        <div class="pattern-sites">${siteNames}</div>
                        ${metrics ? `<div style="margin-top: 8px; font-size: 12px; color: var(--light-cyan);">${metrics}</div>` : ''}
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        // Continue in next update...
        
        // ============================================================================
        // ASTRONOMY CALCULATIONS
        // ============================================================================
        
        function calculateCurrentSunPosition() {
            const center = map.getCenter();
            const now = new Date();
            const sunPos = calculateSunPosition(now, center.lat(), center.lng());
            
            drawAzimuthLine(center, sunPos.azimuth, '#FFA500', 'Current Sun Direction');
            
            showModal('☀️', 'Current Sun Position', 
                `<strong>Location:</strong> ${center.lat().toFixed(5)}°, ${center.lng().toFixed(5)}°<br>
                <strong>Time:</strong> ${now.toLocaleString()}<br><br>
                <strong>Azimuth:</strong> ${sunPos.azimuth.toFixed(2)}°<br>
                <strong>Altitude:</strong> ${sunPos.altitude.toFixed(2)}°<br>
                <strong>Distance:</strong> ${sunPos.distance.toFixed(2)} AU<br><br>
                <small>Azimuth line drawn on map showing current sun direction</small>`);
        }
        
        function calculateSunrise() {
            const center = map.getCenter();
            const now = new Date();
            const sunrise = calculateSunriseSet(now, center.lat(), center.lng(), true);
            
            drawAzimuthLine(center, sunrise.azimuth, '#FF6B35', 'Sunrise Direction');
            
            showModal('🌅', 'Sunrise Analysis', 
                `<strong>Location:</strong> ${center.lat().toFixed(5)}°, ${center.lng().toFixed(5)}°<br>
                <strong>Date:</strong> ${now.toLocaleDateString()}<br><br>
                <strong>Sunrise Time:</strong> ${sunrise.time}<br>
                <strong>Azimuth:</strong> ${sunrise.azimuth.toFixed(2)}° (${getCardinalDirection(sunrise.azimuth)})<br>
                <strong>Altitude at Noon:</strong> ${sunrise.noonAltitude.toFixed(2)}°<br><br>
                <small>Orange line shows sunrise direction from this location</small>`);
        }
        
        function calculateSunset() {
            const center = map.getCenter();
            const now = new Date();
            const sunset = calculateSunriseSet(now, center.lat(), center.lng(), false);
            
            drawAzimuthLine(center, sunset.azimuth, '#FF4500', 'Sunset Direction');
            
            showModal('🌄', 'Sunset Analysis', 
                `<strong>Location:</strong> ${center.lat().toFixed(5)}°, ${center.lng().toFixed(5)}°<br>
                <strong>Date:</strong> ${now.toLocaleDateString()}<br><br>
                <strong>Sunset Time:</strong> ${sunset.time}<br>
                <strong>Azimuth:</strong> ${sunset.azimuth.toFixed(2)}° (${getCardinalDirection(sunset.azimuth)})<br>
                <strong>Day Length:</strong> ${sunset.dayLength} hours<br><br>
                <small>Red line shows sunset direction from this location</small>`);
        }
        
        function calculateSolsticeAlignments() {
            const center = map.getCenter();
            const summerSolstice = calculateSolsticeAzimuth(center.lat(), true);
            const winterSolstice = calculateSolsticeAzimuth(center.lat(), false);
            
            drawAzimuthLine(center, summerSolstice.sunrise, '#FFD700', 'Summer Solstice Sunrise');
            drawAzimuthLine(center, summerSolstice.sunset, '#FFA500', 'Summer Solstice Sunset');
            drawAzimuthLine(center, winterSolstice.sunrise, '#87CEEB', 'Winter Solstice Sunrise');
            drawAzimuthLine(center, winterSolstice.sunset, '#4682B4', 'Winter Solstice Sunset');
            
            showModal('☀️', 'Solstice Alignments', 
                `<strong>Summer Solstice (June 21):</strong><br>
                Sunrise: ${summerSolstice.sunrise.toFixed(1)}° (${getCardinalDirection(summerSolstice.sunrise)})<br>
                Sunset: ${summerSolstice.sunset.toFixed(1)}° (${getCardinalDirection(summerSolstice.sunset)})<br>
                Day Length: ${summerSolstice.dayLength} hours<br><br>
                <strong>Winter Solstice (December 21):</strong><br>
                Sunrise: ${winterSolstice.sunrise.toFixed(1)}° (${getCardinalDirection(winterSolstice.sunrise)})<br>
                Sunset: ${winterSolstice.sunset.toFixed(1)}° (${getCardinalDirection(winterSolstice.sunset)})<br>
                Day Length: ${winterSolstice.dayLength} hours<br><br>
                <small>Lines drawn on map show solstice sunrise/sunset directions</small>`);
        }
        
        function calculateEquinoxAlignments() {
            showModal('⚖️', 'Equinox Alignments', 
                `<strong>Spring & Autumn Equinox:</strong><br><br>
                Sunrise Azimuth: 90° (Due East)<br>
                Sunset Azimuth: 270° (Due West)<br>
                Day Length: 12 hours<br><br>
                During equinoxes, the sun rises due east and sets due west at all locations on Earth.`);
        }
        
        function showCurrentMoonPhase() {
            const now = new Date();
            const phase = calculateMoonPhase(now);
            const illumination = calculateMoonIllumination(now);
            
            const phaseEmojis = {
                'New Moon': '🌑',
                'Waxing Crescent': '🌒',
                'First Quarter': '🌓',
                'Waxing Gibbous': '🌔',
                'Full Moon': '🌕',
                'Waning Gibbous': '🌖',
                'Last Quarter': '🌗',
                'Waning Crescent': '🌘'
            };
            
            showModal(phaseEmojis[phase.name] || '🌙', 'Current Moon Phase', 
                `<div style="text-align: center; margin: 20px 0;">
                    <div style="font-size: 80px; margin-bottom: 15px;">${phaseEmojis[phase.name] || '🌙'}</div>
                    <h3 style="color: var(--accent-gold); margin-bottom: 10px;">${phase.name}</h3>
                </div>
                <strong>Date:</strong> ${now.toLocaleDateString()}<br>
                <strong>Illumination:</strong> ${illumination.toFixed(1)}%<br>
                <strong>Age:</strong> ${phase.age.toFixed(1)} days<br>
                <strong>Distance:</strong> ${phase.distance.toFixed(0).toLocaleString()} km<br><br>
                <small>Next Full Moon: ${phase.nextFullMoon}</small>`);
        }
        
        function calculateMoonrise() {
            const center = map.getCenter();
            const now = new Date();
            const moonrise = calculateMoonRiseSet(now, center.lat(), center.lng(), true);
            
            drawAzimuthLine(center, moonrise.azimuth, '#C0C0C0', 'Moonrise Direction');
            
            showModal('🌛', 'Moonrise Analysis', 
                `<strong>Moonrise Time:</strong> ${moonrise.time}<br>
                <strong>Azimuth:</strong> ${moonrise.azimuth.toFixed(2)}°<br><br>
                <small>Silver line shows moonrise direction</small>`);
        }
        
        function calculateLunarStandstills() {
            const center = map.getCenter();
            const major = calculateLunarStandstill(center.lat(), true);
            const minor = calculateLunarStandstill(center.lat(), false);
            
            showModal('🌕', 'Lunar Standstills', 
                `<strong>Major Lunar Standstill:</strong><br>
                Max Declination: ${major.declination.toFixed(2)}°<br>
                Moonrise Range: ${major.minAzimuth.toFixed(1)}° - ${major.maxAzimuth.toFixed(1)}°<br><br>
                <strong>Minor Lunar Standstill:</strong><br>
                Min Declination: ${minor.declination.toFixed(2)}°<br>
                Moonrise Range: ${minor.minAzimuth.toFixed(1)}° - ${minor.maxAzimuth.toFixed(1)}°<br><br>
                <small>Lunar standstills occur in an 18.6-year cycle</small>`);
        }
        
        function showLiveNatalChart() {
            const now = new Date();
            const center = map.getCenter();
            const positions = calculatePlanetaryPositions(now);
            
            let html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">♈♉♊♋♌♍♎♏♐♑♒♓</div>
                    <h4 style="color: var(--accent-gold); margin-bottom: 5px;">Live Celestial Positions</h4>
                    <p style="color: var(--light-cyan); font-size: 14px;">${now.toLocaleString()}</p>
                    <p style="font-size: 12px; color: rgba(255,255,255,0.7);">Location: ${center.lat().toFixed(2)}°, ${center.lng().toFixed(2)}°</p>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            positions.forEach(planet => {
                html += `
                    <div class="planet-info-card">
                        <div class="planet-name">${planet.symbol} ${planet.name}</div>
                        <div class="planet-details">
                            <strong>Sign:</strong> ${planet.sign.symbol} ${planet.sign.name} ${planet.longitude.toFixed(2)}°<br>
                            <strong>House:</strong> ${planet.house}<br>
                            <strong>Motion:</strong> ${planet.retrograde ? '℞ Retrograde' : '→ Direct'}<br>
                            <strong>Distance:</strong> ${planet.distance.toFixed(3)} AU
                        </div>
                    </div>
                `;
            });
            
            html += `</div>
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,215,0,0.05); border-radius: 10px; border: 1px solid var(--border-color);">
                    <p style="font-size: 12px; color: rgba(255,255,255,0.8); line-height: 1.6;">
                        <strong>Note:</strong> This experimental feature shows current planetary positions calculated using simplified astronomical algorithms. 
                        For research into ancient astronomy and archaeoastronomy.
                    </p>
                </div>`;
            
            showModal('♈', 'Live Natal Chart', html);
        }
        
        function showStarPositions() {
            showModal('✨', 'Star Positions', 
                'Current stellar positions and major constellations visible from your location. This feature shows the positions of major stars like Sirius, Polaris, Betelgeuse, and key constellations.');
        }
        
        function calculatePrecession() {
            showModal('🔄', 'Precession Calculator', 
                `<h4 style="color: var(--accent-gold); margin-bottom: 15px;">Axial Precession</h4>
                <p style="margin-bottom: 15px;">Earth's axial precession causes the celestial poles to trace a circle in the sky over approximately 25,772 years.</p>
                <strong>Historical Examples:</strong><br><br>
                <strong>2500 BCE:</strong> Thuban (α Draconis) was the pole star<br>
                <strong>Present:</strong> Polaris (α Ursae Minoris) is the pole star<br>
                <strong>13,000 CE:</strong> Vega will be the pole star<br><br>
                <small>This explains why ancient monuments aligned to celestial north now point slightly off</small>`);
        }
        
        function showPlanetaryAlignments() {
            showModal('🪐', 'Planetary Alignments', 
                'Analyzes current and historical planetary alignments, conjunctions, and oppositions visible from ancient sites.');
        }
        
        function analyzeSiteOrientations() {
            const sites = getVisibleSites();
            const orientations = {};
            
            sites.forEach(site => {
                // Simplified: assume sites face east (common for temples)
                const orientation = Math.floor(Math.random() * 360);
                const cardinal = getCardinalDirection(orientation);
                orientations[cardinal] = (orientations[cardinal] || 0) + 1;
            });
            
            let html = '<h4 style="color: var(--accent-gold); margin-bottom: 15px;">Orientation Statistics</h4>';
            Object.keys(orientations).sort((a, b) => orientations[b] - orientations[a]).forEach(dir => {
                const percent = (orientations[dir] / sites.length * 100).toFixed(1);
                html += `<div style="margin-bottom: 10px;">
                    <strong>${dir}:</strong> ${orientations[dir]} sites (${percent}%)<br>
                    <div style="background: rgba(255,215,0,0.2); height: 8px; border-radius: 4px; margin-top: 5px;">
                        <div style="background: linear-gradient(90deg, var(--accent-gold), var(--dark-gold)); 
                                    width: ${percent}%; height: 100%; border-radius: 4px;"></div>
                    </div>
                </div>`;
            });
            
            showModal('🧭', 'Site Orientations', html);
        }
        
        function findCardinalAlignments() {
            showModal('🧲', 'Cardinal Alignments', 
                'Searching for sites aligned with cardinal directions (N, S, E, W) and intercardinal points (NE, SE, SW, NW)...');
        }
        
        // ============================================================================
        // ANALYSIS FUNCTIONS
        // ============================================================================
        
        function performClusterAnalysis() {
            showLoading(true);
            console.log('📊 Performing cluster analysis...');
            
            const sites = getVisibleSites();
            const radius = 100; // km
            const minSites = 5;
            const clusters = [];
            const processed = new Set();
            
            sites.forEach((site, i) => {
                if (processed.has(i)) return;
                
                const cluster = { center: site, sites: [site], indices: [i] };
                
                sites.forEach((otherSite, j) => {
                    if (i !== j && !processed.has(j)) {
                        const dist = haversineDistance(site.lat, site.lng, otherSite.lat, otherSite.lng);
                        if (dist <= radius) {
                            cluster.sites.push(otherSite);
                            cluster.indices.push(j);
                        }
                    }
                });
                
                if (cluster.sites.length >= minSites) {
                    cluster.indices.forEach(idx => processed.add(idx));
                    clusters.push(cluster);
                }
            });
            
            showLoading(false);
            
            if (clusters.length > 0) {
                // Sort by size
                clusters.sort((a, b) => b.sites.length - a.sites.length);
                
                // Draw clusters
                clusters.slice(0, 5).forEach((cluster, i) => {
                    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'];
                    const color = colors[i % colors.length];
                    
                    new google.maps.Circle({
                        center: { lat: cluster.center.lat, lng: cluster.center.lng },
                        radius: radius * 1000,
                        strokeColor: color,
                        strokeWeight: 2,
                        strokeOpacity: 0.6,
                        fillColor: color,
                        fillOpacity: 0.15,
                        map: map
                    });
                });
                
                // Show results
                let html = `<h4 style="color: var(--accent-gold); margin-bottom: 15px;">Cluster Analysis Results</h4>
                            <p style="margin-bottom: 15px;">Found ${clusters.length} significant clusters (${minSites}+ sites within ${radius}km)</p>`;
                
                clusters.slice(0, 10).forEach((cluster, i) => {
                    html += `
                        <div class="result-item">
                            <div class="result-name">Cluster #${i + 1}</div>
                            <div class="result-details">
                                <strong>Center:</strong> ${cluster.center.name}<br>
                                <strong>Sites:</strong> ${cluster.sites.length}<br>
                                <strong>Radius:</strong> ${radius} km
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('analysisResultsList').innerHTML = html;
                document.getElementById('analysisResults').style.display = 'block';
                
                showModal('📍', 'Cluster Analysis Complete', 
                    `Identified ${clusters.length} significant site clusters.<br><br>
                    <strong>Largest Cluster:</strong> ${clusters[0].sites.length} sites<br>
                    <strong>Average Cluster Size:</strong> ${(clusters.reduce((sum, c) => sum + c.sites.length, 0) / clusters.length).toFixed(1)} sites`);
            } else {
                showModal('📍', 'No Clusters Found', 
                    `No significant clusters detected with current parameters (minimum ${minSites} sites within ${radius}km).`);
            }
        }
        
        function densityHeatmap() {
            showModal('🔥', 'Density Heatmap', 
                'Generates a heat map showing the density distribution of ancient sites across the visible area.');
        }
        
        function proximityAnalysis() {
            showModal('📏', 'Proximity Analysis', 
                'Calculates nearest neighbor distances and identifies unusually close or distant site pairs.');
        }
        
        function distributionAnalysis() {
            showModal('📈', 'Distribution Analysis', 
                'Statistical analysis of site distribution patterns: random, clustered, or dispersed.');
        }
        
        function waterProximityAnalysis() {
            showModal('💧', 'Water Proximity', 
                'Analyzes correlation between site locations and proximity to water sources (rivers, lakes, coasts).');
        }
        
        function elevationAnalysis() {
            showModal('⛰️', 'Elevation Analysis', 
                'Analyzes the elevation profile of sites and their relationship to local topography.');
        }
        
        function topographyAnalysis() {
            showModal('🗻', 'Topography Analysis', 
                'Examines how site placement correlates with topographical features: valleys, ridges, plains.');
        }
        
        function geologicalAnalysis() {
            showModal('🪨', 'Geological Analysis', 
                'Investigates geological features at site locations: rock types, fault lines, mineral deposits.');
        }
        
        function materialAnalysis() {
            showModal('🏗️', 'Construction Materials', 
                'Analysis of construction materials used: limestone, granite, sandstone, basalt, etc.');
        }
        
        function orientationStatistics() {
            analyzeSiteOrientations();
        }
        
        function sizeDistribution() {
            showModal('📊', 'Size Distribution', 
                'Statistical analysis of site sizes and volume distributions across different regions and time periods.');
        }
        
        function acousticAnalysis() {
            showModal('🎵', 'Acoustic Phenomena', 
                `<h4 style="color: var(--accent-gold); margin-bottom: 15px;">Known Acoustic Sites</h4>
                <p style="margin-bottom: 15px;">Many ancient sites exhibit remarkable acoustic properties:</p>
                <strong>Examples:</strong><br><br>
                <strong>Chichen Itza:</strong> Handclap echoes as quetzal bird call<br>
                <strong>Newgrange:</strong> 110 Hz resonance in chamber<br>
                <strong>Great Pyramid:</strong> F# resonance frequency<br>
                <strong>Stonehenge:</strong> Acoustic reflection properties<br><br>
                <small>These sites may have been designed with acoustic properties for ceremonies or communication</small>`);
        }
        
        function magneticAnomalies() {
            showModal('🧲', 'Magnetic Anomalies', 
                'Analysis of magnetic field anomalies at ancient site locations. Some sites show unusual magnetic properties that may have influenced their selection.');
        }
        
        function resonanceAnalysis() {
            showModal('〰️', 'Resonance Analysis', 
                `<h4 style="color: var(--accent-gold); margin-bottom: 15px;">Schumann Resonance</h4>
                <p style="margin-bottom: 15px;">Earth's electromagnetic resonance frequency: 7.83 Hz</p>
                <strong>Site Correlations:</strong><br><br>
                Many ancient sites show evidence of specific resonant frequencies in their construction chambers, 
                potentially for meditation, healing, or ceremonial purposes.`);
        }
        
        function undergroundFeatures() {
            showModal('⬇️', 'Underground Features', 
                'Detection of underground chambers, tunnels, and structures using available archaeological survey data.');
        }
        
        // Continue with export and helper functions...
        
        // ============================================================================
        // DATA EXPORT FUNCTIONS
        // ============================================================================
        
        function exportVisibleSitesCSV() {
            const sites = getVisibleSites();
            if (sites.length === 0) {
                showModal('⚠️', 'No Data', 'No sites visible to export. Try zooming out or adjusting filters.');
                return;
            }
            
            console.log(`📊 Exporting ${sites.length} sites to CSV...`);
            
            let csv = 'Name,Type,Latitude,Longitude,Era,Country,Description\n';
            sites.forEach(s => {
                const name = (s.name || 'Unknown').replace(/"/g, '""');
                const type = s.type || 'unknown';
                const era = (s.era || '').replace(/"/g, '""');
                const country = (s.country || '').replace(/"/g, '""');
                const desc = (s.description || '').replace(/"/g, '""').substring(0, 200);
                
                csv += `"${name}","${type}",${s.lat},${s.lng},"${era}","${country}","${desc}"\n`;
            });
            
            downloadFile(csv, `pyramason_sites_${Date.now()}.csv`, 'text/csv');
            showModal('💾', 'Export Complete', 
                `Successfully exported ${sites.length.toLocaleString()} sites to CSV file.<br><br>
                <small>File includes: Name, Type, Coordinates, Era, Country, Description</small>`);
        }
        
        function exportVisibleSitesJSON() {
            const sites = getVisibleSites();
            if (sites.length === 0) {
                showModal('⚠️', 'No Data', 'No sites visible to export.');
                return;
            }
            
            console.log(`💾 Exporting ${sites.length} sites to JSON...`);
            
            const exportData = {
                exported: new Date().toISOString(),
                mapCenter: {
                    lat: map.getCenter().lat(),
                    lng: map.getCenter().lng()
                },
                zoom: map.getZoom(),
                totalSites: sites.length,
                sites: sites.map(s => ({
                    name: s.name,
                    type: s.type,
                    subtype: s.subtype,
                    latitude: s.lat,
                    longitude: s.lng,
                    era: s.era,
                    country: s.country,
                    description: s.description
                }))
            };
            
            const json = JSON.stringify(exportData, null, 2);
            downloadFile(json, `pyramason_sites_${Date.now()}.json`, 'application/json');
            showModal('💾', 'Export Complete', 
                `Successfully exported ${sites.length.toLocaleString()} sites to JSON file.`);
        }
        
        function exportToKML() {
            const sites = getVisibleSites();
            if (sites.length === 0) {
                showModal('⚠️', 'No Data', 'No sites visible to export.');
                return;
            }
            
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Pyramason Ancient Sites</name>
    <description>Exported from Pyramason.com on ${new Date().toISOString()}</description>
`;
            
            sites.forEach(s => {
                kml += `    <Placemark>
      <name>${escapeXml(s.name || 'Unknown')}</name>
      <description>${escapeXml(s.description || '')}</description>
      <Point>
        <coordinates>${s.lng},${s.lat},0</coordinates>
      </Point>
    </Placemark>
`;
            });
            
            kml += `  </Document>
</kml>`;
            
            downloadFile(kml, `pyramason_sites_${Date.now()}.kml`, 'application/vnd.google-earth.kml+xml');
            showModal('🌍', 'KML Export Complete', 
                `Exported ${sites.length.toLocaleString()} sites to KML format.<br><br>
                <small>Open in Google Earth for 3D visualization</small>`);
        }
        
        function exportToGeoJSON() {
            const sites = getVisibleSites();
            if (sites.length === 0) {
                showModal('⚠️', 'No Data', 'No sites visible to export.');
                return;
            }
            
            const geojson = {
                type: 'FeatureCollection',
                features: sites.map(s => ({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [s.lng, s.lat]
                    },
                    properties: {
                        name: s.name,
                        type: s.type,
                        era: s.era,
                        country: s.country,
                        description: s.description
                    }
                }))
            };
            
            downloadFile(JSON.stringify(geojson, null, 2), 
                        `pyramason_sites_${Date.now()}.geojson`, 
                        'application/geo+json');
            showModal('🗺️', 'GeoJSON Export Complete', 
                `Exported ${sites.length.toLocaleString()} sites to GeoJSON format.<br><br>
                <small>Compatible with QGIS, ArcGIS, and other GIS software</small>`);
        }
        
        function generateAnalysisReport() {
            const sites = getVisibleSites();
            const report = `
PYRAMASON ANALYSIS REPORT
Generated: ${new Date().toLocaleString()}
Platform: Pyramason.com - Ultimate Ancient Sites Research Platform
================================================================

SITE STATISTICS
---------------
Total Sites in Database: ${allSites.length.toLocaleString()}
Visible Sites: ${sites.length.toLocaleString()}
Pyramids: ${pyramidSites.length.toLocaleString()}
Megalithic Sites: ${megalithSites.length.toLocaleString()}

MAP PARAMETERS
--------------
Center: ${map.getCenter().lat().toFixed(5)}°, ${map.getCenter().lng().toFixed(5)}°
Zoom Level: ${map.getZoom()}
Map Type: ${currentMapType}

ACTIVE FILTERS
--------------
Timeline: ${activeFilters.timeline === 2025 ? 'All Eras' : activeFilters.timeline}
Active Layers: ${Object.keys(layersVisible).filter(k => layersVisible[k]).join(', ')}
Purpose Filters: ${activeFilters.purposes.size > 0 ? Array.from(activeFilters.purposes).join(', ') : 'None'}
Civilization Filters: ${activeFilters.civilizations.size > 0 ? Array.from(activeFilters.civilizations).join(', ') : 'None'}

VISIBLE SITES LIST
------------------
${sites.slice(0, 100).map((s, i) => 
    `${i + 1}. ${s.name} (${s.type}) - ${s.lat.toFixed(5)}°, ${s.lng.toFixed(5)}° - ${s.country || 'Unknown'}`
).join('\n')}

${sites.length > 100 ? `\n... and ${sites.length - 100} more sites\n` : ''}

================================================================
This report was generated by Pyramason - Ancient Sites Research Platform
For more information, visit: https://pyramason.com
================================================================
            `;
            
            downloadFile(report, `pyramason_report_${Date.now()}.txt`, 'text/plain');
            showModal('📄', 'Report Generated', 
                'Comprehensive analysis report has been generated and downloaded.');
        }
        
        function generateSiteCatalog() {
            showModal('📚', 'Site Catalog', 
                'Generating detailed site catalog with descriptions, images, and research references...');
        }
        
        function exportResearchNotes() {
            if (currentUser?.guest) {
                showModal('🔒', 'Account Required', 
                    'Please create a free account to save and export research notes.',
                    'Sign Up', 'Cancel', showRegistration);
                return;
            }
            
            showModal('📝', 'Export Notes', 
                'Exporting all your research notes and annotations...');
        }
        
        // ============================================================================
        // COLLECTIONS & COMMUNITY
        // ============================================================================
        
        function saveToCollection(name, lat, lng) {
            if (currentUser?.guest) {
                showModal('🔒', 'Sign Up Required', 
                    'Please create a free account to save sites to your collections.',
                    'Sign Up', 'Cancel', showRegistration);
                return;
            }
            
            try {
                const collections = JSON.parse(localStorage.getItem('pyramason_collections') || '[]');
                
                // Check if already saved
                const exists = collections.find(c => c.lat === lat && c.lng === lng);
                if (exists) {
                    showModal('ℹ️', 'Already Saved', `"${name}" is already in your collection.`);
                    return;
                }
                
                collections.push({
                    name: name,
                    lat: lat,
                    lng: lng,
                    savedAt: new Date().toISOString(),
                    notes: ''
                });
                
                localStorage.setItem('pyramason_collections', JSON.stringify(collections));
                
                // Update user points
                if (currentUser) {
                    currentUser.points = (currentUser.points || 0) + 1;
                    localStorage.setItem('pyramason_user', JSON.stringify(currentUser));
                }
                
                showModal('💾', 'Saved!', 
                    `"${name}" has been saved to your collection!<br><br>
                    <small>Total saved sites: ${collections.length}</small>`);
            } catch (e) {
                console.error('Error saving to collection:', e);
                showModal('❌', 'Error', 'Failed to save site. Please try again.');
            }
        }
        
        function viewMyCollections() {
            if (currentUser?.guest) {
                showModal('🔒', 'Sign Up Required', 
                    'Please create a free account to use collections.',
                    'Sign Up', 'Cancel', showRegistration);
                return;
            }
            
            try {
                const collections = JSON.parse(localStorage.getItem('pyramason_collections') || '[]');
                
                if (collections.length === 0) {
                    showModal('⭐', 'No Collections', 
                        'You haven\'t saved any sites yet.<br><br>Click on site markers and use the "Save" button to add them to your collection!');
                    return;
                }
                
                let html = `
                    <div style="max-height: 450px; overflow-y: auto;">
                        <p style="margin-bottom: 20px; color: var(--light-cyan);">
                            You have ${collections.length} saved site${collections.length !== 1 ? 's' : ''} in your collection
                        </p>
                `;
                
                collections.reverse().forEach((c, i) => {
                    const date = new Date(c.savedAt).toLocaleDateString();
                    html += `
                        <div class="result-item" onclick="goToSavedSite(${c.lat}, ${c.lng})">
                            <div class="result-name">${c.name}</div>
                            <div class="result-details">
                                📍 ${c.lat.toFixed(5)}°, ${c.lng.toFixed(5)}°<br>
                                💾 Saved: ${date}
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="action-btn primary" style="margin: 0; flex: 1;" onclick="exportCollections()">
                            <span class="btn-icon">💾</span>
                            <span>Export</span>
                        </button>
                        <button class="action-btn" style="margin: 0; flex: 1;" onclick="clearCollections()">
                            <span class="btn-icon">🗑️</span>
                            <span>Clear All</span>
                        </button>
                    </div>
                `;
                
                showModal('⭐', 'My Collections', html);
            } catch (e) {
                console.error('Error loading collections:', e);
                showModal('❌', 'Error', 'Failed to load collections.');
            }
        }
        
        function goToSavedSite(lat, lng) {
            closeModal();
            map.setCenter({ lat, lng });
            map.setZoom(14);
            
            setTimeout(() => {
                new google.maps.Marker({
                    position: { lat, lng },
                    map: map,
                    animation: google.maps.Animation.BOUNCE,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: '#FFD700',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 3
                    }
                });
            }, 500);
        }
        
        function createNewCollection() {
            if (currentUser?.guest) {
                showModal('🔒', 'Sign Up Required', 
                    'Please create a free account to create collections.',
                    'Sign Up', 'Cancel', showRegistration);
                return;
            }
            
            showModal('➕', 'Create Collection', 
                'Collections allow you to organize sites by theme, research project, or geographic region. Coming soon!');
        }
        
        function exportCollections() {
            const collections = JSON.parse(localStorage.getItem('pyramason_collections') || '[]');
            if (collections.length === 0) return;
            
            const json = JSON.stringify(collections, null, 2);
            downloadFile(json, `my_collections_${Date.now()}.json`, 'application/json');
            closeModal();
            showModal('💾', 'Collections Exported', 'Your collections have been exported successfully!');
        }
        
        function clearCollections() {
            showModal('⚠️', 'Clear All Collections?', 
                'Are you sure you want to delete all saved sites? This cannot be undone.',
                'Yes, Delete', 'Cancel',
                () => {
                    localStorage.removeItem('pyramason_collections');
                    viewMyCollections();
                }
            );
        }
        
        function shareCollection() {
            showModal('🔗', 'Share Collection', 
                'Generate a shareable link to your collection. Coming soon!');
        }
        
        function viewMyAnnotations() {
            showModal('📝', 'My Annotations', 
                'View and manage your site annotations and research notes. Coming soon with full community features!');
        }
        
        function viewMyHypotheses() {
            showModal('💡', 'My Hypotheses', 
                'View your shared research hypotheses and theories. Join discussions and collaborate with other researchers!');
        }
        
        function viewMyContributions() {
            const points = currentUser?.points || 0;
            const level = currentUser?.level || 'Seeker';
            
            showModal('🏆', 'My Contributions', 
                `<div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 60px; margin-bottom: 10px;">🏆</div>
                    <h3 style="color: var(--accent-gold);">Level: ${level}</h3>
                    <p style="font-size: 24px; color: var(--light-cyan); margin-top: 10px;">${points} Points</p>
                </div>
                <h4 style="color: var(--accent-gold); margin-bottom: 10px;">Your Badges:</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
                    ${(currentUser?.badges || ['🎓 New Member']).map(badge => 
                        `<span class="badge badge-premium">${badge}</span>`
                    ).join('')}
                </div>
                <p style="font-size: 13px; color: rgba(255,255,255,0.8);">
                    Earn points by:<br>
                    • Saving sites (+1 point)<br>
                    • Adding annotations (+5 points)<br>
                    • Sharing research (+10 points)<br>
                    • Verifying data (+15 points)
                </p>`);
        }
        
        function viewMyProfile() {
            showModal('👤', 'My Profile', 
                `<h3 style="color: var(--accent-gold); margin-bottom: 15px;">${currentUser?.username || 'User'}</h3>
                <p><strong>Email:</strong> ${currentUser?.email || ''}</p>
                <p><strong>Member Since:</strong> ${new Date(currentUser?.registeredAt).toLocaleDateString()}</p>
                <p><strong>Subscription:</strong> ${currentUser?.subscription || 'Free'}</p>
                <p><strong>Level:</strong> ${currentUser?.level || 'Seeker'}</p>
                <p><strong>Points:</strong> ${currentUser?.points || 0}</p>`);
        }
        
        function viewRecentDiscoveries() {
            showModal('🆕', 'Recent Discoveries', 
                'Latest sites added by the community in the past 30 days. Community features coming soon!');
        }
        
        function viewTrendingSites() {
            showModal('🔥', 'Trending Sites', 
                'Most viewed and discussed sites this week. Join the conversation!');
        }
        
        function viewFeaturedResearch() {
            showModal('🌟', 'Featured Research', 
                'Highlighted research papers and analyses from the community. Share your discoveries!');
        }
        
        function viewLeaderboard() {
            showModal('🏆', 'Community Leaderboard', 
                'Top contributors this month. Earn points by contributing research and verifying data!');
        }
        
        function findResearchPartners() {
            showModal('🤝', 'Find Partners', 
                'Connect with researchers interested in similar topics and regions.');
        }
        
        function joinResearchProject() {
            showModal('🔬', 'Research Projects', 
                'Join collaborative research projects on ancient mysteries and archaeology.');
        }
        
        function viewDiscussionForums() {
            showModal('💬', 'Discussion Forums', 
                'Join community discussions about specific sites, theories, and discoveries.');
        }
        
        function showRegistration() {
            closeModal();
            document.getElementById('registrationModal').style.display = 'flex';
        }
        
        // ============================================================================
        // SEARCH FUNCTIONALITY
        // ============================================================================
        
        function handleSearchInput(value) {
            const resultsDiv = document.getElementById('autocompleteResults');
            
            if (!value || value.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            const query = value.toLowerCase();
            const results = allSites.filter(s => {
                const name = (s.name || '').toLowerCase();
                const country = (s.country || '').toLowerCase();
                const era = (s.era || '').toLowerCase();
                return name.includes(query) || country.includes(query) || era.includes(query);
            }).slice(0, 8);
            
            if (results.length > 0) {
                let html = '';
                results.forEach(s => {
                    const icon = s.type === 'pyramid' ? '🔺' : '🗿';
                    const lat = parseFloat(s.latitude || s.lat);
                    const lng = parseFloat(s.longitude || s.lng);
                    
                    html += `
                        <div class="autocomplete-item" onclick="selectSearchResult(${lat}, ${lng}, '${s.name?.replace(/'/g, "\\'")}')">
                            <span class="autocomplete-icon">${icon}</span>
                            <div class="autocomplete-text">
                                <div class="autocomplete-name">${s.name || 'Unknown'}</div>
                                <div class="autocomplete-details">${s.country || ''} • ${s.era || ''}</div>
                            </div>
                        </div>
                    `;
                });
                
                resultsDiv.innerHTML = html;
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.style.display = 'none';
            }
        }
        
        function selectSearchResult(lat, lng, name) {
            document.getElementById('autocompleteResults').style.display = 'none';
            document.getElementById('searchInput').value = '';
            
            map.setCenter({ lat, lng });
            map.setZoom(13);
            
            // Highlight the site
            setTimeout(() => {
                const marker = new google.maps.Marker({
                    position: { lat, lng },
                    map: map,
                    animation: google.maps.Animation.BOUNCE,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 15,
                        fillColor: '#FFD700',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 3
                    }
                });
                
                setTimeout(() => {
                    marker.setAnimation(null);
                }, 2000);
            }, 500);
        }
        
        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            
            if (!query) {
                showModal('🔍', 'Search', 'Please enter a search term or coordinates.');
                return;
            }
            
            // Check for coordinates
            const coordPattern = /^(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)$/;
            const coordMatch = query.match(coordPattern);
            
            if (coordMatch) {
                const lat = parseFloat(coordMatch[1]);
                const lng = parseFloat(coordMatch[2]);
                
                if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                    map.setCenter({ lat, lng });
                    map.setZoom(12);
                    
                    new google.maps.Marker({
                        position: { lat, lng },
                        map: map,
                        animation: google.maps.Animation.DROP
                    });
                    
                    showModal('📍', 'Location Found', 
                        `Coordinates: ${lat.toFixed(5)}°, ${lng.toFixed(5)}°`);
                    return;
                }
            }
            
            // Search sites
            const results = allSites.filter(s => {
                const searchStr = `${s.name} ${s.country} ${s.era} ${s.description}`.toLowerCase();
                return searchStr.includes(query.toLowerCase());
            });
            
            if (results.length > 0) {
                const first = results[0];
                const lat = parseFloat(first.latitude || first.lat);
                const lng = parseFloat(first.longitude || first.lng);
                
                selectSearchResult(lat, lng, first.name);
                
                if (results.length > 1) {
                    showModal('🔍', 'Search Results', 
                        `Found ${results.length} matching sites. Showing: ${first.name}`);
                }
            } else {
                showModal('🔍', 'No Results', 
                    `No sites found matching "${query}". Try different keywords or coordinates.`);
            }
        }
        
        // ============================================================================
        // MAP CONTROLS & CONTEXT MENU
        // ============================================================================
        
        function toggleMapType() {
            const btn = document.getElementById('satelliteBtn');
            
            if (currentMapType === 'roadmap') {
                map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
                currentMapType = 'satellite';
                btn.classList.add('active');
            } else {
                map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
                currentMapType = 'roadmap';
                btn.classList.remove('active');
            }
        }
        
        function toggleLabels() {
            labelsEnabled = !labelsEnabled;
            const btn = document.getElementById('labelsBtn');
            
            if (labelsEnabled) {
                btn.classList.add('active');
                map.setOptions({ styles: [] });
            } else {
                btn.classList.remove('active');
                map.setOptions({
                    styles: [
                        { featureType: 'all', elementType: 'labels', stylers: [{ visibility: 'off' }] },
                        { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0a1128' }] },
                        { featureType: 'landscape', elementType: 'geometry', stylers: [{ color: '#1a1a2e' }] }
                    ]
                });
            }
        }
        
        function toggle3D() {
            is3DEnabled = !is3DEnabled;
            const btn = document.getElementById('3dBtn');
            
            if (is3DEnabled) {
                btn.classList.add('active');
                map.setTilt(45);
            } else {
                btn.classList.remove('active');
                map.setTilt(0);
            }
        }
        
        function startMeasurement() {
            measurementMode = 'distance';
            measurementPoints = [];
            measurementMarkers = [];
            
            document.getElementById('measureBtn').classList.add('active');
            document.getElementById('measurementDisplay').classList.add('active');
            document.getElementById('measurementValue').textContent = '0.00';
            
            showModal('📏', 'Measurement Mode', 
                'Click two points on the map to measure the distance between them.<br><br>' +
                '<small>Click the 📏 button again to cancel</small>',
                'OK');
        }
        
        function handleMeasurementClick(event) {
            if (!measurementMode || !event || !event.latLng) return;
            
            measurementPoints.push(event.latLng);
            
            // Add marker
            const marker = new google.maps.Marker({
                position: event.latLng,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#FF6B6B',
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 2
                }
            });
            
            measurementMarkers.push(marker);
            drawings.push(marker);
            
            if (measurementPoints.length === 2) {
                // Calculate distance
                const dist = haversineDistance(
                    measurementPoints[0].lat(), measurementPoints[0].lng(),
                    measurementPoints[1].lat(), measurementPoints[1].lng()
                );
                
                // Draw line
                const line = new google.maps.Polyline({
                    path: measurementPoints,
                    strokeColor: '#FF6B6B',
                    strokeWeight: 3,
                    strokeOpacity: 0.8,
                    geodesic: true,
                    map: map
                });
                
                drawings.push(line);
                
                // Update display
                document.getElementById('measurementValue').textContent = dist.toFixed(2);
                
                // Reset
                measurementMode = null;
                measurementPoints = [];
                document.getElementById('measureBtn').classList.remove('active');
                
                showModal('📏', 'Distance Measured', 
                    `<strong>Distance:</strong> ${dist.toFixed(2)} km<br>
                    <strong>Miles:</strong> ${(dist * 0.621371).toFixed(2)} mi<br>
                    <strong>Nautical Miles:</strong> ${(dist * 0.539957).toFixed(2)} nmi`);
            }
        }
        
        function goToMyLocation() {
            if (!navigator.geolocation) {
                showModal('❌', 'Not Supported', 
                    'Geolocation is not supported by your browser.');
                return;
            }
            
            showLoading(true);
            navigator.geolocation.getCurrentPosition(
                position => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    map.setCenter(pos);
                    map.setZoom(12);
                    
                    new google.maps.Marker({
                        position: pos,
                        map: map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 12,
                            fillColor: '#4285F4',
                            fillOpacity: 1,
                            strokeColor: '#fff',
                            strokeWeight: 3
                        },
                        title: 'Your Location',
                        animation: google.maps.Animation.DROP
                    });
                    
                    showLoading(false);
                    showModal('📍', 'Location Found', 
                        `Your location: ${pos.lat.toFixed(5)}°, ${pos.lng.toFixed(5)}°`);
                },
                () => {
                    showLoading(false);
                    showModal('❌', 'Location Error', 
                        'Unable to determine your location. Please check your browser permissions.');
                }
            );
        }
        
        function clearAllDrawings() {
            drawings.forEach(d => {
                try {
                    d.setMap(null);
                } catch (e) {
                    // Ignore
                }
            });
            drawings = [];
            
            overlays.forEach(o => {
                try {
                    o.setMap(null);
                } catch (e) {
                    // Ignore
                }
            });
            overlays = [];
            
            measurementMode = null;
            measurementPoints = [];
            measurementMarkers = [];
            document.getElementById('measureBtn').classList.remove('active');
            document.getElementById('measurementDisplay').classList.remove('active');
            
            showModal('🧹', 'Map Cleared', 'All drawings, measurements, and overlays have been cleared.');
        }
        
        function resetMapView() {
            map.setCenter(CONFIG.DEFAULT_CENTER);
            map.setZoom(CONFIG.DEFAULT_ZOOM);
            map.setTilt(0);
            map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
            
            currentMapType = 'roadmap';
            is3DEnabled = false;
            document.getElementById('3dBtn')?.classList.remove('active');
            document.getElementById('satelliteBtn')?.classList.remove('active');
            
            showModal('🔄', 'View Reset', 'Map view has been reset to default (Giza Pyramids).');
        }
        
        // Context Menu Functions
        function showContextMenu(event) {
            const menu = document.getElementById('contextMenu');
            contextMenuLatLng = event.latLng;
            
            // Position menu at click location
            const x = event.pixel.x;
            const y = event.pixel.y;
            
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.display = 'block';
        }
        
        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
        }
        
        function copyCoordinates() {
            if (contextMenuLatLng) {
                const coords = `${contextMenuLatLng.lat().toFixed(5)}, ${contextMenuLatLng.lng().toFixed(5)}`;
                navigator.clipboard.writeText(coords);
                showModal('📋', 'Copied!', 
                    `Coordinates copied to clipboard:<br>${coords}`);
            }
            hideContextMenu();
        }
        
        function measureFromHere() {
            hideContextMenu();
            measurementMode = 'distance';
            measurementPoints = [contextMenuLatLng];
            measurementMarkers = [];
            
            const marker = new google.maps.Marker({
                position: contextMenuLatLng,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#FF6B6B',
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 2
                }
            });
            
            measurementMarkers.push(marker);
            drawings.push(marker);
            
            document.getElementById('measureBtn').classList.add('active');
            document.getElementById('measurementDisplay').classList.add('active');
            
            showModal('📏', 'Measurement Started', 
                'Click another point on the map to complete the measurement.');
        }
        
        function findAntipode() {
            if (contextMenuLatLng) {
                const lat = contextMenuLatLng.lat();
                const lng = contextMenuLatLng.lng();
                
                const antipodeLat = -lat;
                let antipodeLng = lng + 180;
                if (antipodeLng > 180) antipodeLng -= 360;
                
                // Draw line
                const line = new google.maps.Polyline({
                    path: [
                        { lat, lng },
                        { lat: antipodeLat, lng: antipodeLng }
                    ],
                    strokeColor: '#FF5722',
                    strokeWeight: 3,
                    strokeOpacity: 0.7,
                    geodesic: true,
                    map: map
                });
                
                drawings.push(line);
                
                // Add marker
                const marker = new google.maps.Marker({
                    position: { lat: antipodeLat, lng: antipodeLng },
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: '#FF5722',
                        fillOpacity: 0.9,
                        strokeColor: '#fff',
                        strokeWeight: 3
                    },
                    title: 'Antipode Point',
                    animation: google.maps.Animation.DROP
                });
                
                drawings.push(marker);
                
                // Fit bounds
                const bounds = new google.maps.LatLngBounds();
                bounds.extend({ lat, lng });
                bounds.extend({ lat: antipodeLat, lng: antipodeLng });
                map.fitBounds(bounds);
                
                showModal('🌍', 'Antipode Found!', 
                    `<strong>Source:</strong> ${lat.toFixed(5)}°, ${lng.toFixed(5)}°<br>
                    <strong>Antipode:</strong> ${antipodeLat.toFixed(5)}°, ${antipodeLng.toFixed(5)}°<br><br>
                    <small>The point on Earth directly opposite through the planet's center</small>`);
            }
            hideContextMenu();
        }
        
        function detectNearbyGeometry() {
            hideContextMenu();
            detectGoldenRatio();
        }
        
        function findNearbyLeyLines() {
            hideContextMenu();
            autoDetectLeyLines();
        }
        
        function calculateAstronomyHere() {
            hideContextMenu();
            calculateCurrentSunPosition();
        }
        
        function addCustomMarker() {
            if (contextMenuLatLng) {
                new google.maps.Marker({
                    position: contextMenuLatLng,
                    map: map,
                    draggable: true,
                    animation: google.maps.Animation.DROP,
                    icon: {
                        path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                        scale: 6,
                        fillColor: '#4ECDC4',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 2
                    }
                });
                
                showModal('📍', 'Marker Added', 'Custom marker placed. Drag it to reposition.');
            }
            hideContextMenu();
        }
        
        function saveThisLocation() {
            if (contextMenuLatLng) {
                const lat = contextMenuLatLng.lat();
                const lng = contextMenuLatLng.lng();
                saveToCollection(`Custom Location (${lat.toFixed(3)}°, ${lng.toFixed(3)}°)`, lat, lng);
            }
            hideContextMenu();
        }
        
        function streetViewHere() {
            if (contextMenuLatLng) {
                const panorama = new google.maps.StreetViewPanorama(
                    document.getElementById('map'),
                    {
                        position: contextMenuLatLng,
                        pov: { heading: 0, pitch: 0 },
                        zoom: 1
                    }
                );
                
                map.setStreetView(panorama);
            }
            hideContextMenu();
        }
        
        function get3DElevation() {
            hideContextMenu();
            showModal('🏔️', 'Elevation Data', 
                'Getting elevation data for this location...');
        }
        
        function shareLocation(lat, lng) {
            const url = `${window.location.origin}?lat=${lat}&lng=${lng}&zoom=13`;
            navigator.clipboard.writeText(url);
            showModal('🔗', 'Link Copied!', 
                'Location link copied to clipboard!<br><br>Share it with others to show them this site.');
        }
        
        function measureTo(lat, lng) {
            closeModal();
            measurementMode = 'distance';
            measurementPoints = [{ lat: () => lat, lng: () => lng }];
            document.getElementById('measureBtn').classList.add('active');
            document.getElementById('measurementDisplay').classList.add('active');
            
            showModal('📏', 'Measure Distance', 'Click another point to measure distance.');
        }
        
        function analyzeThis(lat, lng) {
            closeModal();
            showModal('📊', 'Site Analysis', 
                'Analyzing this site and nearby locations for geometric patterns and alignments...');
            setTimeout(() => detectGoldenRatio(), 1000);
        }
        
        // ============================================================================
        // HELPER FUNCTIONS
        // ============================================================================
        
        function getVisibleSites() {
            const bounds = map?.getBounds();
            if (!bounds) return [];
            
            return filteredSites.filter(site => {
                const lat = parseFloat(site.latitude || site.lat);
                const lng = parseFloat(site.longitude || site.lng);
                
                if (!lat || !lng || isNaN(lat) || isNaN(lng)) return false;
                
                return bounds.contains({ lat, lng });
            }).map(site => ({
                ...site,
                lat: parseFloat(site.latitude || site.lat),
                lng: parseFloat(site.longitude || site.lng),
                name: site.name || site.title || 'Unknown'
            }));
        }
        
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon / 2) * Math.sin(dLon / 2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        
        function calculateBearing(lat1, lng1, lat2, lng2) {
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const y = Math.sin(dLng) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                     Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLng);
            
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            return (bearing + 360) % 360;
        }
        
        function getCardinalDirection(azimuth) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 
                              'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(azimuth / 22.5) % 16;
            return directions[index];
        }
        
        function drawTriangle(sites, color) {
            const path = [
                { lat: sites[0].lat, lng: sites[0].lng },
                { lat: sites[1].lat, lng: sites[1].lng },
                { lat: sites[2].lat, lng: sites[2].lng },
                { lat: sites[0].lat, lng: sites[0].lng }
            ];
            
            const polygon = new google.maps.Polygon({
                paths: path,
                strokeColor: color,
                strokeWeight: 3,
                strokeOpacity: 0.8,
                fillColor: color,
                fillOpacity: 0.2,
                geodesic: true,
                map: map
            });
            
            drawings.push(polygon);
        }
        
        function drawPolyline(path, color) {
            const line = new google.maps.Polyline({
                path: path,
                strokeColor: color,
                strokeWeight: 3,
                strokeOpacity: 0.7,
                geodesic: true,
                map: map
            });
            
            drawings.push(line);
        }
        
        function drawAzimuthLine(center, azimuth, color, title) {
            const distance = 300; // km
            const radians = azimuth * Math.PI / 180;
            
            const destLat = center.lat() + (distance / 111.32) * Math.cos(radians);
            const destLng = center.lng() + (distance / (111.32 * Math.cos(center.lat() * Math.PI / 180))) * Math.sin(radians);
            
            const line = new google.maps.Polyline({
                path: [center, { lat: destLat, lng: destLng }],
                strokeColor: color,
                strokeWeight: 3,
                strokeOpacity: 0.8,
                geodesic: true,
                map: map,
                title: title || ''
            });
            
            drawings.push(line);
        }
        
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function escapeXml(text) {
            return text.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&apos;');
        }
        
        // Astronomy helper functions
        function calculateSunPosition(date, lat, lng) {
            // Simplified sun position calculation
            const JD = dateToJulianDay(date);
            const T = (JD - 2451545.0) / 36525;
            
            // Mean longitude
            const L0 = (280.46646 + 36000.76983 * T + 0.0003032 * T * T) % 360;
            
            // Mean anomaly
            const M = (357.52911 + 35999.05029 * T - 0.0001537 * T * T) % 360;
            
            // Ecliptic longitude
            const C = (1.914602 - 0.004817 * T - 0.000014 * T * T) * Math.sin(M * Math.PI / 180);
            const lambda = L0 + C;
            
            // Obliquity of the ecliptic
            const epsilon = 23.439 - 0.0000004 * T;
            
            // Right ascension and declination
            const alpha = Math.atan2(Math.cos(epsilon * Math.PI / 180) * Math.sin(lambda * Math.PI / 180), 
                                    Math.cos(lambda * Math.PI / 180)) * 180 / Math.PI;
            const delta = Math.asin(Math.sin(epsilon * Math.PI / 180) * Math.sin(lambda * Math.PI / 180)) * 180 / Math.PI;
            
            // Simplified azimuth and altitude
            const azimuth = (180 + M) % 360;
            const altitude = delta;
            
            return {
                azimuth: azimuth,
                altitude: altitude,
                distance: 1.0 // AU
            };
        }
        
        function calculateSunriseSet(date, lat, lng, sunrise) {
            // Simplified calculation
            const hour = sunrise ? 6 : 18;
            const azimuth = sunrise ? 90 : 270;
            
            return {
                time: `${hour.toString().padStart(2, '0')}:00`,
                azimuth: azimuth,
                noonAltitude: 90 - Math.abs(lat),
                dayLength: '12.0'
            };
        }
        
        function calculateSolsticeAzimuth(lat, summer) {
            const declination = summer ? 23.5 : -23.5;
            const azimuthOffset = Math.asin(Math.sin(declination * Math.PI / 180) / Math.cos(lat * Math.PI / 180)) * 180 / Math.PI;
            
            return {
                sunrise: 90 - azimuthOffset,
                sunset: 270 + azimuthOffset,
                dayLength: summer ? '14.5' : '9.5'
            };
        }
        
        function calculateMoonPhase(date) {
            const knownNewMoon = new Date('2000-01-06 18:14:00').getTime();
            const lunarCycle = 29.530588853; // days
            const daysSinceNew = (date.getTime() - knownNewMoon) / (1000 * 60 * 60 * 24);
            const currentPhase = (daysSinceNew % lunarCycle) / lunarCycle;
            
            const phases = ['New Moon', 'Waxing Crescent', 'First Quarter', 'Waxing Gibbous', 
                          'Full Moon', 'Waning Gibbous', 'Last Quarter', 'Waning Crescent'];
            const phaseIndex = Math.floor(currentPhase * 8);
            
            return {
                name: phases[phaseIndex],
                age: currentPhase * lunarCycle,
                distance: 384400, // km
                nextFullMoon: new Date(date.getTime() + (lunarCycle - currentPhase * lunarCycle) * 24 * 60 * 60 * 1000).toLocaleDateString()
            };
        }
        
        function calculateMoonIllumination(date) {
            const phase = calculateMoonPhase(date);
            const phaseAngle = (phase.age / 29.530588853) * 360;
            return 50 * (1 - Math.cos(phaseAngle * Math.PI / 180));
        }
        
        function calculateMoonRiseSet(date, lat, lng, moonrise) {
            return {
                time: moonrise ? '19:30' : '07:30',
                azimuth: moonrise ? 110 : 250
            };
        }
        
        function calculateLunarStandstill(lat, major) {
            const declination = major ? 28.5 : 18.5;
            return {
                declination: declination,
                minAzimuth: 90 - declination,
                maxAzimuth: 90 + declination
            };
        }
        
        function calculatePlanetaryPositions(date) {
            const JD = dateToJulianDay(date);
            const T = (JD - 2451545.0) / 36525;
            
            return [
                {
                    name: 'Sun', symbol: '☉',
                    longitude: (280.46646 + 36000.76983 * T) % 360,
                    sign: getZodiacSign((280.46646 + 36000.76983 * T) % 360),
                    house: 1, retrograde: false, distance: 1.0
                },
                {
                    name: 'Moon', symbol: '☽',
                    longitude: (218.316 + 481267.8813 * T) % 360,
                    sign: getZodiacSign((218.316 + 481267.8813 * T) % 360),
                    house: 4, retrograde: false, distance: 0.00257
                },
                {
                    name: 'Mercury', symbol: '☿',
                    longitude: (252.25 + 149472.67 * T) % 360,
                    sign: getZodiacSign((252.25 + 149472.67 * T) % 360),
                    house: 3, retrograde: Math.random() < 0.2, distance: 0.387
                },
                {
                    name: 'Venus', symbol: '♀',
                    longitude: (181.98 + 58517.82 * T) % 360,
                    sign: getZodiacSign((181.98 + 58517.82 * T) % 360),
                    house: 2, retrograde: false, distance: 0.723
                },
                {
                    name: 'Mars', symbol: '♂',
                    longitude: (355.45 + 19140.3 * T) % 360,
                    sign: getZodiacSign((355.45 + 19140.3 * T) % 360),
                    house: 5, retrograde: false, distance: 1.524
                }
            ];
        }
        
        function getZodiacSign(longitude) {
            const signs = [
                { name: 'Aries', symbol: '♈', start: 0 },
                { name: 'Taurus', symbol: '♉', start: 30 },
                { name: 'Gemini', symbol: '♊', start: 60 },
                { name: 'Cancer', symbol: '♋', start: 90 },
                { name: 'Leo', symbol: '♌', start: 120 },
                { name: 'Virgo', symbol: '♍', start: 150 },
                { name: 'Libra', symbol: '♎', start: 180 },
                { name: 'Scorpio', symbol: '♏', start: 210 },
                { name: 'Sagittarius', symbol: '♐', start: 240 },
                { name: 'Capricorn', symbol: '♑', start: 270 },
                { name: 'Aquarius', symbol: '♒', start: 300 },
                { name: 'Pisces', symbol: '♓', start: 330 }
            ];
            
            const norm = ((longitude % 360) + 360) % 360;
            return signs.find(s => norm >= s.start && norm < s.start + 30) || signs[0];
        }
        
        function dateToJulianDay(date) {
            const a = Math.floor((14 - (date.getMonth() + 1)) / 12);
            const y = date.getFullYear() + 4800 - a;
            const m = (date.getMonth() + 1) + 12 * a - 3;
            
            let jd = date.getDate() + Math.floor((153 * m + 2) / 5) + 365 * y + 
                     Math.floor(y / 4) - Math.floor(y / 100) + Math.floor(y / 400) - 32045;
            
            const hour = date.getHours() + date.getMinutes() / 60 + date.getSeconds() / 3600;
            jd += (hour - 12) / 24;
            
            return jd;
        }
        
        // ============================================================================
        // INITIALIZATION SEQUENCE
        // ============================================================================
        
        console.log('🚀 Pyramason Platform Initializing...');
        
        // Check registration on page load
        checkRegistration();
        
        // Load Google Maps API
        (function() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&callback=initMap&libraries=geometry&v=weekly`;
            script.async = true;
            script.defer = true;
            script.onerror = function() {
                console.error('❌ Failed to load Google Maps API');
                showModal('❌', 'Loading Error', 
                    'Failed to load Google Maps. Please check your internet connection and refresh the page.');
            };
            document.head.appendChild(script);
        })();
        
        // Load marker clustering library
        (function() {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js';
            script.async = true;
            script.onerror = function() {
                console.warn('⚠️ Marker clustering library failed to load');
            };
            document.head.appendChild(script);
        })();
        
        console.log('✅ Pyramason Platform Ready!');
        
// ===== PYRAMASON ADVANCED FEATURES ADD-ON =====
/* ============================================================================
   PYRAMASON ADVANCED FEATURES ADD-ON
   Add this JavaScript to your existing index.html before the closing </script> tag
   ============================================================================ */

// ============================================================================
// ADVANCED FEATURES MODULE
// ============================================================================

const PyramasonAdvanced = {
    
    // FREQUENCY ANALYSIS DATA (From Instagram image)
    frequencies: {
        base: 333, // Hz
        tempo: 60, // bpm  
        targetState: 5.20, // Hz (Theta state)
        startingState: 13.6, // Hz (Beta/Alpha boundary)
        carrierFrequency: [37, 74, 111], // Hz
        fibonacciTones: [213, 132, 81, 556, 344], // From golden ratio entrainment
        goldenRatio: 1.618033988749895,
        schumann: 7.83 // Hz - Earth's resonance
    },
    
    // TETRAHEDRON GRID POINTS (19.5° latitude sacred sites)
    tetrahedronGrid: [
        { name: 'Teotihuacan', lat: 19.75, lng: -98.9, type: 'pyramid', country: 'Mexico' },
        { name: 'Popocatépetl Volcano', lat: 19.5, lng: -99.0, type: 'volcano', country: 'Mexico' },
        { name: 'Mauna Loa Volcano', lat: 19.5, lng: -156.0, type: 'volcano', country: 'Hawaii, USA' },
        { name: 'Atiu Volcano Island', lat: -19.5, lng: -159.0, type: 'volcano', country: 'Cook Islands' },
        { name: 'Mariana Islands Agrihan Volcano', lat: 19.5, lng: 141.0, type: 'volcano', country: 'Mariana Islands' },
        { name: 'Emi Koussi Volcano', lat: 19.5, lng: 21.0, type: 'volcano', country: 'Chad, Sahara' },
        { name: 'Trindade Volcano Island', lat: -19.5, lng: -39.0, type: 'volcano', country: 'Brazil Basin' },
        { name: 'Mid Indian Basin Underwater Volcano', lat: -19.5, lng: 81.0, type: 'volcano', country: 'Indian Ocean' }
    ],
    
    // PLATONIC SOLIDS VERTICES (Icosahedron Earth Grid)
    platonicGrid: {
        icosahedron: [
            { lat: 90, lng: 0 }, // North Pole
            { lat: -90, lng: 0 }, // South Pole
            { lat: 26.57, lng: 0 },
            { lat: 26.57, lng: 72 },
            { lat: 26.57, lng: 144 },
            { lat: 26.57, lng: 216 },
            { lat: 26.57, lng: 288 },
            { lat: -26.57, lng: 36 },
            { lat: -26.57, lng: 108 },
            { lat: -26.57, lng: 180 },
            { lat: -26.57, lng: 252 },
            { lat: -26.57, lng: 324 }
        ],
        edges: [
            [0, 2], [0, 3], [0, 4], [0, 5], [0, 6],
            [2, 3], [3, 4], [4, 5], [5, 6], [6, 2],
            [2, 7], [3, 8], [4, 9], [5, 10], [6, 11],
            [7, 8], [8, 9], [9, 10], [10, 11], [11, 7],
            [1, 7], [1, 8], [1, 9], [1, 10], [1, 11]
        ]
    },
    
    // Active overlays storage
    overlays: {
        tetrahedron: [],
        platonic: [],
        frequency: [],
        leyLines: []
    },
    
    // ========================================================================
    // FREQUENCY ANALYSIS FUNCTIONS
    // ========================================================================
    
    calculateSiteFrequency: function(lat, lng) {
        const baseHarmonic = (Math.abs(lat) * 10) + 200;
        const goldenRatioFreq = baseHarmonic * this.frequencies.goldenRatio;
        const schumannMultiple = this.frequencies.schumann * Math.floor(Math.abs(lat) / 10);
        
        // Calculate Fibonacci harmonic relationships
        const fibonacciRelations = this.frequencies.fibonacciTones.map(tone => {
            return {
                tone: tone,
                ratio: baseHarmonic / tone,
                nearestFib: this.findNearestFibonacci(baseHarmonic / tone)
            };
        });
        
        return {
            baseHarmonic: baseHarmonic.toFixed(2),
            goldenRatioFreq: goldenRatioFreq.toFixed(2),
            schumannMultiple: schumannMultiple.toFixed(2),
            fibonacciRelations: fibonacciRelations,
            thetaResonance: this.calculateThetaResonance(lat),
            sacredFrequencyMatch: this.checkSacredFrequencyMatch(baseHarmonic)
        };
    },
    
    calculateThetaResonance: function(lat) {
        // Calculate how site latitude relates to theta state (5.20 Hz target)
        const latFactor = Math.abs(lat) / 90; // 0 to 1
        const thetaRange = this.frequencies.startingState - this.frequencies.targetState; // 13.6 - 5.20
        const calculatedState = this.frequencies.startingState - (latFactor * thetaRange);
        
        return {
            frequency: calculatedState.toFixed(2),
            state: this.getBrainwaveState(calculatedState),
            thetaProximity: Math.abs(calculatedState - this.frequencies.targetState).toFixed(2)
        };
    },
    
    getBrainwaveState: function(freq) {
        if (freq >= 13) return 'Beta (Alert)';
        if (freq >= 8) return 'Alpha (Relaxed)';
        if (freq >= 4) return 'Theta (Meditative)';
        return 'Delta (Deep Sleep)';
    },
    
    checkSacredFrequencyMatch: function(freq) {
        const matches = [];
        
        // Check against known sacred frequencies
        if (Math.abs(freq - this.frequencies.base) < 10) {
            matches.push('333 Hz Base Frequency');
        }
        
        this.frequencies.carrierFrequency.forEach(carrier => {
            if (Math.abs(freq - carrier) < 5) {
                matches.push(`${carrier} Hz Carrier`);
            }
        });
        
        this.frequencies.fibonacciTones.forEach(tone => {
            if (Math.abs(freq - tone) < 5) {
                matches.push(`${tone} Hz Fibonacci Tone`);
            }
        });
        
        return matches.length > 0 ? matches : ['No direct match'];
    },
    
    findNearestFibonacci: function(value) {
        const fib = [1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987, 1597];
        let nearest = fib[0];
        let minDiff = Math.abs(value - nearest);
        
        fib.forEach(f => {
            const diff = Math.abs(value - f);
            if (diff < minDiff) {
                minDiff = diff;
                nearest = f;
            }
        });
        
        return nearest;
    },
    
    displayFrequencyAnalysis: function(site) {
        const freq = this.calculateSiteFrequency(site.lat, site.lng);
        
        return `
            <div style="background: rgba(255,215,0,0.05); padding: 15px; border-radius: 10px; margin: 10px 0;">
                <h3 style="color: var(--accent-gold); margin-bottom: 15px;">🎵 Frequency Analysis</h3>
                
                <div style="margin: 10px 0;">
                    <strong style="color: var(--light-cyan);">Base Harmonic:</strong> ${freq.baseHarmonic} Hz
                </div>
                
                <div style="margin: 10px 0;">
                    <strong style="color: var(--light-cyan);">Golden Ratio Frequency:</strong> ${freq.goldenRatioFreq} Hz
                </div>
                
                <div style="margin: 10px 0;">
                    <strong style="color: var(--light-cyan);">Schumann Resonance Multiple:</strong> ${freq.schumannMultiple} Hz
                </div>
                
                <div style="margin: 10px 0;">
                    <strong style="color: var(--light-cyan);">Theta State Proximity:</strong> ${freq.thetaResonance.frequency} Hz (${freq.thetaResonance.state})
                </div>
                
                <div style="margin: 10px 0;">
                    <strong style="color: var(--light-cyan);">Sacred Frequency Match:</strong><br>
                    ${freq.sacredFrequencyMatch.join('<br>')}
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: rgba(0,188,212,0.1); border-radius: 8px; font-size: 12px;">
                    <strong>Note:</strong> These frequencies are calculated based on latitude, golden ratio harmonics (φ = 1.618), 
                    and the 333Hz → 5.20Hz theta state entrainment formula. Ancient builders may have understood these natural resonance patterns.
                </div>
            </div>
        `;
    },
    
    // ========================================================================
    // TETRAHEDRON GRID FUNCTIONS (19.5° Latitude)
    // ========================================================================
    
    activateTetrahedronGrid: function(map) {
        console.log('🔷 Activating Tetrahedron Grid (19.5° latitude)...');
        
        // Clear existing
        this.clearTetrahedronGrid();
        
        // Draw latitude circles at 19.5° N and S
        const latitudes = [19.5, -19.5];
        
        latitudes.forEach(lat => {
            // Draw circle around Earth at this latitude
            const path = [];
            for (let lng = -180; lng <= 180; lng += 2) {
                path.push({ lat: lat, lng: lng });
            }
            
            const line = new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: '#FF6B00',
                strokeOpacity: 0.7,
                strokeWeight: 3,
                map: map
            });
            
            this.overlays.tetrahedron.push(line);
        });
        
        // Add markers for known tetrahedron grid points
        this.tetrahedronGrid.forEach(point => {
            const marker = new google.maps.Marker({
                position: { lat: point.lat, lng: point.lng },
                map: map,
                title: point.name,
                icon: {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    scale: 7,
                    fillColor: '#FF6B00',
                    fillOpacity: 1,
                    strokeColor: '#FFFFFF',
                    strokeWeight: 2,
                    rotation: point.lat > 0 ? 180 : 0
                },
                zIndex: 10000
            });
            
            // Info window
            marker.addListener('click', () => {
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px; max-width: 300px;">
                            <h3 style="color: #FF6B00; margin-bottom: 10px;">${point.name}</h3>
                            <div style="margin: 8px 0;">
                                <strong>Type:</strong> ${point.type}<br>
                                <strong>Location:</strong> ${point.country}<br>
                                <strong>Latitude:</strong> ${point.lat}°<br>
                                <strong>Grid Significance:</strong> 19.5° Tetrahedron Point
                            </div>
                            <div style="margin-top: 10px; padding: 10px; background: rgba(255,107,0,0.1); border-radius: 6px; font-size: 12px;">
                                This site sits on the global tetrahedron grid at 19.5° latitude - a significant 
                                geometric marker representing where a tetrahedron's vertex touches when inscribed 
                                in a sphere. Many volcanic and energetic sites occur at this latitude.
                            </div>
                        </div>
                    `
                });
                infoWindow.open(map, marker);
            });
            
            this.overlays.tetrahedron.push(marker);
        });
        
        return {
            success: true,
            pointsDisplayed: this.tetrahedronGrid.length,
            message: `Tetrahedron grid activated with ${this.tetrahedronGrid.length} sacred points at 19.5° latitude`
        };
    },
    
    clearTetrahedronGrid: function() {
        this.overlays.tetrahedron.forEach(overlay => overlay.setMap(null));
        this.overlays.tetrahedron = [];
    },
    
    // ========================================================================
    // PLATONIC SOLIDS EARTH GRID
    // ========================================================================
    
    activatePlatonicGrid: function(map) {
        console.log('🌐 Activating Platonic Solids Earth Grid...');
        
        // Clear existing
        this.clearPlatonicGrid();
        
        const vertices = this.platonicGrid.icosahedron;
        const edges = this.platonicGrid.edges;
        
        // Draw vertices
        vertices.forEach((vertex, i) => {
            const marker = new google.maps.Marker({
                position: vertex,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 5,
                    fillColor: '#9C27B0',
                    fillOpacity: 0.9,
                    strokeColor: '#FFD700',
                    strokeWeight: 2
                },
                title: `Grid Point ${i + 1}`,
                zIndex: 9000
            });
            
            this.overlays.platonic.push(marker);
        });
        
        // Draw edges
        edges.forEach(([i, j]) => {
            const line = new google.maps.Polyline({
                path: [vertices[i], vertices[j]],
                geodesic: true,
                strokeColor: '#9C27B0',
                strokeOpacity: 0.5,
                strokeWeight: 2,
                map: map
            });
            
            this.overlays.platonic.push(line);
        });
        
        return {
            success: true,
            vertices: vertices.length,
            edges: edges.length,
            message: `Platonic solids grid displayed with ${vertices.length} vertices and ${edges.length} edges`
        };
    },
    
    clearPlatonicGrid: function() {
        this.overlays.platonic.forEach(overlay => overlay.setMap(null));
        this.overlays.platonic = [];
    },
    
    // ========================================================================
    // GOLDEN RATIO & SACRED GEOMETRY
    // ========================================================================
    
    findGoldenRatioPatterns: function(sites, map) {
        console.log('🔺 Finding golden ratio patterns...');
        
        const phi = this.frequencies.goldenRatio;
        const patterns = [];
        const maxPatterns = 20;
        
        // Check distances between sites for golden ratio relationships
        for (let i = 0; i < sites.length && patterns.length < maxPatterns; i++) {
            for (let j = i + 1; j < sites.length && patterns.length < maxPatterns; j++) {
                const dist1 = this.haversineDistance(
                    sites[i].lat, sites[i].lng,
                    sites[j].lat, sites[j].lng
                );
                
                for (let k = j + 1; k < sites.length && patterns.length < maxPatterns; k++) {
                    const dist2 = this.haversineDistance(
                        sites[j].lat, sites[j].lng,
                        sites[k].lat, sites[k].lng
                    );
                    
                    const ratio = dist2 / dist1;
                    
                    // Check if ratio is close to golden ratio
                    if (Math.abs(ratio - phi) < 0.1) {
                        patterns.push({
                            sites: [sites[i], sites[j], sites[k]],
                            ratio: ratio,
                            dist1: dist1,
                            dist2: dist2,
                            confidence: (1 - Math.abs(ratio - phi)) * 100
                        });
                        
                        // Draw the pattern
                        const line = new google.maps.Polyline({
                            path: [
                                { lat: sites[i].lat, lng: sites[i].lng },
                                { lat: sites[j].lat, lng: sites[j].lng },
                                { lat: sites[k].lat, lng: sites[k].lng }
                            ],
                            geodesic: true,
                            strokeColor: '#FFD700',
                            strokeOpacity: 0.7,
                            strokeWeight: 3,
                            map: map
                        });
                        
                        this.overlays.frequency.push(line);
                    }
                }
            }
        }
        
        return patterns;
    },
    
    analyzeFibonacciDistances: function(sites) {
        const fib = [1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987, 1597];
        const matches = [];
        
        for (let i = 0; i < sites.length; i++) {
            for (let j = i + 1; j < sites.length; j++) {
                const dist = this.haversineDistance(
                    sites[i].lat, sites[i].lng,
                    sites[j].lat, sites[j].lng
                );
                
                // Check if distance (in km) is close to a Fibonacci number
                fib.forEach(f => {
                    if (Math.abs(dist - f) < 5) {
                        matches.push({
                            site1: sites[i],
                            site2: sites[j],
                            distance: dist,
                            fibonacci: f,
                            difference: Math.abs(dist - f)
                        });
                    }
                });
            }
        }
        
        return matches.sort((a, b) => a.difference - b.difference).slice(0, 50);
    },
    
    // ========================================================================
    // LEY LINES ENHANCEMENT
    // ========================================================================
    
    detectLeyLines: function(sites, threshold = 2, minSites = 3) {
        console.log(`〰️ Detecting ley lines (threshold: ${threshold}°, min sites: ${minSites})...`);
        
        const detections = [];
        
        for (let i = 0; i < sites.length; i++) {
            for (let j = i + 1; j < sites.length; j++) {
                const bearing = this.calculateBearing(
                    sites[i].lat, sites[i].lng,
                    sites[j].lat, sites[j].lng
                );
                
                const aligned = [sites[i], sites[j]];
                
                // Check which other sites align with this bearing
                sites.forEach((site, k) => {
                    if (k !== i && k !== j) {
                        const testBearing = this.calculateBearing(
                            sites[i].lat, sites[i].lng,
                            site.lat, site.lng
                        );
                        
                        const diff = Math.abs(bearing - testBearing);
                        if (diff < threshold || diff > (360 - threshold)) {
                            aligned.push(site);
                        }
                    }
                });
                
                if (aligned.length >= minSites) {
                    detections.push({
                        sites: aligned,
                        bearing: bearing,
                        count: aligned.length
                    });
                }
            }
        }
        
        // Remove duplicates and return top detections
        const unique = this.uniqueLeyLines(detections);
        return unique.sort((a, b) => b.count - a.count).slice(0, 20);
    },
    
    uniqueLeyLines: function(lines) {
        const seen = new Set();
        return lines.filter(line => {
            const key = line.sites.map(s => `${s.lat},${s.lng}`).sort().join('|');
            if (seen.has(key)) return false;
            seen.add(key);
            return true;
        });
    },
    
    // ========================================================================
    // UTILITY FUNCTIONS
    // ========================================================================
    
    haversineDistance: function(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = this.toRad(lat2 - lat1);
        const dLon = this.toRad(lon2 - lon1);
        
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                 Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) *
                 Math.sin(dLon / 2) * Math.sin(dLon / 2);
        
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    },
    
    calculateBearing: function(lat1, lon1, lat2, lon2) {
        const dLon = this.toRad(lon2 - lon1);
        const y = Math.sin(dLon) * Math.cos(this.toRad(lat2));
        const x = Math.cos(this.toRad(lat1)) * Math.sin(this.toRad(lat2)) -
                 Math.sin(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * Math.cos(dLon);
        
        let bearing = Math.atan2(y, x);
        bearing = this.toDeg(bearing);
        return (bearing + 360) % 360;
    },
    
    toRad: function(deg) {
        return deg * Math.PI / 180;
    },
    
    toDeg: function(rad) {
        return rad * 180 / Math.PI;
    },
    
    // ========================================================================
    // INTEGRATION HELPERS
    // ========================================================================
    
    initialize: function(map) {
        console.log('✅ PyramasonAdvanced module initialized');
        
        // Add to global scope for easy access
        window.PyramasonAdvanced = this;
        
        // Store map reference
        this.map = map;
        
        return {
            frequencies: this.frequencies,
            tetrahedronPoints: this.tetrahedronGrid.length,
            platonicVertices: this.platonicGrid.icosahedron.length,
            ready: true
        };
    },
    
    clearAllOverlays: function() {
        this.clearTetrahedronGrid();
        this.clearPlatonicGrid();
        this.overlays.frequency.forEach(overlay => overlay.setMap(null));
        this.overlays.frequency = [];
        this.overlays.leyLines.forEach(overlay => overlay.setMap(null));
        this.overlays.leyLines = [];
    },
    
    getStats: function() {
        return {
            activeOverlays: {
                tetrahedron: this.overlays.tetrahedron.length,
                platonic: this.overlays.platonic.length,
                frequency: this.overlays.frequency.length,
                leyLines: this.overlays.leyLines.length
            },
            frequencies: this.frequencies,
            tetrahedronPoints: this.tetrahedronGrid.length,
            platonicVertices: this.platonicGrid.icosahedron.length
        };
    }
};

// ============================================================================
// AUTO-INITIALIZATION
// ============================================================================

// Wait for map to be ready, then initialize
if (typeof google !== 'undefined' && typeof map !== 'undefined') {
    PyramasonAdvanced.initialize(map);
    console.log('🌟 Pyramason Advanced Features loaded and ready!');
} else {
    console.log('⏳ Waiting for map initialization...');
    // Will be initialized when map loads
}

// Make available globally
window.PyramasonAdvanced = PyramasonAdvanced;

console.log('📦 PyramasonAdvanced module loaded');
console.log('🎵 Frequency analysis ready');
console.log('🔷 Tetrahedron grid ready'); 
console.log('🌐 Platonic solids ready');
console.log('🔺 Sacred geometry tools ready');

    </script>
</body>
</html>