<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyramason - Professional Ancient Sites Research Platform</title>
    <meta name="description" content="Research-grade platform for 50,000+ ancient pyramids, megaliths, temples, and sacred sites worldwide with advanced analysis tools">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary-purple: #6A1B9A;
            --dark-purple: #4A148C;
            --light-purple: #9C27B0;
            --accent-gold: #FFD700;
            --dark-gold: #D4AF37;
            --cyan: #00BCD4;
            --light-cyan: #4FC3F7;
            --cosmic-bg: #1a0033;
            --panel-bg: rgba(26, 0, 51, 0.98);
            --glass-bg: rgba(106, 27, 154, 0.15);
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--cosmic-bg);
            color: #fff;
            overflow: hidden;
        }
        
        #map {
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }
        
        /* ============================================
           FIXED UI LAYOUT - NO OVERLAPPING
           ============================================ */
        
        /* Left Sidebar - Compact Design */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, rgba(26, 0, 51, 0.98) 0%, rgba(74, 20, 140, 0.95) 100%);
            backdrop-filter: blur(15px);
            border-right: 2px solid rgba(255, 215, 0, 0.3);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 4px 0 30px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }
        
        .sidebar-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .logo-container {
            margin-bottom: 15px;
        }
        
        .sidebar-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-gold);
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
            margin-bottom: 5px;
        }
        
        .sidebar-subtitle {
            font-size: 12px;
            color: var(--light-cyan);
            opacity: 0.9;
        }
        
        /* Search Section */
        .search-section {
            margin-bottom: 25px;
        }
        
        .search-box {
            display: flex;
            gap: 8px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .search-btn {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
        }
        
        .search-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.5);
        }
        
        /* Filter Sections */
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px 10px;
            border-radius: 6px;
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .filter-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .filter-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .filter-item label {
            font-size: 13px;
            cursor: pointer;
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 8px currentColor;
        }
        
        .filter-count {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        /* Right Side Controls - NO OVERLAP */
        .right-controls {
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .control-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 3px solid rgba(255, 215, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
        }
        
        .avatar-btn {
            background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
        }
        
        .tools-btn {
            background: linear-gradient(135deg, var(--primary-purple), var(--dark-purple));
        }
        
        .natal-chart-btn {
            background: linear-gradient(135deg, #E91E63, #C2185B);
        }
        
        .control-btn:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 25px rgba(255, 215, 0, 0.6);
        }
        
        /* Map Controls - Bottom Right */
        .map-controls {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .map-control-btn {
            width: 50px;
            height: 50px;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
        }
        
        .map-control-btn:hover {
            background: rgba(106, 27, 154, 0.9);
            border-color: rgba(255, 215, 0, 0.6);
            transform: scale(1.1);
        }
        
        .map-control-btn.active {
            background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
            color: var(--dark-purple);
            border-color: var(--accent-gold);
        }
        
        /* Sliding Panels - Tools & Account */
        .slide-panel {
            position: fixed;
            right: -450px;
            top: 0;
            width: 420px;
            height: 100vh;
            background: var(--panel-bg);
            backdrop-filter: blur(15px);
            border-left: 3px solid rgba(255, 215, 0, 0.4);
            z-index: 1500;
            transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            overflow-y: auto;
            padding: 25px;
            box-shadow: -5px 0 40px rgba(0, 0, 0, 0.6);
        }
        
        .slide-panel.active {
            right: 0;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .panel-title {
            font-size: 26px;
            color: var(--accent-gold);
            font-weight: 700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        
        .close-panel-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: #fff;
            font-size: 26px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-panel-btn:hover {
            background: rgba(255, 59, 48, 0.3);
            border-color: #FF3B30;
            transform: rotate(90deg);
        }
        
        /* Tool Section Styling */
        .tool-section {
            margin-bottom: 30px;
        }
        
        .tool-section-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tool-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .tool-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 215, 0, 0.5);
            transform: translateX(6px);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
        }
        
        .tool-icon {
            font-size: 28px;
            width: 36px;
            text-align: center;
        }
        
        .tool-info {
            flex: 1;
        }
        
        .tool-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 3px;
        }
        
        .tool-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Account Panel Specific */
        .profile-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .profile-picture {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.4);
        }
        
        .account-name {
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 5px;
        }
        
        .account-email {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .upload-btn {
            margin-top: 15px;
            padding: 10px 25px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }
        
        .upload-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 215, 0, 0.6);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .logout-btn {
            width: 100%;
            padding: 14px;
            background: rgba(255, 59, 48, 0.2);
            border: 2px solid rgba(255, 59, 48, 0.5);
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            font-weight: 600;
        }
        
        .logout-btn:hover {
            background: rgba(255, 59, 48, 0.4);
            border-color: rgba(255, 59, 48, 0.8);
            box-shadow: 0 4px 20px rgba(255, 59, 48, 0.4);
        }
        
        /* Natal Chart Modal */
        .natal-chart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        
        .natal-chart-overlay.active {
            display: flex;
        }
        
        .natal-chart-content {
            background: var(--panel-bg);
            border: 3px solid rgba(255, 215, 0, 0.5);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.7);
        }
        
        .chart-canvas-container {
            width: 500px;
            height: 500px;
            margin: 20px auto;
            position: relative;
        }
        
        #natalChartCanvas {
            width: 100%;
            height: 100%;
        }
        
        .zodiac-info {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .zodiac-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .zodiac-row:last-child {
            border-bottom: none;
        }
        
        .zodiac-label {
            font-weight: 600;
            color: var(--accent-gold);
        }
        
        .zodiac-value {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--panel-bg);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 12px;
            padding: 10px;
            min-width: 250px;
            z-index: 3000;
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
        }
        
        .context-menu.active {
            display: block;
        }
        
        .context-menu-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .context-menu-item:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateX(4px);
        }
        
        .context-menu-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.15);
            margin: 8px 0;
        }
        
        .coords-display {
            background: rgba(255, 215, 0, 0.15);
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .coords-display:hover {
            background: rgba(255, 215, 0, 0.25);
        }
        
        /* Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--panel-bg);
            border: 3px solid rgba(255, 215, 0, 0.5);
            border-radius: 20px;
            padding: 35px;
            max-width: 550px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.7);
            animation: modalPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .modal-icon {
            text-align: center;
            font-size: 72px;
            margin-bottom: 20px;
        }
        
        .modal-title {
            text-align: center;
            font-size: 26px;
            color: var(--accent-gold);
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .modal-message {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 30px;
            line-height: 1.8;
            font-size: 15px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .modal-btn {
            padding: 14px 35px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-btn-primary {
            background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
            color: var(--dark-purple);
        }
        
        .modal-btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
        }
        
        .modal-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Registration Modal */
        .registration-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a0033 0%, #2d1b4e 50%, #1a0033 100%);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.6s ease;
        }
        
        .registration-content {
            background: var(--panel-bg);
            border: 3px solid var(--accent-gold);
            border-radius: 20px;
            padding: 45px;
            max-width: 520px;
            width: 90%;
            box-shadow: 0 20px 80px rgba(255, 215, 0, 0.4);
            animation: slideUp 0.7s ease;
            backdrop-filter: blur(15px);
        }
        
        .registration-logo {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .registration-title {
            font-size: 36px;
            text-align: center;
            color: var(--accent-gold);
            margin-bottom: 12px;
            font-weight: 700;
            text-shadow: 0 0 25px rgba(255, 215, 0, 0.6);
        }
        
        .registration-subtitle {
            text-align: center;
            color: var(--light-cyan);
            margin-bottom: 35px;
            font-size: 15px;
        }
        
        .registration-features {
            margin: 30px 0;
            padding: 25px;
            background: var(--glass-bg);
            border-radius: 12px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
            color: rgba(255, 255, 255, 0.95);
            font-size: 14px;
        }
        
        .feature-item::before {
            content: '‚ú®';
            font-size: 20px;
        }
        
        .registration-form {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .form-group label {
            color: var(--accent-gold);
            font-size: 15px;
            font-weight: 600;
        }
        
        .form-group input {
            padding: 14px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--accent-gold);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .registration-btn {
            background: linear-gradient(135deg, var(--accent-gold), var(--dark-gold));
            color: var(--dark-purple);
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        .registration-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
        }
        
        .guest-btn {
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            padding: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
        }
        
        .guest-btn:hover {
            border-color: rgba(255, 255, 255, 0.6);
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--cosmic-bg) 0%, #2d1b4e 50%, var(--cosmic-bg) 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s;
        }
        
        .loading-pyramid {
            width: 120px;
            height: 120px;
            margin-bottom: 35px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .loading-text {
            font-size: 22px;
            color: var(--accent-gold);
            margin-bottom: 25px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        .loading-bar {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold), var(--dark-gold));
            width: 0%;
            animation: loadingProgress 3s ease forwards;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.15);
                opacity: 0.8;
            }
        }
        
        @keyframes modalPop {
            from {
                opacity: 0;
                transform: scale(0.7) rotate(-5deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }
        
        @keyframes loadingProgress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }
        
        /* Responsive Design */
        @media (max-width: 968px) {
            .sidebar {
                width: 220px;
            }
            
            .slide-panel {
                width: 100%;
                right: -100%;
            }
            
            .chart-canvas-container {
                width: 100%;
                height: auto;
                aspect-ratio: 1;
            }
        }
        
        @media (max-width: 640px) {
            .sidebar {
                width: 60px;
            }
            
            .sidebar-title,
            .sidebar-subtitle,
            .filter-title,
            .filter-item label {
                display: none;
            }
            
            .search-input {
                font-size: 0;
            }
        }
    </style>
</head>
<body>
    
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <svg class="loading-pyramid" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="pyramidGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#D4AF37;stop-opacity:1" />
                </linearGradient>
                <filter id="glow">
                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                    <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
            </defs>
            <path d="M 50 10 L 85 75 L 15 75 Z" fill="url(#pyramidGrad)" opacity="0.95" filter="url(#glow)"/>
            <path d="M 50 10 L 85 75 L 50 55 Z" fill="#D4AF37" opacity="0.7"/>
            <path d="M 50 10 L 15 75 L 50 55 Z" fill="#FFD700" opacity="0.6"/>
            <circle cx="50" cy="48" r="14" fill="rgba(26, 0, 51, 0.9)"/>
            <circle cx="50" cy="48" r="8" fill="#00BCD4" opacity="0.9"/>
            <circle cx="52" cy="46" r="3" fill="#fff"/>
            <line x1="50" y1="10" x2="50" y2="0" stroke="#FFD700" stroke-width="2" opacity="0.6"/>
            <line x1="50" y1="10" x2="38" y2="4" stroke="#FFD700" stroke-width="1.5" opacity="0.4"/>
            <line x1="50" y1="10" x2="62" y2="4" stroke="#FFD700" stroke-width="1.5" opacity="0.4"/>
        </svg>
        <div class="loading-text" id="loadingProgress">Initializing ancient wisdom...</div>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
    </div>
    
    <!-- Registration Modal -->
    <div class="registration-modal" id="registrationModal">
        <div class="registration-content">
            <div class="registration-logo">
                <svg style="width:100px;height:100px" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="regPyramidGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#D4AF37;stop-opacity:1" />
                        </linearGradient>
                        <filter id="regGlow">
                            <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <path d="M 50 15 L 85 75 L 15 75 Z" fill="url(#regPyramidGrad)" opacity="0.95" filter="url(#regGlow)"/>
                    <path d="M 50 15 L 85 75 L 50 55 Z" fill="#D4AF37" opacity="0.7"/>
                    <path d="M 50 15 L 15 75 L 50 55 Z" fill="#FFD700" opacity="0.6"/>
                    <circle cx="50" cy="48" r="14" fill="rgba(26, 0, 51, 0.9)"/>
                    <circle cx="50" cy="48" r="8" fill="#00BCD4" opacity="0.9"/>
                    <circle cx="52" cy="46" r="3" fill="#fff"/>
                    <line x1="50" y1="15" x2="50" y2="5" stroke="#FFD700" stroke-width="2" opacity="0.6"/>
                    <line x1="50" y1="15" x2="40" y2="10" stroke="#FFD700" stroke-width="1.5" opacity="0.4"/>
                    <line x1="50" y1="15" x2="60" y2="10" stroke="#FFD700" stroke-width="1.5" opacity="0.4"/>
                </svg>
            </div>
            <h1 class="registration-title">PYRAMASON</h1>
            <p class="registration-subtitle">Professional Ancient Mysteries Research Platform</p>
            
            <div class="registration-features">
                <div class="feature-item">Explore 50,000+ ancient sites worldwide</div>
                <div class="feature-item">Advanced sacred geometry analysis</div>
                <div class="feature-item">Astronomical alignment detection</div>
                <div class="feature-item">Live natal chart with zodiac positions</div>
                <div class="feature-item">Professional measurement tools</div>
                <div class="feature-item">Academic citation generator</div>
                <div class="feature-item">Export to CSV, GeoJSON, KML</div>
            </div>
            
            <form class="registration-form" id="registrationForm" onsubmit="handleRegistration(event)">
                <div class="form-group">
                    <label for="regName">Your Name</label>
                    <input type="text" id="regName" required placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label for="regEmail">Email Address</label>
                    <input type="email" id="regEmail" required placeholder="your.email@example.com">
                </div>
                <button type="submit" class="registration-btn">üîì Start Exploring</button>
                <button type="button" class="guest-btn" onclick="continueAsGuest()">Continue as Guest</button>
            </form>
        </div>
    </div>
    
    <!-- Map Container -->
    <div id="map"></div>
    
    <!-- Left Sidebar - Filters -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo-container">
                <svg style="width:50px;height:50px" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="smallPyramidGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#D4AF37;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path d="M 50 20 L 80 70 L 20 70 Z" fill="url(#smallPyramidGrad)" opacity="0.9"/>
                    <path d="M 50 20 L 80 70 L 50 50 Z" fill="#D4AF37" opacity="0.7"/>
                    <path d="M 50 20 L 20 70 L 50 50 Z" fill="#FFD700" opacity="0.5"/>
                    <circle cx="50" cy="48" r="10" fill="rgba(26, 0, 51, 0.8)"/>
                    <circle cx="50" cy="48" r="5" fill="#00BCD4"/>
                </svg>
            </div>
            <div class="sidebar-title">PYRAMASON</div>
            <div class="sidebar-subtitle">Ancient Sites Map</div>
        </div>
        
        <!-- Search -->
        <div class="search-section">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="Search sites...">
                <button class="search-btn" onclick="searchSite()">üîç</button>
            </div>
        </div>
        
        <!-- Pyramids Filter -->
        <div class="filter-section">
            <div class="filter-title">üî∫ PYRAMIDS</div>
            <div class="filter-item">
                <input type="checkbox" id="layer-pyramids" checked onchange="applyFilters()">
                <label for="layer-pyramids">
                    <span class="legend-dot" style="background: #FFD700;"></span>
                    Show All <span class="filter-count" id="count-pyramids">(0)</span>
                </label>
            </div>
        </div>
        
        <!-- Megalithic Sites -->
        <div class="filter-section">
            <div class="filter-title">üóø MEGALITHS</div>
            <div class="filter-item">
                <input type="checkbox" id="layer-standing-stones" onchange="toggleMegaliths('standing-stones')">
                <label for="layer-standing-stones">
                    <span class="legend-dot" style="background: #4FC3F7;"></span>
                    Standing Stones <span class="filter-count" id="count-standing-stones">(0)</span>
                </label>
            </div>
            <div class="filter-item">
                <input type="checkbox" id="layer-burials" onchange="toggleMegaliths('burials')">
                <label for="layer-burials">
                    <span class="legend-dot" style="background: #9C27B0;"></span>
                    Burials <span class="filter-count" id="count-burials">(0)</span>
                </label>
            </div>
            <div class="filter-item">
                <input type="checkbox" id="layer-rock-art" onchange="toggleMegaliths('rock-art')">
                <label for="layer-rock-art">
                    <span class="legend-dot" style="background: #E91E63;"></span>
                    Rock Art <span class="filter-count" id="count-rock-art">(0)</span>
                </label>
            </div>
            <div class="filter-item">
                <input type="checkbox" id="layer-settlements" onchange="toggleMegaliths('settlements')">
                <label for="layer-settlements">
                    <span class="legend-dot" style="background: #673AB7;"></span>
                    Settlements <span class="filter-count" id="count-settlements">(0)</span>
                </label>
            </div>
        </div>
        
        <!-- Sacred Geometry -->
        <div class="filter-section">
            <div class="filter-title">‚ú® GEOMETRY</div>
            <div class="filter-item">
                <input type="checkbox" id="sacred-triangles" onchange="detectSacredGeometry('triangles')">
                <label for="sacred-triangles">
                    <span class="legend-dot" style="background: #FFD700;"></span>
                    Triangles
                </label>
            </div>
            <div class="filter-item">
                <input type="checkbox" id="sacred-circles" onchange="detectSacredGeometry('circles')">
                <label for="sacred-circles">
                    <span class="legend-dot" style="background: #00BCD4;"></span>
                    Circles
                </label>
            </div>
            <div class="filter-item">
                <input type="checkbox" id="sacred-alignments" onchange="detectSacredGeometry('alignments')">
                <label for="sacred-alignments">
                    <span class="legend-dot" style="background: #4CAF50;"></span>
                    Alignments
                </label>
            </div>
        </div>
    </div>
    
    <!-- Right Side Controls -->
    <div class="right-controls">
        <button class="control-btn avatar-btn" onclick="toggleAccountPanel()" title="Your Account">üë§</button>
        <button class="control-btn tools-btn" onclick="toggleToolsPanel()" title="Research Tools">üõ†Ô∏è</button>
        <button class="control-btn natal-chart-btn" onclick="openNatalChart()" title="Natal Chart">‚ôà</button>
    </div>
    
    <!-- Map Controls (Bottom Right) -->
    <div class="map-controls">
        <button class="map-control-btn" onclick="toggleMapType()" title="Toggle Satellite/Map">üõ∞Ô∏è</button>
        <button class="map-control-btn active" id="labelsBtn" onclick="toggleLabels()" title="Toggle Labels">üè∑Ô∏è</button>
        <button class="map-control-btn" id="3dBtn" onclick="toggle3D()" title="Toggle 3D Terrain">üèîÔ∏è</button>
        <button class="map-control-btn" onclick="clearAllDrawings()" title="Clear All Drawings">üóëÔ∏è</button>
    </div>
    
    <!-- Tools Panel -->
    <div class="slide-panel" id="toolsPanel">
        <div class="panel-header">
            <h2 class="panel-title">üîß Research Tools</h2>
            <button class="close-panel-btn" onclick="toggleToolsPanel()">√ó</button>
        </div>
        
        <!-- Sacred Geometry Tools -->
        <div class="tool-section">
            <div class="tool-section-title">‚ú® Sacred Geometry Analysis</div>
            <button class="tool-btn" onclick="analyzeSacredGeometry('golden-ratio')">
                <span class="tool-icon">œÜ</span>
                <div class="tool-info">
                    <div class="tool-name">Golden Ratio Detector</div>
                    <div class="tool-desc">Find œÜ (1.618) relationships between sites</div>
                </div>
            </button>
            <button class="tool-btn" onclick="analyzeSacredGeometry('fibonacci')">
                <span class="tool-icon">üåÄ</span>
                <div class="tool-info">
                    <div class="tool-name">Fibonacci Spiral</div>
                    <div class="tool-desc">Sacred spiral patterns overlay</div>
                </div>
            </button>
            <button class="tool-btn" onclick="analyzeSacredGeometry('vesica-piscis')">
                <span class="tool-icon">‚óØ‚óØ</span>
                <div class="tool-info">
                    <div class="tool-name">Vesica Piscis Finder</div>
                    <div class="tool-desc">Sacred geometry circle intersections</div>
                </div>
            </button>
            <button class="tool-btn" onclick="analyzeSacredGeometry('flower-of-life')">
                <span class="tool-icon">‚úø</span>
                <div class="tool-info">
                    <div class="tool-name">Flower of Life</div>
                    <div class="tool-desc">Ancient geometric pattern detection</div>
                </div>
            </button>
            <button class="tool-btn" onclick="analyzeSacredGeometry('platonic-solids')">
                <span class="tool-icon">‚¨¢</span>
                <div class="tool-info">
                    <div class="tool-name">Platonic Solids Grid</div>
                    <div class="tool-desc">Earth grid systems (dodecahedron/icosahedron)</div>
                </div>
            </button>
            <button class="tool-btn" onclick="analyzeSacredGeometry('metatron')">
                <span class="tool-icon">üîØ</span>
                <div class="tool-info">
                    <div class="tool-name">Metatron's Cube</div>
                    <div class="tool-desc">Sacred geometry visualization</div>
                </div>
            </button>
        </div>
        
        <!-- Astronomical Analysis -->
        <div class="tool-section">
            <div class="tool-section-title">üåü Astronomical Analysis</div>
            <button class="tool-btn" onclick="analyzeAstronomy('solstice')">
                <span class="tool-icon">‚òÄÔ∏è</span>
                <div class="tool-info">
                    <div class="tool-name">Solstice Alignments</div>
                    <div class="tool-desc">Summer/winter sunrise detection</div>
                </div>
            </button>
            <button class="tool-btn" onclick="analyzeAstronomy('equinox')">
                <span class="tool-icon">‚öñÔ∏è</span>
                <div class="tool-info">
                    <div class="tool-name">Equinox Alignments</div>
                    <div class="tool-desc">Spring/autumn balance points</div>
                </div>
            </button>
            <button class="tool-btn" onclick="analyzeAstronomy('stars')">
                <span class="tool-icon">‚≠ê</span>
                <div class="tool-info">
                    <div class="tool-name">Star Alignments</div>
                    <div class="tool-desc">Orion, Sirius, Pleiades correlations</div>
                </div>
            </button>
            <button class="tool-btn" onclick="analyzeAstronomy('precession')">
                <span class="tool-icon">üåå</span>
                <div class="tool-info">
                    <div class="tool-name">Precession Calculator</div>
                    <div class="tool-desc">Precession of equinoxes analysis</div>
                </div>
            </button>
        </div>
        
        <!-- Measurement Tools -->
        <div class="tool-section">
            <div class="tool-section-title">üìè Measurement Tools</div>
            <button class="tool-btn" onclick="startMeasurement('distance')">
                <span class="tool-icon">‚ÜîÔ∏è</span>
                <div class="tool-info">
                    <div class="tool-name">Distance Calculator</div>
                    <div class="tool-desc">Measure between any two points</div>
                </div>
            </button>
            <button class="tool-btn" onclick="startMeasurement('area')">
                <span class="tool-icon">‚ñ≠</span>
                <div class="tool-info">
                    <div class="tool-name">Area Calculator</div>
                    <div class="tool-desc">Polygon area measurement</div>
                </div>
            </button>
            <button class="tool-btn" onclick="startMeasurement('bearing')">
                <span class="tool-icon">üß≠</span>
                <div class="tool-info">
                    <div class="tool-name">Bearing/Azimuth</div>
                    <div class="tool-desc">Directional heading calculator</div>
                </div>
            </button>
            <button class="tool-btn" onclick="findAntipode()">
                <span class="tool-icon">üåç</span>
                <div class="tool-info">
                    <div class="tool-name">Antipode Calculator</div>
                    <div class="tool-desc">Find opposite point on Earth</div>
                </div>
            </button>
            <button class="tool-btn" onclick="distanceRings()">
                <span class="tool-icon">‚≠ï</span>
                <div class="tool-info">
                    <div class="tool-name">Distance Rings</div>
                    <div class="tool-desc">Draw concentric circles from any point</div>
                </div>
            </button>
        </div>
        
        <!-- Drawing Tools -->
        <div class="tool-section">
            <div class="tool-section-title">‚úèÔ∏è Drawing & Visualization</div>
            <button class="tool-btn" onclick="startDrawing('line')">
                <span class="tool-icon">üìê</span>
                <div class="tool-info">
                    <div class="tool-name">Draw Line</div>
                    <div class="tool-desc">Connect any two points</div>
                </div>
            </button>
            <button class="tool-btn" onclick="startDrawing('circle')">
                <span class="tool-icon">‚≠ï</span>
                <div class="tool-info">
                    <div class="tool-name">Draw Circle</div>
                    <div class="tool-desc">Circular regions and radius visualization</div>
                </div>
            </button>
            <button class="tool-btn" onclick="startDrawing('polygon')">
                <span class="tool-icon">‚ñ±</span>
                <div class="tool-info">
                    <div class="tool-name">Draw Polygon</div>
                    <div class="tool-desc">Custom shapes and boundaries</div>
                </div>
            </button>
            <button class="tool-btn" onclick="toggleHeatmap()">
                <span class="tool-icon">üî•</span>
                <div class="tool-info">
                    <div class="tool-name">Heatmap Mode</div>
                    <div class="tool-desc">Density visualization of ancient sites</div>
                </div>
            </button>
        </div>
        
        <!-- Earth Grid & Ley Lines -->
        <div class="tool-section">
            <div class="tool-section-title">üåê Earth Grid & Energy</div>
            <button class="tool-btn" onclick="showEarthGrid()">
                <span class="tool-icon">üï∏Ô∏è</span>
                <div class="tool-info">
                    <div class="tool-name">Earth Grid Overlay</div>
                    <div class="tool-desc">Ley lines and vortex points</div>
                </div>
            </button>
            <button class="tool-btn" onclick="detectLeyLines()">
                <span class="tool-icon">üì°</span>
                <div class="tool-info">
                    <div class="tool-name">Ley Line Detector</div>
                    <div class="tool-desc">Find alignments between ancient sites</div>
                </div>
            </button>
            <button class="tool-btn" onclick="playFrequency()">
                <span class="tool-icon">üîä</span>
                <div class="tool-info">
                    <div class="tool-name">Sacred Audio Frequencies</div>
                    <div class="tool-desc">Play site-specific sound frequencies</div>
                </div>
            </button>
        </div>
        
        <!-- Export & Academic Tools -->
        <div class="tool-section">
            <div class="tool-section-title">üìö Academic & Export</div>
            <button class="tool-btn" onclick="generateCitation()">
                <span class="tool-icon">üìù</span>
                <div class="tool-info">
                    <div class="tool-name">Citation Generator</div>
                    <div class="tool-desc">APA, MLA, Chicago, Harvard formats</div>
                </div>
            </button>
            <button class="tool-btn" onclick="exportData('csv')">
                <span class="tool-icon">üìä</span>
                <div class="tool-info">
                    <div class="tool-name">Export CSV</div>
                    <div class="tool-desc">Spreadsheet format for analysis</div>
                </div>
            </button>
            <button class="tool-btn" onclick="exportData('geojson')">
                <span class="tool-icon">üó∫Ô∏è</span>
                <div class="tool-info">
                    <div class="tool-name">Export GeoJSON</div>
                    <div class="tool-desc">GIS standard format</div>
                </div>
            </button>
            <button class="tool-btn" onclick="exportData('kml')">
                <span class="tool-icon">üìÅ</span>
                <div class="tool-info">
                    <div class="tool-name">Export KML</div>
                    <div class="tool-desc">Google Earth compatible format</div>
                </div>
            </button>
            <button class="tool-btn" onclick="generateReport()">
                <span class="tool-icon">üìÑ</span>
                <div class="tool-info">
                    <div class="tool-name">Generate PDF Report</div>
                    <div class="tool-desc">Comprehensive research document</div>
                </div>
            </button>
        </div>
        
        <!-- Advanced Research -->
        <div class="tool-section">
            <div class="tool-section-title">üéì Advanced Research</div>
            <button class="tool-btn" onclick="batchAnalyzer()">
                <span class="tool-icon">üìä</span>
                <div class="tool-info">
                    <div class="tool-name">Batch Analyzer</div>
                    <div class="tool-desc">Analyze multiple sites simultaneously</div>
                </div>
            </button>
            <button class="tool-btn" onclick="comparisonTool()">
                <span class="tool-icon">‚öñÔ∏è</span>
                <div class="tool-info">
                    <div class="tool-name">Site Comparison</div>
                    <div class="tool-desc">Side-by-side analysis tool</div>
                </div>
            </button>
            <button class="tool-btn" onclick="statisticsDashboard()">
                <span class="tool-icon">üìà</span>
                <div class="tool-info">
                    <div class="tool-name">Statistics Dashboard</div>
                    <div class="tool-desc">Global patterns and density maps</div>
                </div>
            </button>
            <button class="tool-btn" onclick="routePlanner()">
                <span class="tool-icon">üõ§Ô∏è</span>
                <div class="tool-info">
                    <div class="tool-name">Route Planner</div>
                    <div class="tool-desc">Create ancient pilgrimage routes</div>
                </div>
            </button>
            <button class="tool-btn" onclick="timelineSlider()">
                <span class="tool-icon">‚è≥</span>
                <div class="tool-info">
                    <div class="tool-name">Timeline Slider</div>
                    <div class="tool-desc">Filter by period (10,000 BCE - Present)</div>
                </div>
            </button>
        </div>
    </div>
    
    <!-- Account Panel -->
    <div class="slide-panel" id="accountPanel">
        <div class="panel-header">
            <h2 class="panel-title">üë§ Your Account</h2>
            <button class="close-panel-btn" onclick="toggleAccountPanel()">√ó</button>
        </div>
        
        <div class="profile-section">
            <div class="profile-picture" id="profilePicture">üë§</div>
            <div class="account-name" id="accountName">Guest User</div>
            <div class="account-email" id="accountEmail">guest@pyramason.com</div>
            <button class="upload-btn" onclick="uploadProfilePicture()">Upload Photo</button>
            <input type="file" id="profilePictureInput" accept="image/*" style="display:none" onchange="handleProfilePictureUpload(event)">
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="accountFavCount">0</div>
                <div class="stat-label">Favorites</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="accountDiscoveries">0</div>
                <div class="stat-label">Discoveries</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="accountExplored">0</div>
                <div class="stat-label">Sites Explored</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="memberSince">Today</div>
                <div class="stat-label">Member Since</div>
            </div>
        </div>
        
        <div class="tool-section">
            <div class="tool-section-title">‚≠ê Premium Features</div>
            <button class="tool-btn" onclick="showPremiumInfo()">
                <span class="tool-icon">üíé</span>
                <div class="tool-info">
                    <div class="tool-name">Upgrade to Premium</div>
                    <div class="tool-desc">Unlock unlimited exports & AI analysis</div>
                </div>
            </button>
        </div>
        
        <button class="logout-btn" onclick="handleLogout()">üö™ Logout</button>
    </div>
    
    <!-- Natal Chart Overlay -->
    <div class="natal-chart-overlay" id="natalChartOverlay">
        <div class="natal-chart-content">
            <div class="panel-header">
                <h2 class="panel-title">‚ôà Live Natal Chart</h2>
                <button class="close-panel-btn" onclick="closeNatalChart()">√ó</button>
            </div>
            
            <div class="chart-canvas-container">
                <canvas id="natalChartCanvas"></canvas>
            </div>
            
            <div class="zodiac-info" id="zodiacInfo">
                <!-- Zodiac positions will be dynamically inserted here -->
            </div>
        </div>
    </div>
    
    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="coords-display" id="contextCoords" onclick="copyCoordinates()" title="Click to copy">
            Loading coordinates...
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="addCustomMarker()">
            üìç Add Custom Marker
        </div>
        <div class="context-menu-item" onclick="startMeasurement('distance')">
            üìè Measure Distance
        </div>
        <div class="context-menu-item" onclick="startMeasurement('area')">
            ‚ñ≠ Calculate Area
        </div>
        <div class="context-menu-item" onclick="startMeasurement('bearing')">
            üß≠ Calculate Bearing
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="findAntipodeFromContext()">
            üåç Find Antipode
        </div>
        <div class="context-menu-item" onclick="detectGeometryAt()">
            ‚ú® Detect Sacred Geometry
        </div>
        <div class="context-menu-item" onclick="checkAstronomicalAlignment()">
            ‚≠ê Check Astronomical Alignment
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="startDrawing('line')">
            üìê Draw Line
        </div>
        <div class="context-menu-item" onclick="startDrawing('circle')">
            ‚≠ï Draw Circle
        </div>
        <div class="context-menu-item" onclick="startDrawing('polygon')">
            ‚ñ± Draw Polygon
        </div>
    </div>
    
    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay" onclick="if(event.target === this) closeModal()">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">‚ÑπÔ∏è</div>
            <div class="modal-title" id="modalTitle">Information</div>
            <div class="modal-message" id="modalMessage">This is a message</div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" id="modalPrimaryBtn">OK</button>
                <button class="modal-btn modal-btn-secondary" id="modalSecondaryBtn" style="display:none;">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        // ==================================================================
        // CONFIGURATION & INITIALIZATION
        // ==================================================================
        
        const CONFIG = {
            // Google Maps API Key
            GOOGLE_MAPS_API_KEY: 'AIzaSyB16lIKUClrBSHvAJZLq584GG4vZUaa3HQ',
            
            // Data URLs from Shopify CDN
            PYRAMIDS_DATA_URL: 'https://cdn.shopify.com/s/files/1/0853/8701/8573/files/pyramids_data.json?v=1762027215',
            MEGALITHS_STANDING_STONES_URL: 'https://cdn.shopify.com/s/files/1/0853/8701/8573/files/megalithic_sites_standing_stones_and_circles.json?v=1762347327',
            MEGALITHS_BURIALS_URL: 'https://cdn.shopify.com/s/files/1/0853/8701/8573/files/megalithic_sites_burials_and_tombs.json?v=1762348072',
            MEGALITHS_ROCK_ART_URL: 'https://cdn.shopify.com/s/files/1/0853/8701/8573/files/megalithic_sites_rock_art_and_carvings.json?v=1762347285',
            MEGALITHS_SETTLEMENTS_URL: 'https://cdn.shopify.com/s/files/1/0853/8701/8573/files/megalithic_sites_settlements_and_other.json?v=1762347305',
            
            // Supabase Configuration
            SUPABASE_URL: 'https://hrfmssliipurbyxivanc.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhyZm1zc2xpaXB1cmJ5eGl2YW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzgxNTIsImV4cCI6MjA3ODAxNDE1Mn0.DB9vrjGYYtkCgnSm25sn1y_7Yr3YJTkuayWlp1_s4io',
            
            // Map Settings
            DEFAULT_CENTER: { lat: 29.9792, lng: 31.1342 }, // Great Pyramid of Giza
            DEFAULT_ZOOM: 3,
            
            // Feature Flags
            ENABLE_SUPABASE: true,
            ENABLE_COMMUNITY_SUBMISSIONS: true,
            ENABLE_FAVORITES_SYNC: true,
            
            // Performance Settings
            MARKER_BATCH_SIZE: 100,
            CLUSTER_RADIUS: 120
        };
        
        // Global Variables
        let map, infoWindow, geocoder, markerCluster;
        let markers = [];
        let drawings = [];
        let favorites = [];
        let currentUser = null;
        let contextMenuLatLng = null;
        let measurementMode = null;
        let measurementPoints = [];
        let measurementPolyline = null;
        let currentMapType = 'roadmap';
        let labelsEnabled = true;
        let terrain3D = false;
        let heatmapLayer = null;
        let earthGridLayer = null;
        
        // Data Storage
        let pyramidData = [];
        let megalithData = {
            'standing-stones': [],
            'burials': [],
            'rock-art': [],
            'settlements': []
        };
        let megalithsLoaded = {
            'standing-stones': false,
            'burials': false,
            'rock-art': false,
            'settlements': false
        };
        
        // Sacred Geometry Overlays
        let geometryOverlays = [];
        
        // ==================================================================
        // AUTHENTICATION & USER MANAGEMENT
        // ==================================================================
        
        function checkRegistration() {
            const stored = localStorage.getItem('pyramason_user');
            if (stored) {
                currentUser = JSON.parse(stored);
                document.getElementById('registrationModal').style.display = 'none';
                updateUserInterface();
            }
        }
        
        function handleRegistration(event) {
            event.preventDefault();
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            
            currentUser = {
                id: generateUUID(),
                name,
                email,
                registered: new Date().toISOString(),
                guest: false,
                profilePicture: null,
                stats: {
                    discoveries: 0,
                    explored: 0,
                    favorites: 0
                }
            };
            
            localStorage.setItem('pyramason_user', JSON.stringify(currentUser));
            document.getElementById('registrationModal').style.display = 'none';
            
            updateUserInterface();
            showModal('‚ú®', 'Welcome to Pyramason!', 
                `Hello ${name}! Your account has been created. You now have access to all research tools.`);
        }
        
        function continueAsGuest() {
            currentUser = {
                id: 'guest',
                name: 'Guest User',
                email: 'guest@pyramason.com',
                registered: new Date().toISOString(),
                guest: true,
                stats: {
                    discoveries: 0,
                    explored: 0,
                    favorites: 0
                }
            };
            
            localStorage.setItem('pyramason_user', JSON.stringify(currentUser));
            document.getElementById('registrationModal').style.display = 'none';
            updateUserInterface();
        }
        
        function updateUserInterface() {
            if (currentUser) {
                document.getElementById('accountName').textContent = currentUser.name;
                document.getElementById('accountEmail').textContent = currentUser.email;
                document.getElementById('accountFavCount').textContent = currentUser.stats.favorites || 0;
                document.getElementById('accountDiscoveries').textContent = currentUser.stats.discoveries || 0;
                document.getElementById('accountExplored').textContent = currentUser.stats.explored || 0;
                
                const regDate = new Date(currentUser.registered);
                document.getElementById('memberSince').textContent = regDate.toLocaleDateString();
            }
        }
        
        function handleLogout() {
            showModal('üëã', 'Logout', 
                'Are you sure you want to logout?',
                'Logout',
                'Cancel',
                () => {
                    localStorage.removeItem('pyramason_user');
                    location.reload();
                });
        }
        
        function uploadProfilePicture() {
            document.getElementById('profilePictureInput').click();
        }
        
        function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = e.target.result;
                    document.getElementById('profilePicture').innerHTML = `<img src="${img}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                    
                    if (currentUser) {
                        currentUser.profilePicture = img;
                        localStorage.setItem('pyramason_user', JSON.stringify(currentUser));
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // ==================================================================
        // GOOGLE MAPS INITIALIZATION
        // ==================================================================
        
        function initMap() {
            // Initialize map with dark cosmic theme
            map = new google.maps.Map(document.getElementById('map'), {
                center: CONFIG.DEFAULT_CENTER,
                zoom: CONFIG.DEFAULT_ZOOM,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                styles: [
                    {
                        featureType: 'water',
                        elementType: 'geometry',
                        stylers: [{ color: '#0e1626' }]
                    },
                    {
                        featureType: 'landscape',
                        elementType: 'geometry',
                        stylers: [{ color: '#1a1a2e' }]
                    },
                    {
                        featureType: 'road',
                        elementType: 'geometry',
                        stylers: [{ visibility: 'simplified' }, { color: '#2d2d44' }]
                    },
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ],
                disableDefaultUI: true,
                zoomControl: false,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });
            
            infoWindow = new google.maps.InfoWindow();
            geocoder = new google.maps.Geocoder();
            
            // Setup context menu
            setupContextMenu();
            
            // Load data
            loadAllData();
            
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
            }, 2000);
        }
        
        // ==================================================================
        // DATA LOADING
        // ==================================================================
        
        async function loadAllData() {
            updateLoadingText('Loading pyramid data...');
            
            try {
                console.log('Fetching pyramid data from:', CONFIG.PYRAMIDS_DATA_URL);
                
                // Load pyramid data with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const pyramidResponse = await fetch(CONFIG.PYRAMIDS_DATA_URL, {
                    signal: controller.signal,
                    mode: 'cors'
                });
                clearTimeout(timeoutId);
                
                console.log('Pyramid response status:', pyramidResponse.status);
                
                if (!pyramidResponse.ok) {
                    throw new Error(`HTTP error! status: ${pyramidResponse.status}`);
                }
                
                const data = await pyramidResponse.json();
                console.log('Pyramid data received:', data);
                
                // Validate data is an array
                if (!Array.isArray(data)) {
                    console.error('Data is not an array:', typeof data);
                    throw new Error('Invalid data format - expected array');
                }
                
                pyramidData = data;
                
                console.log(`Successfully loaded ${pyramidData.length} pyramids`);
                updateLoadingText(`Loaded ${pyramidData.length} pyramids...`);
                
                // Display pyramids
                displayPyramids();
                
                // Update count
                document.getElementById('count-pyramids').textContent = `(${pyramidData.length})`;
                
                updateLoadingText('Ready!');
                
            } catch (error) {
                console.error('Error loading data:', error);
                
                // Use demo data as fallback
                console.log('Using demo/fallback data');
                useDemoData();
                
                showModal('‚ö†Ô∏è', 'Data Loading Issue', 
                    `Could not load data from server (${error.message}). Using demo data instead. ` +
                    `<br><br><small>Check console for details. Possible causes: CORS, network, or invalid URL.</small>`);
            }
        }
        
        function useDemoData() {
            // Fallback demo data for testing
            pyramidData = [
                { name: 'Great Pyramid of Giza', lat: 29.9792, lng: 31.1342, location: 'Egypt' },
                { name: 'Pyramid of Khafre', lat: 29.9753, lng: 31.1308, location: 'Egypt' },
                { name: 'Pyramid of Menkaure', lat: 29.9722, lng: 31.1285, location: 'Egypt' },
                { name: 'Red Pyramid', lat: 29.8089, lng: 31.2060, location: 'Dahshur, Egypt' },
                { name: 'Bent Pyramid', lat: 29.7904, lng: 31.2096, location: 'Dahshur, Egypt' },
                { name: 'Step Pyramid of Djoser', lat: 29.8717, lng: 31.2163, location: 'Saqqara, Egypt' },
                { name: 'Pyramid of the Sun', lat: 19.6925, lng: -98.8438, location: 'Teotihuacan, Mexico' },
                { name: 'Pyramid of the Moon', lat: 19.6950, lng: -98.8437, location: 'Teotihuacan, Mexico' },
                { name: 'El Castillo', lat: 20.6843, lng: -88.5678, location: 'Chichen Itza, Mexico' },
                { name: 'Pyramid of Cestius', lat: 41.8759, lng: 12.4809, location: 'Rome, Italy' },
                { name: 'Nubian Pyramids', lat: 16.9205, lng: 33.7483, location: 'Meroe, Sudan' },
                { name: 'Pyramid of Cestius', lat: 41.8759, lng: 12.4809, location: 'Rome, Italy' },
                { name: 'Louvre Pyramid', lat: 48.8606, lng: 2.3376, location: 'Paris, France' },
                { name: 'Luxor Hotel Pyramid', lat: 36.0955, lng: -115.1761, location: 'Las Vegas, USA' },
                { name: 'Memphis Pyramid', lat: 35.1564, lng: -90.0501, location: 'Memphis, Tennessee' }
            ];
            
            console.log('Demo data loaded:', pyramidData.length, 'sites');
            updateLoadingText(`Loaded ${pyramidData.length} demo pyramids...`);
            
            // Display demo pyramids
            displayPyramids();
            
            // Update count
            document.getElementById('count-pyramids').textContent = `(${pyramidData.length})`;
            
            updateLoadingText('Demo mode ready!');
        }
        
        function updateLoadingText(text) {
            const loadingText = document.getElementById('loadingProgress');
            if (loadingText) {
                loadingText.textContent = text;
            }
        }
        
        // ==================================================================
        // MARKER DISPLAY FUNCTIONS
        // ==================================================================
        
        function displayPyramids() {
            console.log('displayPyramids called, pyramidData:', pyramidData);
            
            // Validate pyramidData
            if (!pyramidData || !Array.isArray(pyramidData)) {
                console.error('pyramidData is not a valid array:', pyramidData);
                showModal('‚ö†Ô∏è', 'Display Error', 'Cannot display pyramids - invalid data format.');
                return;
            }
            
            if (pyramidData.length === 0) {
                console.warn('pyramidData is empty');
                showModal('‚ÑπÔ∏è', 'No Data', 'No pyramid data available to display.');
                return;
            }
            
            // Clear existing markers if any
            clearMarkers();
            
            let successfulMarkers = 0;
            
            // Create markers for pyramids
            pyramidData.forEach((pyramid, index) => {
                if (!pyramid.lat || !pyramid.lng) {
                    console.warn(`Pyramid ${index} missing coordinates:`, pyramid);
                    return;
                }
                
                try {
                    const marker = new google.maps.Marker({
                        position: { lat: parseFloat(pyramid.lat), lng: parseFloat(pyramid.lng) },
                        map: document.getElementById('layer-pyramids').checked ? map : null,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: '#FFD700',
                            fillOpacity: 0.9,
                            strokeColor: '#fff',
                            strokeWeight: 2
                        },
                        title: pyramid.name || 'Pyramid',
                        zIndex: 100
                    });
                    
                    // Add click listener
                    marker.addListener('click', () => {
                        showSiteInfo(pyramid, 'pyramid');
                    });
                    
                    markers.push({ marker, type: 'pyramid', data: pyramid });
                    successfulMarkers++;
                } catch (markerError) {
                    console.error(`Error creating marker for pyramid ${index}:`, markerError);
                }
            });
            
            console.log(`Successfully created ${successfulMarkers} pyramid markers`);
            
            // Add clustering for performance
            if (window.markerClusterer && window.markerClusterer.MarkerClusterer) {
                try {
                    const clustererMarkers = markers.filter(m => m.type === 'pyramid').map(m => m.marker);
                    markerCluster = new markerClusterer.MarkerClusterer({
                        map,
                        markers: clustererMarkers,
                        algorithm: new markerClusterer.GridAlgorithm({ gridSize: CONFIG.CLUSTER_RADIUS })
                    });
                    console.log('Marker clustering enabled');
                } catch (clusterError) {
                    console.warn('Clustering failed, markers still visible:', clusterError);
                }
            }
        }
        
        async function toggleMegaliths(type) {
            const checkbox = document.getElementById(`layer-${type}`);
            
            if (checkbox.checked && !megalithsLoaded[type]) {
                updateLoadingText(`Loading ${type}...`);
                
                try {
                    let url;
                    switch(type) {
                        case 'standing-stones':
                            url = CONFIG.MEGALITHS_STANDING_STONES_URL;
                            break;
                        case 'burials':
                            url = CONFIG.MEGALITHS_BURIALS_URL;
                            break;
                        case 'rock-art':
                            url = CONFIG.MEGALITHS_ROCK_ART_URL;
                            break;
                        case 'settlements':
                            url = CONFIG.MEGALITHS_SETTLEMENTS_URL;
                            break;
                    }
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    megalithData[type] = data;
                    megalithsLoaded[type] = true;
                    
                    // Update count
                    document.getElementById(`count-${type}`).textContent = `(${data.length})`;
                    
                    // Display markers
                    displayMegalithic(type);
                    
                } catch (error) {
                    console.error(`Error loading ${type}:`, error);
                    showModal('‚ùå', 'Error', `Failed to load ${type} data.`);
                    checkbox.checked = false;
                }
            } else if (checkbox.checked) {
                // Show existing markers
                markers.filter(m => m.type === type).forEach(m => m.marker.setMap(map));
            } else {
                // Hide markers
                markers.filter(m => m.type === type).forEach(m => m.marker.setMap(null));
            }
        }
        
        function displayMegalithic(type) {
            const colors = {
                'standing-stones': '#4FC3F7',
                'burials': '#9C27B0',
                'rock-art': '#E91E63',
                'settlements': '#673AB7'
            };
            
            megalithData[type].forEach(site => {
                if (!site.lat || !site.lng) return;
                
                const marker = new google.maps.Marker({
                    position: { lat: parseFloat(site.lat), lng: parseFloat(site.lng) },
                    map,
                    icon: {
                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                        scale: 5,
                        fillColor: colors[type],
                        fillOpacity: 0.9,
                        strokeColor: '#fff',
                        strokeWeight: 1.5,
                        rotation: 0
                    },
                    title: site.name || type,
                    zIndex: 50
                });
                
                marker.addListener('click', () => {
                    showSiteInfo(site, type);
                });
                
                markers.push({ marker, type, data: site });
            });
        }
        
        function applyFilters() {
            const pyramidsChecked = document.getElementById('layer-pyramids').checked;
            
            markers.filter(m => m.type === 'pyramid').forEach(m => {
                m.marker.setMap(pyramidsChecked ? map : null);
            });
        }
        
        function clearMarkers() {
            markers.forEach(m => m.marker.setMap(null));
            markers = [];
            if (markerCluster) {
                markerCluster.clearMarkers();
            }
        }
        
        function showSiteInfo(site, type) {
            let content = `
                <div style="padding:15px;max-width:300px;">
                    <h3 style="color:#FFD700;margin-bottom:10px;font-size:18px;">${site.name || 'Unknown Site'}</h3>
                    <p style="color:#4FC3F7;margin-bottom:8px;"><strong>Type:</strong> ${type}</p>
                    <p style="margin-bottom:8px;"><strong>Location:</strong> ${site.location || 'Unknown'}</p>
                    <p style="margin-bottom:8px;"><strong>Coordinates:</strong><br>${site.lat}, ${site.lng}</p>
                    ${site.description ? `<p style="margin-top:10px;font-size:13px;line-height:1.4;">${site.description}</p>` : ''}
                    <div style="margin-top:15px;display:flex;gap:10px;">
                        <button onclick="zoomToSite(${site.lat}, ${site.lng})" style="padding:8px 12px;background:#FFD700;color:#1a0033;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Zoom Here</button>
                        <button onclick="addToFavorites('${site.name}', ${site.lat}, ${site.lng})" style="padding:8px 12px;background:#9C27B0;color:#fff;border:none;border-radius:6px;cursor:pointer;">‚≠ê Save</button>
                    </div>
                </div>
            `;
            
            infoWindow.setContent(content);
            infoWindow.setPosition({ lat: parseFloat(site.lat), lng: parseFloat(site.lng) });
            infoWindow.open(map);
        }
        
        function zoomToSite(lat, lng) {
            map.setCenter({ lat, lng });
            map.setZoom(12);
            infoWindow.close();
        }
        
        function addToFavorites(name, lat, lng) {
            // Add to favorites array
            favorites.push({ name, lat, lng });
            
            // Update user stats
            if (currentUser) {
                currentUser.stats.favorites = favorites.length;
                localStorage.setItem('pyramason_user', JSON.stringify(currentUser));
                updateUserInterface();
            }
            
            showModal('‚≠ê', 'Added to Favorites!', `${name} has been saved to your favorites.`);
        }
        
        // ==================================================================
        // SEARCH FUNCTIONALITY
        // ==================================================================
        
        function searchSite() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!query) {
                showModal('üîç', 'Search', 'Please enter a search term.');
                return;
            }
            
            // Search in all data
            const allSites = [
                ...pyramidData.map(p => ({...p, type: 'pyramid'})),
                ...megalithData['standing-stones'].map(s => ({...s, type: 'standing-stones'})),
                ...megalithData['burials'].map(s => ({...s, type: 'burials'})),
                ...megalithData['rock-art'].map(s => ({...s, type: 'rock-art'})),
                ...megalithData['settlements'].map(s => ({...s, type: 'settlements'}))
            ];
            
            const results = allSites.filter(site => 
                (site.name && site.name.toLowerCase().includes(query)) ||
                (site.location && site.location.toLowerCase().includes(query))
            );
            
            if (results.length === 0) {
                showModal('üîç', 'No Results', `No sites found matching "${query}".`);
            } else if (results.length === 1) {
                const site = results[0];
                map.setCenter({ lat: parseFloat(site.lat), lng: parseFloat(site.lng) });
                map.setZoom(12);
                showSiteInfo(site, site.type);
            } else {
                // Show results list
                let content = `<div style="max-height:400px;overflow-y:auto;">`;
                content += `<p style="margin-bottom:15px;">Found ${results.length} results:</p>`;
                results.forEach(site => {
                    content += `
                        <div style="padding:10px;background:rgba(255,255,255,0.05);margin-bottom:8px;border-radius:6px;cursor:pointer;" 
                             onclick="zoomToSite(${site.lat}, ${site.lng})">
                            <strong style="color:#FFD700;">${site.name || 'Unknown'}</strong><br>
                            <small style="color:#4FC3F7;">${site.location || ''}</small>
                        </div>
                    `;
                });
                content += `</div>`;
                showModal('üîç', 'Search Results', content);
            }
        }
        
        // Add Enter key listener to search input
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchSite();
                    }
                });
            }
        });
        
        // ==================================================================
        // PANEL TOGGLE FUNCTIONS
        // ==================================================================
        
        function toggleToolsPanel() {
            const panel = document.getElementById('toolsPanel');
            const accountPanel = document.getElementById('accountPanel');
            
            // Close account panel if open
            if (accountPanel.classList.contains('active')) {
                accountPanel.classList.remove('active');
            }
            
            panel.classList.toggle('active');
        }
        
        function toggleAccountPanel() {
            const panel = document.getElementById('accountPanel');
            const toolsPanel = document.getElementById('toolsPanel');
            
            // Close tools panel if open
            if (toolsPanel.classList.contains('active')) {
                toolsPanel.classList.remove('active');
            }
            
            panel.classList.toggle('active');
        }
        
        // ==================================================================
        // NATAL CHART FEATURE
        // ==================================================================
        
        function openNatalChart() {
            console.log('Opening natal chart...');
            document.getElementById('natalChartOverlay').classList.add('active');
            // Small delay to ensure canvas is rendered
            setTimeout(() => {
                drawNatalChart();
            }, 100);
        }
        
        function closeNatalChart() {
            document.getElementById('natalChartOverlay').classList.remove('active');
        }
        
        function drawNatalChart() {
            const canvas = document.getElementById('natalChartCanvas');
            if (!canvas) {
                console.error('Canvas element not found');
                return;
            }
            
            // Set canvas size to match container
            const container = canvas.parentElement;
            const size = Math.min(container.clientWidth, container.clientHeight, 500);
            canvas.width = size;
            canvas.height = size;
            
            console.log('Canvas size set to:', canvas.width, 'x', canvas.height);
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Could not get canvas context');
                return;
            }
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 40;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Calculate current zodiac positions
            const now = new Date();
            const zodiacPositions = calculateZodiacPositions(now);
            
            console.log('Drawing natal chart for date:', now);
            console.log('Zodiac positions:', zodiacPositions);
            
            // Draw outer circle
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Draw zodiac divisions (12 sections)
            const zodiacSigns = ['‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì'];
            const zodiacNames = ['Aries', 'Taurus', 'Gemini', 'Cancer', 'Leo', 'Virgo', 'Libra', 'Scorpio', 'Sagittarius', 'Capricorn', 'Aquarius', 'Pisces'];
            
            for (let i = 0; i < 12; i++) {
                const angle = (i * 30 - 90) * Math.PI / 180;
                const x1 = centerX + radius * Math.cos(angle);
                const y1 = centerY + radius * Math.sin(angle);
                const x2 = centerX + (radius - 20) * Math.cos(angle);
                const y2 = centerY + (radius - 20) * Math.sin(angle);
                
                // Draw division line
                ctx.strokeStyle = 'rgba(255, 215, 0, 0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x1, y1);
                ctx.stroke();
                
                // Draw zodiac symbol
                const symbolAngle = (i * 30 + 15 - 90) * Math.PI / 180;
                const symbolX = centerX + (radius - 30) * Math.cos(symbolAngle);
                const symbolY = centerY + (radius - 30) * Math.sin(symbolAngle);
                
                ctx.fillStyle = '#FFD700';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(zodiacSigns[i], symbolX, symbolY);
            }
            
            // Draw planets (current positions)
            const planets = [
                { name: 'Sun', symbol: '‚òâ', color: '#FFD700', position: zodiacPositions.sun },
                { name: 'Moon', symbol: '‚òΩ', color: '#C0C0C0', position: zodiacPositions.moon },
                { name: 'Mercury', symbol: '‚òø', color: '#FFA500', position: zodiacPositions.mercury },
                { name: 'Venus', symbol: '‚ôÄ', color: '#FF69B4', position: zodiacPositions.venus },
                { name: 'Mars', symbol: '‚ôÇ', color: '#FF4500', position: zodiacPositions.mars },
                { name: 'Jupiter', symbol: '‚ôÉ', color: '#4169E1', position: zodiacPositions.jupiter },
                { name: 'Saturn', symbol: '‚ôÑ', color: '#8B7355', position: zodiacPositions.saturn }
            ];
            
            planets.forEach((planet, index) => {
                const angle = (planet.position - 90) * Math.PI / 180;
                const planetRadius = radius - 60 - (index * 15);
                const x = centerX + planetRadius * Math.cos(angle);
                const y = centerY + planetRadius * Math.sin(angle);
                
                // Draw planet
                ctx.fillStyle = planet.color;
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(planet.symbol, x, y);
                
                // Draw connecting line
                ctx.strokeStyle = planet.color;
                ctx.lineWidth = 1;
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.setLineDash([]);
            });
            
            // Update zodiac info panel
            updateZodiacInfo(planets, zodiacNames);
        }
        
        function calculateZodiacPositions(date) {
            // Simplified astronomical calculations for zodiac positions
            // In production, use a proper ephemeris library like swiss-ephemeris
            
            const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
            const yearProgress = dayOfYear / 365;
            
            return {
                sun: (yearProgress * 360) % 360,
                moon: ((yearProgress * 360 * 13) % 360),
                mercury: ((yearProgress * 360 * 3.8) % 360),
                venus: ((yearProgress * 360 * 1.6) % 360),
                mars: ((yearProgress * 360 * 0.5) % 360),
                jupiter: ((yearProgress * 360 * 0.08) % 360),
                saturn: ((yearProgress * 360 * 0.03) % 360)
            };
        }
        
        function updateZodiacInfo(planets, zodiacNames) {
            const zodiacInfo = document.getElementById('zodiacInfo');
            let html = '<h4 style="color:#FFD700;margin-bottom:15px;text-align:center;">Current Planetary Positions</h4>';
            
            planets.forEach(planet => {
                const zodiacIndex = Math.floor(planet.position / 30);
                const zodiacName = zodiacNames[zodiacIndex];
                const degrees = (planet.position % 30).toFixed(1);
                
                html += `
                    <div class="zodiac-row">
                        <span class="zodiac-label">${planet.symbol} ${planet.name}</span>
                        <span class="zodiac-value">${zodiacName} ${degrees}¬∞</span>
                    </div>
                `;
            });
            
            zodiacInfo.innerHTML = html;
        }
        
        // ==================================================================
        // SACRED GEOMETRY ANALYSIS
        // ==================================================================
        
        function analyzeSacredGeometry(type) {
            toggleToolsPanel();
            
            switch(type) {
                case 'golden-ratio':
                    detectGoldenRatio();
                    break;
                case 'fibonacci':
                    drawFibonacciSpiral();
                    break;
                case 'vesica-piscis':
                    detectVesicaPiscis();
                    break;
                case 'flower-of-life':
                    drawFlowerOfLife();
                    break;
                case 'platonic-solids':
                    showPlatonicGrid();
                    break;
                case 'metatron':
                    drawMetatronsCube();
                    break;
            }
        }
        
        function detectGoldenRatio() {
            showModal('œÜ', 'Golden Ratio Detector', 
                'Select two sites to analyze their distance relationship for golden ratio (1.618) patterns.');
            
            // Implementation would analyze distances between sites
            // This is a placeholder for the full implementation
        }
        
        function drawFibonacciSpiral() {
            // Clear previous drawings
            clearSacredGeometryOverlays();
            
            const center = map.getCenter();
            const zoom = map.getZoom();
            
            // Calculate appropriate radius based on zoom
            const radiusKm = 1000 / Math.pow(2, zoom - 3);
            
            // Draw Fibonacci spiral using circles
            const fibSequence = [1, 1, 2, 3, 5, 8, 13, 21];
            const colors = ['#FFD700', '#FF8C00', '#FF4500', '#DC143C', '#9400D3', '#4169E1', '#00CED1', '#00FF00'];
            
            fibSequence.forEach((fib, i) => {
                const circle = new google.maps.Circle({
                    strokeColor: colors[i],
                    strokeOpacity: 0.6,
                    strokeWeight: 2,
                    fillOpacity: 0,
                    map,
                    center: center,
                    radius: fib * radiusKm * 1000
                });
                
                geometryOverlays.push(circle);
            });
            
            showModal('üåÄ', 'Fibonacci Spiral', 
                'Fibonacci spiral overlay displayed. Each circle represents a Fibonacci number scaled to the current zoom level.');
        }
        
        function detectVesicaPiscis() {
            clearSacredGeometryOverlays();
            
            const center = map.getCenter();
            const zoom = map.getZoom();
            const radiusKm = 200 / Math.pow(2, zoom - 5);
            
            // Draw two overlapping circles (Vesica Piscis)
            const offset = radiusKm * 0.6;
            
            const circle1 = new google.maps.Circle({
                strokeColor: '#00BCD4',
                strokeOpacity: 0.7,
                strokeWeight: 3,
                fillColor: '#00BCD4',
                fillOpacity: 0.1,
                map,
                center: { lat: center.lat(), lng: center.lng() - offset / 111 },
                radius: radiusKm * 1000
            });
            
            const circle2 = new google.maps.Circle({
                strokeColor: '#9C27B0',
                strokeOpacity: 0.7,
                strokeWeight: 3,
                fillColor: '#9C27B0',
                fillOpacity: 0.1,
                map,
                center: { lat: center.lat(), lng: center.lng() + offset / 111 },
                radius: radiusKm * 1000
            });
            
            geometryOverlays.push(circle1, circle2);
            
            showModal('‚óØ‚óØ', 'Vesica Piscis', 
                'Vesica Piscis pattern displayed. The overlapping circles represent this sacred geometric form found in ancient architecture.');
        }
        
        function drawFlowerOfLife() {
            clearSacredGeometryOverlays();
            
            const center = map.getCenter();
            const zoom = map.getZoom();
            const radiusKm = 100 / Math.pow(2, zoom - 6);
            
            // Draw central circle
            const centralCircle = new google.maps.Circle({
                strokeColor: '#FFD700',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillOpacity: 0,
                map,
                center: center,
                radius: radiusKm * 1000
            });
            
            geometryOverlays.push(centralCircle);
            
            // Draw 6 surrounding circles (Flower of Life pattern)
            for (let i = 0; i < 6; i++) {
                const angle = (i * 60) * Math.PI / 180;
                const offsetLat = radiusKm * Math.sin(angle) / 111;
                const offsetLng = radiusKm * Math.cos(angle) / (111 * Math.cos(center.lat() * Math.PI / 180));
                
                const circle = new google.maps.Circle({
                    strokeColor: '#FFD700',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillOpacity: 0,
                    map,
                    center: { lat: center.lat() + offsetLat, lng: center.lng() + offsetLng },
                    radius: radiusKm * 1000
                });
                
                geometryOverlays.push(circle);
            }
            
            showModal('‚úø', 'Flower of Life', 
                'Flower of Life pattern displayed. This ancient geometric pattern consists of evenly-spaced, overlapping circles.');
        }
        
        function showPlatonicGrid() {
            clearSacredGeometryOverlays();
            
            // Draw icosahedron/dodecahedron earth grid
            // This is a simplified representation - full implementation would use proper geodesic calculations
            
            const gridLines = [
                { lat1: 52.6, lng1: -1.8, lat2: 30, lng2: 31 },  // UK to Egypt
                { lat1: 30, lng1: 31, lat2: 19.4, lng2: -99.1 }, // Egypt to Mexico
                { lat1: 19.4, lng1: -99.1, lat2: -14.7, lng2: -75.1 }, // Mexico to Peru
                // Add more grid lines for full icosahedron
            ];
            
            gridLines.forEach(line => {
                const polyline = new google.maps.Polyline({
                    path: [
                        { lat: line.lat1, lng: line.lng1 },
                        { lat: line.lat2, lng: line.lng2 }
                    ],
                    strokeColor: '#4CAF50',
                    strokeOpacity: 0.6,
                    strokeWeight: 2,
                    geodesic: true,
                    map
                });
                
                geometryOverlays.push(polyline);
            });
            
            showModal('‚¨¢', 'Platonic Solids Grid', 
                'Earth grid based on Platonic solids geometry displayed. These lines represent the theoretical icosahedral/dodecahedral grid of Earth energy lines.');
        }
        
        function drawMetatronsCube() {
            clearSacredGeometryOverlays();
            
            const center = map.getCenter();
            const zoom = map.getZoom();
            const radiusKm = 150 / Math.pow(2, zoom - 5);
            
            // Draw circles for Metatron's Cube pattern
            const positions = [
                { lat: 0, lng: 0 },  // Center
                { lat: radiusKm/111, lng: 0 },  // Top
                { lat: -radiusKm/111, lng: 0 }, // Bottom
                { lat: 0, lng: radiusKm/111 },  // Right
                { lat: 0, lng: -radiusKm/111 }, // Left
                { lat: radiusKm/157, lng: radiusKm/157 },   // Top-right
                { lat: radiusKm/157, lng: -radiusKm/157 },  // Top-left
                { lat: -radiusKm/157, lng: radiusKm/157 },  // Bottom-right
                { lat: -radiusKm/157, lng: -radiusKm/157 }, // Bottom-left
            ];
            
            positions.forEach(pos => {
                const circle = new google.maps.Circle({
                    strokeColor: '#9C27B0',
                    strokeOpacity: 0.7,
                    strokeWeight: 2,
                    fillColor: '#9C27B0',
                    fillOpacity: 0.1,
                    map,
                    center: { lat: center.lat() + pos.lat, lng: center.lng() + pos.lng },
                    radius: (radiusKm / 3) * 1000
                });
                
                geometryOverlays.push(circle);
            });
            
            showModal('üîØ', "Metatron's Cube", 
                "Metatron's Cube pattern displayed. This sacred geometric figure contains all five Platonic solids.");
        }
        
        function clearSacredGeometryOverlays() {
            geometryOverlays.forEach(overlay => overlay.setMap(null));
            geometryOverlays = [];
        }
        
        function detectSacredGeometry(type) {
            clearSacredGeometryOverlays();
            
            const checkbox = document.getElementById(`sacred-${type}`);
            
            if (!checkbox.checked) return;
            
            switch(type) {
                case 'triangles':
                    detectTriangles();
                    break;
                case 'circles':
                    detectCircles();
                    break;
                case 'alignments':
                    detectAlignments();
                    break;
            }
        }
        
        function detectTriangles() {
            // Find sites that form equilateral or special angle triangles
            showModal('‚ñ≥', 'Triangle Detection', 
                'Analyzing visible sites for geometric triangle patterns...');
            
            // Placeholder - would analyze site positions for triangular patterns
        }
        
        function detectCircles() {
            // Find sites that form circular patterns
            showModal('‚óã', 'Circle Detection', 
                'Analyzing visible sites for circular patterns and equidistant formations...');
        }
        
        function detectAlignments() {
            // Find sites in straight lines
            showModal('‚Äî', 'Alignment Detection', 
                'Analyzing visible sites for linear alignments and ley lines...');
        }
        
        // ==================================================================
        // ASTRONOMICAL ANALYSIS
        // ==================================================================
        
        function analyzeAstronomy(type) {
            toggleToolsPanel();
            
            switch(type) {
                case 'solstice':
                    analyzeSolsticeAlignments();
                    break;
                case 'equinox':
                    analyzeEquinoxAlignments();
                    break;
                case 'stars':
                    analyzeStarAlignments();
                    break;
                case 'precession':
                    analyzePrecession();
                    break;
            }
        }
        
        function analyzeSolsticeAlignments() {
            showModal('‚òÄÔ∏è', 'Solstice Analysis', 
                'Analyzing sites for summer and winter solstice sunrise/sunset alignments. ' +
                'This tool checks if ancient structures align with solstice sun positions.');
        }
        
        function analyzeEquinoxAlignments() {
            showModal('‚öñÔ∏è', 'Equinox Analysis', 
                'Analyzing sites for spring and autumn equinox alignments. ' +
                'These dates mark the astronomical balance points when day equals night.');
        }
        
        function analyzeStarAlignments() {
            showModal('‚≠ê', 'Star Alignment Analysis', 
                'Checking alignments with major stars and constellations:\n\n' +
                '‚Ä¢ Orion Belt (Alnitak, Alnilam, Mintaka)\n' +
                '‚Ä¢ Sirius (brightest star)\n' +
                '‚Ä¢ Pleiades cluster\n' +
                '‚Ä¢ Other significant stars\n\n' +
                'Many ancient structures show remarkable correlations with these celestial markers.');
        }
        
        function analyzePrecession() {
            showModal('üåå', 'Precession Calculator', 
                'The precession of the equinoxes causes Earth\'s axis to wobble over a 25,920-year cycle. ' +
                'This tool calculates how star alignments would have appeared in different epochs, ' +
                'helping to date ancient structures based on their astronomical orientations.');
        }
        
        // ==================================================================
        // MEASUREMENT TOOLS
        // ==================================================================
        
        function startMeasurement(type) {
            toggleToolsPanel();
            
            measurementMode = type;
            measurementPoints = [];
            
            if (measurementPolyline) {
                measurementPolyline.setMap(null);
                measurementPolyline = null;
            }
            
            showModal('üìè', 'Measurement Mode', 
                `Click on the map to ${type === 'distance' ? 'measure distance between points' : 
                type === 'area' ? 'define an area to measure' : 
                'calculate bearing/azimuth'}.`);
            
            // Add click listener to map
            const listener = map.addListener('click', (e) => {
                handleMeasurementClick(e.latLng, type, listener);
            });
        }
        
        function handleMeasurementClick(latLng, type, listener) {
            measurementPoints.push(latLng);
            
            // Add marker at click point
            const marker = new google.maps.Marker({
                position: latLng,
                map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 6,
                    fillColor: '#FF5722',
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 2
                }
            });
            
            drawings.push(marker);
            
            if (type === 'distance' && measurementPoints.length === 2) {
                // Calculate distance
                const distance = google.maps.geometry.spherical.computeDistanceBetween(
                    measurementPoints[0],
                    measurementPoints[1]
                );
                
                // Draw line
                const line = new google.maps.Polyline({
                    path: measurementPoints,
                    strokeColor: '#FF5722',
                    strokeWeight: 3,
                    geodesic: true,
                    map
                });
                
                drawings.push(line);
                
                // Show result
                const km = (distance / 1000).toFixed(2);
                const miles = (distance / 1609.34).toFixed(2);
                
                showModal('üìè', 'Distance Measured', 
                    `<strong>Distance:</strong><br>` +
                    `${km} kilometers<br>` +
                    `${miles} miles<br>` +
                    `${distance.toFixed(0)} meters`);
                
                // Clean up
                google.maps.event.removeListener(listener);
                measurementMode = null;
                measurementPoints = [];
                
            } else if (type === 'bearing' && measurementPoints.length === 2) {
                // Calculate bearing
                const bearing = google.maps.geometry.spherical.computeHeading(
                    measurementPoints[0],
                    measurementPoints[1]
                );
                
                // Draw line
                const line = new google.maps.Polyline({
                    path: measurementPoints,
                    strokeColor: '#2196F3',
                    strokeWeight: 3,
                    geodesic: true,
                    map
                });
                
                drawings.push(line);
                
                // Show result
                const normalizedBearing = bearing < 0 ? bearing + 360 : bearing;
                const direction = getDirection(normalizedBearing);
                
                showModal('üß≠', 'Bearing Calculated', 
                    `<strong>Bearing/Azimuth:</strong><br>` +
                    `${normalizedBearing.toFixed(2)}¬∞<br>` +
                    `Direction: ${direction}`);
                
                // Clean up
                google.maps.event.removeListener(listener);
                measurementMode = null;
                measurementPoints = [];
                
            } else if (type === 'area' && measurementPoints.length >= 3) {
                // Draw polygon
                const polygon = new google.maps.Polygon({
                    paths: measurementPoints,
                    strokeColor: '#4CAF50',
                    strokeWeight: 2,
                    fillColor: '#4CAF50',
                    fillOpacity: 0.2,
                    map
                });
                
                drawings.push(polygon);
                
                // Calculate area
                const area = google.maps.geometry.spherical.computeArea(measurementPoints);
                const km2 = (area / 1000000).toFixed(2);
                const miles2 = (area / 2589988.11).toFixed(2);
                
                showModal('‚ñ≠', 'Area Calculated', 
                    `<strong>Area:</strong><br>` +
                    `${km2} square kilometers<br>` +
                    `${miles2} square miles<br>` +
                    `${area.toFixed(0)} square meters<br><br>` +
                    `Click again to add more points, or close this to finish.`);
            }
        }
        
        function getDirection(bearing) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(bearing / 22.5) % 16;
            return directions[index];
        }
        
        function findAntipode() {
            const center = map.getCenter();
            findAntipodeFromLatLng(center);
            toggleToolsPanel();
        }
        
        function findAntipodeFromContext() {
            if (contextMenuLatLng) {
                findAntipodeFromLatLng(contextMenuLatLng);
                closeContextMenu();
            }
        }
        
        function findAntipodeFromLatLng(latLng) {
            const sourceLat = latLng.lat();
            const sourceLng = latLng.lng();
            
            // Calculate antipode
            const antipodeLat = -sourceLat;
            let antipodeLng = sourceLng + 180;
            if (antipodeLng > 180) antipodeLng -= 360;
            if (antipodeLng < -180) antipodeLng += 360;
            
            // Create marker at antipode
            const antipodeMarker = new google.maps.Marker({
                position: { lat: antipodeLat, lng: antipodeLng },
                map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#FF5722',
                    fillOpacity: 0.9,
                    strokeColor: '#fff',
                    strokeWeight: 3
                },
                title: 'Antipode Point',
                animation: google.maps.Animation.DROP
            });
            
            // Draw line through Earth's center
            const line = new google.maps.Polyline({
                path: [
                    { lat: sourceLat, lng: sourceLng },
                    { lat: antipodeLat, lng: antipodeLng }
                ],
                strokeColor: '#FF5722',
                strokeWeight: 3,
                strokeOpacity: 0.7,
                geodesic: true,
                map
            });
            
            drawings.push(line, antipodeMarker);
            
            // Pan to show both points
            const bounds = new google.maps.LatLngBounds();
            bounds.extend({ lat: sourceLat, lng: sourceLng });
            bounds.extend({ lat: antipodeLat, lng: antipodeLng });
            map.fitBounds(bounds);
            
            showModal('üåç', 'Antipode Found!', 
                `<strong>Opposite point on Earth:</strong><br><br>` +
                `Source: ${sourceLat.toFixed(5)}¬∞, ${sourceLng.toFixed(5)}¬∞<br>` +
                `Antipode: ${antipodeLat.toFixed(5)}¬∞, ${antipodeLng.toFixed(5)}¬∞<br><br>` +
                `<small>These points are directly opposite through Earth's center (12,742 km apart)</small>`);
        }
        
        function distanceRings() {
            toggleToolsPanel();
            
            const center = map.getCenter();
            const distances = [100, 250, 500, 1000, 2500, 5000]; // km
            const colors = ['#FFD700', '#FF8C00', '#FF4500', '#DC143C', '#9400D3', '#4169E1'];
            
            clearSacredGeometryOverlays();
            
            distances.forEach((dist, i) => {
                const circle = new google.maps.Circle({
                    strokeColor: colors[i],
                    strokeOpacity: 0.6,
                    strokeWeight: 2,
                    fillOpacity: 0,
                    map,
                    center: center,
                    radius: dist * 1000
                });
                
                geometryOverlays.push(circle);
            });
            
            showModal('‚≠ï', 'Distance Rings', 
                'Concentric distance rings displayed from map center: 100km, 250km, 500km, 1000km, 2500km, 5000km');
        }
        
        // ==================================================================
        // DRAWING TOOLS
        // ==================================================================
        
        function startDrawing(type) {
            toggleToolsPanel();
            
            showModal('‚úèÔ∏è', 'Drawing Mode', 
                `Click on the map to ${type === 'line' ? 'draw a line' : 
                type === 'circle' ? 'set circle center, then radius' : 
                'draw a polygon (click multiple times)'}.`);
            
            // Implementation for drawing tools
        }
        
        function clearAllDrawings() {
            drawings.forEach(item => item.setMap(null));
            drawings = [];
            geometryOverlays.forEach(overlay => overlay.setMap(null));
            geometryOverlays = [];
            
            showModal('üóëÔ∏è', 'Cleared', 'All drawings and overlays have been cleared.');
        }
        
        // ==================================================================
        // EARTH GRID & LEY LINES
        // ==================================================================
        
        function showEarthGrid() {
            toggleToolsPanel();
            
            if (earthGridLayer) {
                earthGridLayer.setMap(null);
                earthGridLayer = null;
                showModal('üï∏Ô∏è', 'Earth Grid', 'Earth grid overlay removed.');
                return;
            }
            
            // Draw simplified earth grid (ley lines)
            const gridLines = [
                // Major ley lines (simplified example)
                { lat1: 51.1789, lng1: -1.8262, lat2: 30.0, lng2: 31.0 }, // Stonehenge to Giza
                { lat1: 30.0, lng1: 31.0, lat2: 19.4, lng2: -99.1 },      // Giza to Teotihuacan
                { lat1: 19.4, lng1: -99.1, lat2: -13.2, lng2: -72.5 },     // Teotihuacan to Machu Picchu
                { lat1: -13.2, lng1: -72.5, lat2: 27.175, lng2: 78.042 },  // Machu Picchu to Taj Mahal
                { lat1: 27.175, lng1: 78.042, lat2: 29.975, lng2: 31.136 }, // Taj Mahal to Giza
            ];
            
            gridLines.forEach(line => {
                const polyline = new google.maps.Polyline({
                    path: [
                        { lat: line.lat1, lng: line.lng1 },
                        { lat: line.lat2, lng: line.lng2 }
                    ],
                    strokeColor: '#00FF00',
                    strokeOpacity: 0.5,
                    strokeWeight: 2,
                    geodesic: true,
                    map
                });
                
                geometryOverlays.push(polyline);
            });
            
            showModal('üï∏Ô∏è', 'Earth Grid Overlay', 
                'Displaying major ley lines connecting significant ancient sites. ' +
                'These alignments have been noted by researchers studying ancient monument placement.');
        }
        
        function detectLeyLines() {
            toggleToolsPanel();
            
            showModal('üì°', 'Ley Line Detector', 
                'Analyzing visible sites for linear alignments...\n\n' +
                'Ley lines are hypothetical alignments of ancient sites. ' +
                'This tool identifies when three or more sites form straight lines within a tolerance threshold.');
        }
        
        function playFrequency() {
            toggleToolsPanel();
            
            showModal('üîä', 'Sacred Audio Frequencies', 
                'Different types of ancient sites are believed to resonate at specific frequencies:\n\n' +
                '‚Ä¢ Pyramids: 432 Hz (Earth tone)\n' +
                '‚Ä¢ Stone Circles: 528 Hz (Healing frequency)\n' +
                '‚Ä¢ Temples: 396 Hz (Liberation)\n' +
                '‚Ä¢ Burial Mounds: 174 Hz (Foundation)\n\n' +
                'Select a site to play its frequency.');
        }
        
        // ==================================================================
        // EXPORT & ACADEMIC TOOLS
        // ==================================================================
        
        function generateCitation() {
            toggleToolsPanel();
            
            const currentDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const citations = {
                apa: `Pyramason Research Platform. (${new Date().getFullYear()}). Ancient Sites Interactive Map. Retrieved ${currentDate}, from https://pyramason.com/ancient-map`,
                
                mla: `"Ancient Sites Interactive Map." Pyramason Research Platform, ${new Date().getFullYear()}, pyramason.com/ancient-map. Accessed ${currentDate}.`,
                
                chicago: `Pyramason Research Platform. "Ancient Sites Interactive Map." Last modified ${new Date().getFullYear()}. https://pyramason.com/ancient-map.`,
                
                harvard: `Pyramason Research Platform (${new Date().getFullYear()}) Ancient Sites Interactive Map. Available at: https://pyramason.com/ancient-map (Accessed: ${currentDate}).`,
                
                bibtex: `@misc{pyramason${new Date().getFullYear()},
  author = {{Pyramason Research Platform}},
  title = {Ancient Sites Interactive Map},
  year = {${new Date().getFullYear()}},
  url = {https://pyramason.com/ancient-map},
  note = {Accessed: ${currentDate}}
}`
            };
            
            let content = '<div style="text-align:left;max-height:400px;overflow-y:auto;">';
            
            Object.keys(citations).forEach(style => {
                content += `<div style="margin-bottom:25px;">`;
                content += `<strong style="color:#FFD700;font-size:14px;">${style.toUpperCase()}</strong><br>`;
                content += `<div style="font-size:13px;font-family:'Courier New',monospace;background:rgba(0,0,0,0.3);padding:15px;margin-top:8px;border-radius:8px;border:1px solid rgba(255,215,0,0.2);white-space:pre-wrap;line-height:1.6;">${citations[style]}</div>`;
                content += `</div>`;
            });
            
            content += '</div>';
            
            showModal('üìö', 'Academic Citations', content);
        }
        
        function exportData(format) {
            toggleToolsPanel();
            
            showModal('üìä', 'Export Data', 
                `Preparing ${format.toUpperCase()} export...\n\n` +
                `This will export all visible sites in ${format.toUpperCase()} format for use in GIS software, spreadsheet applications, or Google Earth.`);
            
            // Implementation would generate and download the file
        }
        
        function generateReport() {
            toggleToolsPanel();
            
            showModal('üìÑ', 'PDF Report Generator', 
                'Generate a comprehensive research report including:\n\n' +
                '‚Ä¢ Map snapshot\n' +
                '‚Ä¢ Site statistics\n' +
                '‚Ä¢ Sacred geometry analysis\n' +
                '‚Ä¢ Astronomical alignments\n' +
                '‚Ä¢ Distance measurements\n' +
                '‚Ä¢ Academic citations\n\n' +
                'Premium feature - Upgrade to generate PDF reports.');
        }
        
        // ==================================================================
        // ADVANCED RESEARCH TOOLS
        // ==================================================================
        
        function batchAnalyzer() {
            toggleToolsPanel();
            showModal('üìä', 'Batch Analyzer', 
                'Select multiple sites to analyze their relationships:\n\n' +
                '‚Ä¢ Distance matrix\n' +
                '‚Ä¢ Geometric patterns\n' +
                '‚Ä¢ Statistical analysis\n' +
                '‚Ä¢ Alignment detection');
        }
        
        function comparisonTool() {
            toggleToolsPanel();
            showModal('‚öñÔ∏è', 'Site Comparison Tool', 
                'Compare two or more sites side-by-side:\n\n' +
                '‚Ä¢ Physical characteristics\n' +
                '‚Ä¢ Geographic data\n' +
                '‚Ä¢ Historical periods\n' +
                '‚Ä¢ Astronomical alignments');
        }
        
        function statisticsDashboard() {
            toggleToolsPanel();
            
            const totalPyramids = pyramidData.length;
            const totalMegaliths = Object.values(megalithData).reduce((sum, arr) => sum + arr.length, 0);
            
            showModal('üìà', 'Statistics Dashboard', 
                `<div style="text-align:left;">
                    <strong style="color:#FFD700;">Global Site Statistics:</strong><br><br>
                    Total Pyramids: ${totalPyramids}<br>
                    Total Megalithic Sites: ${totalMegaliths}<br>
                    Total Sites: ${totalPyramids + totalMegaliths}<br><br>
                    <strong>Regional Distribution:</strong><br>
                    ‚Ä¢ Americas: 35%<br>
                    ‚Ä¢ Europe: 25%<br>
                    ‚Ä¢ Asia: 20%<br>
                    ‚Ä¢ Africa: 15%<br>
                    ‚Ä¢ Oceania: 5%<br>
                </div>`);
        }
        
        function routePlanner() {
            toggleToolsPanel();
            showModal('üõ§Ô∏è', 'Route Planner', 
                'Create ancient pilgrimage routes:\n\n' +
                '‚Ä¢ Connect multiple sites\n' +
                '‚Ä¢ Calculate total distance\n' +
                '‚Ä¢ Optimize route order\n' +
                '‚Ä¢ Export as KML for GPS');
        }
        
        function timelineSlider() {
            toggleToolsPanel();
            showModal('‚è≥', 'Timeline Slider', 
                'Filter sites by historical period:\n\n' +
                '‚Ä¢ 10,000 BCE - 5,000 BCE (Neolithic)\n' +
                '‚Ä¢ 5,000 BCE - 3,000 BCE (Bronze Age begins)\n' +
                '‚Ä¢ 3,000 BCE - 1,000 BCE (Ancient civilizations)\n' +
                '‚Ä¢ 1,000 BCE - 500 CE (Classical period)\n' +
                '‚Ä¢ 500 CE - Present (Medieval to Modern)');
        }
        
        function toggleHeatmap() {
            toggleToolsPanel();
            
            if (heatmapLayer) {
                heatmapLayer.setMap(null);
                heatmapLayer = null;
                showModal('üî•', 'Heatmap', 'Heatmap mode disabled.');
                return;
            }
            
            // Create heatmap data
            const heatmapData = markers
                .filter(m => m.marker.getMap())
                .map(m => m.marker.getPosition());
            
            // Create heatmap layer
            heatmapLayer = new google.maps.visualization.HeatmapLayer({
                data: heatmapData,
                map: map,
                radius: 30,
                opacity: 0.6
            });
            
            showModal('üî•', 'Heatmap Mode', 
                'Heatmap visualization enabled. Density of ancient sites is now shown in color gradient.');
        }
        
        function showPremiumInfo() {
            showModal('üíé', 'Premium Features', 
                '<div style="text-align:left;">' +
                '<strong style="color:#FFD700;">Upgrade to Premium:</strong><br><br>' +
                '‚ú® Unlimited site exports<br>' +
                '‚ú® AI-powered analysis<br>' +
                '‚ú® PDF report generation<br>' +
                '‚ú® Advanced sacred geometry tools<br>' +
                '‚ú® Priority support<br>' +
                '‚ú® Custom map themes<br>' +
                '‚ú® Save unlimited favorites<br><br>' +
                '<strong>¬£9.99/month or ¬£99/year</strong><br><br>' +
                '<small>Visit pyramason.com to upgrade</small>' +
                '</div>');
        }
        
        // ==================================================================
        // CONTEXT MENU
        // ==================================================================
        
        function setupContextMenu() {
            map.addListener('rightclick', (e) => {
                showContextMenu(e.latLng, e.pixel);
            });
            
            // Close context menu when clicking elsewhere
            map.addListener('click', closeContextMenu);
        }
        
        function showContextMenu(latLng, pixel) {
            contextMenuLatLng = latLng;
            
            const menu = document.getElementById('contextMenu');
            const coords = document.getElementById('contextCoords');
            
            coords.textContent = `${latLng.lat().toFixed(5)}, ${latLng.lng().toFixed(5)}`;
            
            menu.style.left = pixel.x + 'px';
            menu.style.top = pixel.y + 'px';
            menu.classList.add('active');
        }
        
        function closeContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
        }
        
        function copyCoordinates() {
            if (contextMenuLatLng) {
                const coordsText = `${contextMenuLatLng.lat().toFixed(5)}, ${contextMenuLatLng.lng().toFixed(5)}`;
                navigator.clipboard.writeText(coordsText).then(() => {
                    showModal('üìã', 'Copied!', 'Coordinates copied to clipboard.');
                });
            }
            closeContextMenu();
        }
        
        function addCustomMarker() {
            if (contextMenuLatLng) {
                const marker = new google.maps.Marker({
                    position: contextMenuLatLng,
                    map,
                    icon: {
                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                        scale: 6,
                        fillColor: '#FF69B4',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 2
                    },
                    title: 'Custom Marker'
                });
                
                drawings.push(marker);
                showModal('üìç', 'Marker Added', 'Custom marker placed on the map.');
            }
            closeContextMenu();
        }
        
        function detectGeometryAt() {
            if (contextMenuLatLng) {
                // Find nearby sites and analyze geometry
                showModal('‚ú®', 'Sacred Geometry Detection', 
                    'Analyzing nearby sites for geometric patterns...');
            }
            closeContextMenu();
        }
        
        function checkAstronomicalAlignment() {
            if (contextMenuLatLng) {
                showModal('‚≠ê', 'Astronomical Alignment', 
                    'Checking astronomical alignments for this location...\n\n' +
                    'Analyzing solstice, equinox, and major star alignments.');
            }
            closeContextMenu();
        }
        
        // ==================================================================
        // MAP CONTROLS
        // ==================================================================
        
        function toggleMapType() {
            if (currentMapType === 'roadmap') {
                map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
                currentMapType = 'satellite';
            } else {
                map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
                currentMapType = 'roadmap';
            }
        }
        
        function toggleLabels() {
            labelsEnabled = !labelsEnabled;
            const labelsBtn = document.getElementById('labelsBtn');
            
            if (labelsEnabled) {
                labelsBtn.classList.add('active');
                map.setOptions({
                    styles: [
                        {
                            featureType: 'water',
                            elementType: 'geometry',
                            stylers: [{ color: '#0e1626' }]
                        },
                        {
                            featureType: 'landscape',
                            elementType: 'geometry',
                            stylers: [{ color: '#1a1a2e' }]
                        }
                    ]
                });
            } else {
                labelsBtn.classList.remove('active');
                map.setOptions({
                    styles: [
                        {
                            featureType: 'water',
                            elementType: 'geometry',
                            stylers: [{ color: '#0e1626' }]
                        },
                        {
                            featureType: 'landscape',
                            elementType: 'geometry',
                            stylers: [{ color: '#1a1a2e' }]
                        },
                        {
                            featureType: 'all',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ]
                });
            }
        }
        
        function toggle3D() {
            terrain3D = !terrain3D;
            const btn3D = document.getElementById('3dBtn');
            
            if (terrain3D) {
                btn3D.classList.add('active');
                map.setTilt(45);
            } else {
                btn3D.classList.remove('active');
                map.setTilt(0);
            }
        }
        
        // ==================================================================
        // MODAL SYSTEM
        // ==================================================================
        
        function showModal(icon, title, message, primaryBtnText = 'OK', secondaryBtnText = null, onPrimary = null, onSecondary = null) {
            const overlay = document.getElementById('modalOverlay');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const primaryBtn = document.getElementById('modalPrimaryBtn');
            const secondaryBtn = document.getElementById('modalSecondaryBtn');
            
            modalIcon.textContent = icon;
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            primaryBtn.textContent = primaryBtnText;
            
            if (secondaryBtnText) {
                secondaryBtn.textContent = secondaryBtnText;
                secondaryBtn.style.display = 'block';
                secondaryBtn.onclick = () => {
                    closeModal();
                    if (onSecondary) onSecondary();
                };
            } else {
                secondaryBtn.style.display = 'none';
            }
            
            primaryBtn.onclick = () => {
                closeModal();
                if (onPrimary) onPrimary();
            };
            
            overlay.classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }
        
        // ==================================================================
        // INITIALIZATION
        // ==================================================================
        
        // Make initMap available globally for Google Maps callback
        window.initMap = initMap;
        
        // Check if user is already registered
        checkRegistration();
        
        // Load Google Maps API with proper async loading
        (function() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&callback=initMap&libraries=geometry,visualization&loading=async&v=weekly`;
            script.async = true;
            script.defer = true;
            script.onerror = function() {
                console.error('Failed to load Google Maps API');
                showModal('‚ùå', 'Map Loading Error', 
                    'Failed to load Google Maps. Please check your internet connection and API key.');
            };
            document.head.appendChild(script);
        })();
        
        // Load marker clustering library
        (function() {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js';
            script.async = true;
            script.onerror = function() {
                console.warn('Failed to load marker clustering library - clustering disabled');
            };
            document.head.appendChild(script);
        })();
        
    </script>
</body>
</html>
